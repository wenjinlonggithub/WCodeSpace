# Redis ä¸»ä»å¤åˆ¶å­¦ä¹ æŒ‡å— ğŸ”„

## ğŸ“š æ–‡ä»¶è¯´æ˜

æœ¬ç›®å½•åŒ…å«Redisä¸»ä»å¤åˆ¶çš„å®Œæ•´å­¦ä¹ èµ„æºï¼š

1. **SimpleReplicationDemo.java** â­ æ¨èæ–°æ‰‹
   - ç®€åŒ–ç‰ˆæ¼”ç¤º
   - ä»£ç ç®€æ´æ˜“æ‡‚
   - å¿«é€Ÿç†è§£æ ¸å¿ƒæ¦‚å¿µ

2. **RedisReplication.java**
   - å®Œæ•´å®ç°
   - æ¨¡æ‹ŸçœŸå®Redisè¡Œä¸º
   - åŒ…å«ç½‘ç»œé€šä¿¡

3. **RedisReplication_Explanation.md**
   - è¯¦ç»†åŸç†è§£æ
   - æµç¨‹å›¾å’Œç¤ºä¾‹
   - å¸¸è§é—®é¢˜è§£ç­”

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹å¼1ï¼šè¿è¡Œç®€åŒ–ç‰ˆï¼ˆæ¨èï¼‰

```bash
# ç¼–è¯‘
javac SimpleReplicationDemo.java

# è¿è¡Œ
java SimpleReplicationDemo
```

**ä½ ä¼šçœ‹åˆ°ï¼š**
```
======================================================================
          Redis ä¸»ä»å¤åˆ¶ - ç®€åŒ–æ¼”ç¤º
======================================================================

ã€æ­¥éª¤1ã€‘åˆ›å»ºä¸»èŠ‚ç‚¹
ğŸ”´ ä¸»èŠ‚ç‚¹å·²å¯åŠ¨
   Replication ID: master-a1b2c3d4

ã€æ­¥éª¤2ã€‘ä¸»èŠ‚ç‚¹å†™å…¥åˆå§‹æ•°æ®
ğŸ“ [ä¸»èŠ‚ç‚¹] SET name = Redis
   Offset: 1
...

ã€æ­¥éª¤3ã€‘ä»èŠ‚ç‚¹1è¿æ¥ - è§¦å‘å…¨é‡å¤åˆ¶
ğŸ”µ ä»èŠ‚ç‚¹ [Slave-1] å·²å¯åŠ¨
ğŸ”Œ [Slave-1] è¿æ¥åˆ°ä¸»èŠ‚ç‚¹...
ğŸ”„ [ä¸»èŠ‚ç‚¹] æ‰§è¡Œå…¨é‡å¤åˆ¶
âœ… [ä¸»èŠ‚ç‚¹] å…¨é‡å¤åˆ¶å®Œæˆ
...
```

### æ–¹å¼2ï¼šè¿è¡Œå®Œæ•´ç‰ˆ

```bash
# ç¼–è¯‘
javac RedisReplication.java

# è¿è¡Œ
java RedisReplication
```

**ä½ ä¼šçœ‹åˆ°ï¼š**
- çœŸå®çš„TCPè¿æ¥
- PSYNCå‘½ä»¤äº¤äº’
- RDBæ–‡ä»¶ç”Ÿæˆå’Œä¼ è¾“
- å‘½ä»¤ä¼ æ’­è¿‡ç¨‹

## ğŸ“– å­¦ä¹ è·¯å¾„

### ç¬¬1æ­¥ï¼šç†è§£æ ¸å¿ƒæ¦‚å¿µï¼ˆ10åˆ†é’Ÿï¼‰

é˜…è¯» `RedisReplication_Explanation.md` çš„å‰3ç« ï¼š
1. ä»€ä¹ˆæ˜¯ä¸»ä»å¤åˆ¶
2. æ ¸å¿ƒæ¦‚å¿µï¼ˆReplication ID, Offset, Backlogï¼‰
3. å…¨é‡å¤åˆ¶æµç¨‹

### ç¬¬2æ­¥ï¼šè¿è¡Œç®€åŒ–ç‰ˆï¼ˆ5åˆ†é’Ÿï¼‰

```bash
java SimpleReplicationDemo
```

è§‚å¯Ÿè¾“å‡ºï¼Œç†è§£ï¼š
- å…¨é‡å¤åˆ¶ä»€ä¹ˆæ—¶å€™å‘ç”Ÿ
- å¢é‡å¤åˆ¶ä»€ä¹ˆæ—¶å€™å‘ç”Ÿ
- å‘½ä»¤æ˜¯å¦‚ä½•ä¼ æ’­çš„
- Offsetå¦‚ä½•å˜åŒ–

### ç¬¬3æ­¥ï¼šé˜…è¯»ç®€åŒ–ç‰ˆä»£ç ï¼ˆ20åˆ†é’Ÿï¼‰

é‡ç‚¹å…³æ³¨ï¼š
- `SimpleMaster.set()` - ä¸»èŠ‚ç‚¹å¦‚ä½•å¤„ç†å†™å‘½ä»¤
- `SimpleMaster.handlePsync()` - å¦‚ä½•åˆ¤æ–­å…¨é‡/å¢é‡å¤åˆ¶
- `SimpleSlave.receiveCommand()` - ä»èŠ‚ç‚¹å¦‚ä½•æ‰§è¡Œå‘½ä»¤

### ç¬¬4æ­¥ï¼šæ·±å…¥ç†è§£åŸç†ï¼ˆ30åˆ†é’Ÿï¼‰

ç»§ç»­é˜…è¯» `RedisReplication_Explanation.md`ï¼š
- å¢é‡å¤åˆ¶æµç¨‹
- å‘½ä»¤ä¼ æ’­
- å¤åˆ¶ç§¯å‹ç¼“å†²åŒº
- å¿ƒè·³æ£€æµ‹

### ç¬¬5æ­¥ï¼šè¿è¡Œå®Œæ•´ç‰ˆï¼ˆ20åˆ†é’Ÿï¼‰

```bash
java RedisReplication
```

è§‚å¯Ÿç½‘ç»œé€šä¿¡å’ŒçœŸå®æµç¨‹ã€‚

### ç¬¬6æ­¥ï¼šåŠ¨æ‰‹å®è·µï¼ˆ1å°æ—¶ï¼‰

ä¿®æ”¹ä»£ç ï¼Œæµ‹è¯•ä¸åŒåœºæ™¯ï¼š
1. ä¿®æ”¹backlogå¤§å°ï¼Œè§‚å¯Ÿå¢é‡å¤åˆ¶è¡Œä¸º
2. æ·»åŠ æ›´å¤šä»èŠ‚ç‚¹
3. æ¨¡æ‹Ÿç½‘ç»œä¸­æ–­å’Œæ¢å¤
4. å®ç°æ•°æ®æ ¡éªŒ

## ğŸ¯ æ ¸å¿ƒæ¦‚å¿µé€Ÿè®°

### ä¸‰ä¸ªå…³é”®æŒ‡æ ‡

```
1. Replication ID (å¤åˆ¶ID)
   - æ˜¯ä»€ä¹ˆï¼Ÿå”¯ä¸€æ ‡è¯†ä¸€ä¸ªæ•°æ®é›†
   - ä¸ºä»€ä¹ˆï¼Ÿåˆ¤æ–­æ˜¯å¦è¿æ¥çš„æ˜¯åŸæ¥çš„ä¸»èŠ‚ç‚¹
   - ä»€ä¹ˆæ—¶å€™å˜ï¼Ÿé‡å¯ã€ä»èŠ‚ç‚¹å‡çº§ä¸ºä¸»èŠ‚ç‚¹

2. Replication Offset (å¤åˆ¶åç§»é‡)
   - æ˜¯ä»€ä¹ˆï¼Ÿè®°å½•å·²å¤åˆ¶çš„å­—èŠ‚æ•°
   - ä¸ºä»€ä¹ˆï¼Ÿåˆ¤æ–­ä¸»ä»æ•°æ®æ˜¯å¦ä¸€è‡´
   - æ€ä¹ˆç”¨ï¼Ÿå¢é‡å¤åˆ¶æ—¶ç¡®å®šä»å“ªé‡Œå¼€å§‹

3. Replication Backlog (å¤åˆ¶ç§¯å‹ç¼“å†²åŒº)
   - æ˜¯ä»€ä¹ˆï¼Ÿç¯å½¢ç¼“å†²åŒºï¼Œä¿å­˜æœ€è¿‘çš„å†™å‘½ä»¤
   - ä¸ºä»€ä¹ˆï¼Ÿæ”¯æŒå¢é‡å¤åˆ¶
   - å¤šå¤§ï¼Ÿé»˜è®¤1MBï¼Œå¯é…ç½®
```

### ä¸¤ç§å¤åˆ¶æ–¹å¼

```
å…¨é‡å¤åˆ¶ï¼ˆFULLRESYNCï¼‰
â”œâ”€ ä»€ä¹ˆæ—¶å€™ï¼Ÿé¦–æ¬¡è¿æ¥ã€IDä¸åŒ¹é…ã€offsetå¤ªæ—§
â”œâ”€ åšä»€ä¹ˆï¼Ÿä¼ è¾“æ‰€æœ‰æ•°æ®ï¼ˆRDBï¼‰
â””â”€ ç¼ºç‚¹ï¼šæ•°æ®é‡å¤§æ—¶æ…¢

å¢é‡å¤åˆ¶ï¼ˆCONTINUEï¼‰
â”œâ”€ ä»€ä¹ˆæ—¶å€™ï¼ŸçŸ­æš‚æ–­çº¿é‡è¿ã€offsetåœ¨backlogèŒƒå›´å†…
â”œâ”€ åšä»€ä¹ˆï¼Ÿåªä¼ è¾“ç¼ºå¤±çš„å‘½ä»¤
â””â”€ ä¼˜ç‚¹ï¼šå¿«é€Ÿã€é«˜æ•ˆ
```

### ä¸€ä¸ªæŒç»­è¿‡ç¨‹

```
å‘½ä»¤ä¼ æ’­ï¼ˆCommand Propagationï¼‰
â”œâ”€ ä»€ä¹ˆæ—¶å€™ï¼Ÿå¤åˆ¶å®ŒæˆåæŒç»­è¿›è¡Œ
â”œâ”€ åšä»€ä¹ˆï¼Ÿä¸»èŠ‚ç‚¹çš„å†™å‘½ä»¤å®æ—¶å‘é€ç»™ä»èŠ‚ç‚¹
â””â”€ ç‰¹ç‚¹ï¼šå¼‚æ­¥ã€ä¸ç­‰å¾…ç¡®è®¤
```

## ğŸ” ä»£ç å¯¹æ¯”

### SimpleReplicationDemo vs RedisReplication

| ç‰¹æ€§ | SimpleReplicationDemo | RedisReplication |
|-----|----------------------|------------------|
| ä»£ç è¡Œæ•° | ~300è¡Œ | ~900è¡Œ |
| ç½‘ç»œé€šä¿¡ | âŒ ç®€åŒ–ä¸ºæ–¹æ³•è°ƒç”¨ | âœ… çœŸå®TCP Socket |
| RDBç”Ÿæˆ | âŒ ç›´æ¥å¤åˆ¶Map | âœ… åºåˆ—åŒ–ç”Ÿæˆ |
| PSYNCåè®® | âœ… ç®€åŒ–ç‰ˆ | âœ… å®Œæ•´å®ç° |
| Backlog | âœ… ç®€åŒ–ç‰ˆ | âœ… ç¯å½¢ç¼“å†²åŒº |
| é€‚åˆäººç¾¤ | åˆå­¦è€… | è¿›é˜¶å­¦ä¹ è€… |

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦Replication IDï¼Ÿ

```
åœºæ™¯ï¼š
1. ä¸»èŠ‚ç‚¹AæŒ‚äº†
2. ä»èŠ‚ç‚¹Bå‡çº§ä¸ºä¸»èŠ‚ç‚¹
3. ä»èŠ‚ç‚¹Cé‡è¿ï¼Œå¦‚æœåªçœ‹IP:Portå¯èƒ½è¿æ¥åˆ°B
4. ä½†Bçš„æ•°æ®å¯èƒ½ä¸å®Œæ•´ï¼Œåº”è¯¥å…¨é‡å¤åˆ¶

è§£å†³ï¼š
é€šè¿‡Replication IDåˆ¤æ–­ï¼š
- IDç›¸åŒï¼šåŒä¸€ä¸ªæ•°æ®é›†ï¼Œå¯ä»¥å¢é‡å¤åˆ¶
- IDä¸åŒï¼šä¸åŒæ•°æ®é›†ï¼Œå¿…é¡»å…¨é‡å¤åˆ¶
```

### Q2: ä¸ºä»€ä¹ˆéœ€è¦Offsetï¼Ÿ

```
é—®é¢˜ï¼šå¦‚ä½•çŸ¥é“ä»èŠ‚ç‚¹è½åäº†å¤šå°‘ï¼Ÿ

è§£å†³ï¼š
ä¸»èŠ‚ç‚¹ Offset: 1000
ä»èŠ‚ç‚¹ Offset: 900
â†’ ä»èŠ‚ç‚¹è½å100å­—èŠ‚
â†’ éœ€è¦ä¼ è¾“offset 900-1000çš„å‘½ä»¤
```

### Q3: Backlogæ»¡äº†æ€ä¹ˆåŠï¼Ÿ

```
åœºæ™¯ï¼š
Backlogåªæœ‰1MB
ä»èŠ‚ç‚¹æ–­çº¿å¾ˆä¹…ï¼Œç¼ºå¤±çš„å‘½ä»¤ > 1MB
â†’ Backlogä¸­æœ€æ—§çš„å‘½ä»¤è¢«è¦†ç›–äº†

ç»“æœï¼š
æ— æ³•å¢é‡å¤åˆ¶ï¼Œé€€åŒ–ä¸ºå…¨é‡å¤åˆ¶

è§£å†³ï¼š
æ ¹æ®å®é™…æƒ…å†µè°ƒå¤§Backlogï¼š
repl-backlog-size = æ–­çº¿æ—¶é—´(ç§’) Ã— æ¯ç§’å†™å…¥é‡(å­—èŠ‚)
```

### Q4: å…¨é‡å¤åˆ¶ä¼šé˜»å¡ä¸»èŠ‚ç‚¹å—ï¼Ÿ

```
ç­”æ¡ˆï¼šä¸ä¼šå®Œå…¨é˜»å¡ï¼Œä½†æœ‰å½±å“

è¿‡ç¨‹ï¼š
1. forkå­è¿›ç¨‹ - çŸ­æš‚é˜»å¡ï¼ˆå‡ æ¯«ç§’åˆ°å‡ ç™¾æ¯«ç§’ï¼‰
2. å­è¿›ç¨‹ç”ŸæˆRDB - ä¸é˜»å¡ä¸»è¿›ç¨‹
3. ä¼ è¾“RDB - ä¸é˜»å¡
4. ä¼ è¾“ç¼“å†²åŒºå‘½ä»¤ - ä¸é˜»å¡

å½±å“ï¼š
- forkæ—¶å¯èƒ½çŸ­æš‚é˜»å¡
- å¤§é‡ä»èŠ‚ç‚¹åŒæ—¶å…¨é‡å¤åˆ¶ä¼šå¢åŠ CPUå’Œç½‘ç»œå‹åŠ›
```

### Q5: ä¸»ä»æ•°æ®ä¸€å®šä¸€è‡´å—ï¼Ÿ

```
ç­”æ¡ˆï¼šä¸ä¸€å®šï¼Œæœ‰å»¶è¿Ÿ

åŸå› ï¼š
1. å‘½ä»¤ä¼ æ’­æ˜¯å¼‚æ­¥çš„
2. ç½‘ç»œæœ‰å»¶è¿Ÿ
3. ä»èŠ‚ç‚¹å¤„ç†éœ€è¦æ—¶é—´

ç»“æœï¼š
ä¸»èŠ‚ç‚¹å†™å…¥åï¼Œä»èŠ‚ç‚¹å¯èƒ½è¿˜æ²¡æ”¶åˆ°å‘½ä»¤
æ­¤æ—¶è¯»ä»èŠ‚ç‚¹ä¼šè¯»åˆ°æ—§æ•°æ®

è§£å†³æ–¹æ¡ˆï¼š
1. å¯¹ä¸€è‡´æ€§è¦æ±‚é«˜çš„è¯»ä¸»èŠ‚ç‚¹
2. ä½¿ç”¨ WAIT å‘½ä»¤ç­‰å¾…å¤åˆ¶å®Œæˆ
3. ç›‘æ§ lag å€¼
```

## ğŸ“ å®æˆ˜ç»ƒä¹ 

### ç»ƒä¹ 1ï¼šä¿®æ”¹Backlogå¤§å°

```java
// åœ¨SimpleReplicationDemoä¸­
private static final int MAX_LOG_SIZE = 100;  // æ”¹æˆ10

// è§‚å¯Ÿï¼š
// 1. å†™å…¥20ä¸ªå‘½ä»¤
// 2. ä»èŠ‚ç‚¹æ–­çº¿
// 3. ä¸»èŠ‚ç‚¹ç»§ç»­å†™å…¥20ä¸ªå‘½ä»¤
// 4. ä»èŠ‚ç‚¹é‡è¿
// ç»“æœï¼šæ— æ³•å¢é‡å¤åˆ¶ï¼Œæ‰§è¡Œå…¨é‡å¤åˆ¶
```

### ç»ƒä¹ 2ï¼šæµ‹è¯•çº§è”å¤åˆ¶

```java
// åˆ›å»ºä¸»ä»ä»ç»“æ„
SimpleMaster master = new SimpleMaster();
SimpleSlave slave1 = new SimpleSlave("Slave-1");
slave1.connectToMaster(master);

// è®©slave1ä¹Ÿå½“ä¸»èŠ‚ç‚¹
SimpleMaster slave1AsMaster = convertToMaster(slave1);
SimpleSlave slave2 = new SimpleSlave("Slave-2");
slave2.connectToMaster(slave1AsMaster);

// æµ‹è¯•å‘½ä»¤ä¼ æ’­ï¼šmaster â†’ slave1 â†’ slave2
```

### ç»ƒä¹ 3ï¼šå®ç°æ•°æ®æ ¡éªŒ

```java
// æ·»åŠ æ ¡éªŒæ–¹æ³•
public boolean verifyConsistency(SimpleMaster master, SimpleSlave slave) {
    return master.getData().equals(slave.getData()) &&
           master.getOffset() == slave.getOffset();
}

// å®šæœŸæ£€æŸ¥
Timer timer = new Timer();
timer.schedule(new TimerTask() {
    public void run() {
        if (!verifyConsistency(master, slave1)) {
            System.out.println("âš ï¸ æ•°æ®ä¸ä¸€è‡´ï¼");
        }
    }
}, 0, 1000);
```

### ç»ƒä¹ 4ï¼šæ¨¡æ‹Ÿç½‘ç»œä¸­æ–­

```java
// æ·»åŠ ç½‘ç»œä¸­æ–­æ¨¡æ‹Ÿ
public class NetworkSimulator {
    private boolean connected = true;

    public void disconnect() {
        connected = false;
        // åœæ­¢å‘½ä»¤ä¼ æ’­
    }

    public void reconnect() {
        connected = true;
        // é‡æ–°æ‰§è¡ŒPSYNC
    }
}
```

## ğŸ“Š æ€§èƒ½æµ‹è¯•

### æµ‹è¯•1ï¼šå…¨é‡å¤åˆ¶æ€§èƒ½

```java
// æµ‹è¯•ä»£ç 
long startTime = System.currentTimeMillis();

// æ’å…¥10000æ¡æ•°æ®
for (int i = 0; i < 10000; i++) {
    master.set("key" + i, "value" + i);
}

// ä»èŠ‚ç‚¹å…¨é‡å¤åˆ¶
SimpleSlave slave = new SimpleSlave("Slave-1");
slave.connectToMaster(master);

long endTime = System.currentTimeMillis();
System.out.println("å…¨é‡å¤åˆ¶è€—æ—¶: " + (endTime - startTime) + "ms");
```

### æµ‹è¯•2ï¼šå¢é‡å¤åˆ¶æ€§èƒ½

```java
// å…ˆå»ºç«‹è¿æ¥
SimpleSlave slave = new SimpleSlave("Slave-1");
slave.connectToMaster(master);

// æ¨¡æ‹Ÿæ–­çº¿ï¼ˆè½å100ä¸ªå‘½ä»¤ï¼‰
long oldOffset = slave.getOffset();
for (int i = 0; i < 100; i++) {
    master.set("key" + i, "value" + i);
}

// æµ‹è¯•å¢é‡å¤åˆ¶
long startTime = System.currentTimeMillis();
slave.connectToMaster(master);  // é‡è¿ï¼Œè§¦å‘å¢é‡å¤åˆ¶
long endTime = System.currentTimeMillis();

System.out.println("å¢é‡å¤åˆ¶è€—æ—¶: " + (endTime - startTime) + "ms");
```

## ğŸ”— ç›¸å…³èµ„æº

### å®˜æ–¹æ–‡æ¡£
- [Redis Replication](https://redis.io/topics/replication)
- [PSYNCå‘½ä»¤](https://redis.io/commands/psync)

### æºç ä½ç½®
- `replication.c` - ä¸»ä»å¤åˆ¶æ ¸å¿ƒé€»è¾‘
- `rdb.c` - RDBç”Ÿæˆå’ŒåŠ è½½
- `networking.c` - ç½‘ç»œé€šä¿¡

### æ¨èé˜…è¯»
1. Redisè®¾è®¡ä¸å®ç° - ç¬¬15ç« ï¼ˆä¸»ä»å¤åˆ¶ï¼‰
2. Redisæ·±åº¦å†é™© - ä¸»ä»åŒæ­¥
3. Redisæºç æ³¨é‡Šç‰ˆ - antirez/redis

## ğŸ¯ ä¸‹ä¸€æ­¥å­¦ä¹ 

æŒæ¡ä¸»ä»å¤åˆ¶åï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š

1. **Redis Sentinel**
   - è‡ªåŠ¨æ•…éšœè½¬ç§»
   - ç›‘æ§ä¸»ä»çŠ¶æ€
   - é…ç½®æä¾›

2. **Redis Cluster**
   - åˆ†å¸ƒå¼æ¶æ„
   - æ•°æ®åˆ†ç‰‡
   - é«˜å¯ç”¨å’Œæ‰©å±•æ€§

3. **å¤åˆ¶ä¼˜åŒ–**
   - æ— ç£ç›˜å¤åˆ¶
   - éƒ¨åˆ†å¤åˆ¶ä¼˜åŒ–
   - çº§è”å¤åˆ¶

---

**å¼€å§‹ä½ çš„å­¦ä¹ ä¹‹æ—…å§ï¼** ğŸš€

æœ‰ä»»ä½•é—®é¢˜ï¼Œæ¬¢è¿æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–é˜…è¯»è¯¦ç»†æ–‡æ¡£ï¼
