# Redisåˆ†å¸ƒå¼é”å®Œå…¨æŒ‡å—

> **ä½œè€…ï¼š** Redisæ¶æ„å¸ˆ
> **æ›´æ–°æ—¶é—´ï¼š** 2026-01-14
> **é€‚ç”¨äººç¾¤ï¼š** åç«¯å·¥ç¨‹å¸ˆã€æ¶æ„å¸ˆã€é¢è¯•å‡†å¤‡è€…

## ç›®å½•

- [ä¸€ã€åŸºç¡€ç†è®º](#ä¸€åŸºç¡€ç†è®º)
  - [1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”](#11-ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”)
  - [1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”](#12-ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”)
  - [1.3 åˆ†å¸ƒå¼é”çš„ä¸‰å¤§ç‰¹æ€§](#13-åˆ†å¸ƒå¼é”çš„ä¸‰å¤§ç‰¹æ€§)
- [äºŒã€Redisåˆ†å¸ƒå¼é”åº•å±‚åŸç†](#äºŒredisåˆ†å¸ƒå¼é”åº•å±‚åŸç†)
  - [2.1 åŸºç¡€å®ç°ï¼šSET NX EX](#21-åŸºç¡€å®ç°set-nx-ex)
  - [2.2 Rediså†…éƒ¨æ•°æ®ç»“æ„](#22-rediså†…éƒ¨æ•°æ®ç»“æ„)
  - [2.3 è¿‡æœŸåˆ é™¤æœºåˆ¶](#23-è¿‡æœŸåˆ é™¤æœºåˆ¶)
  - [2.4 Luaè„šæœ¬åŸå­æ€§](#24-luaè„šæœ¬åŸå­æ€§)
- [ä¸‰ã€å®ç°æ–¹æ¡ˆæ¼”è¿›](#ä¸‰å®ç°æ–¹æ¡ˆæ¼”è¿›)
  - [3.1 V1.0 åŸºç¡€ç‰ˆ](#31-v10-åŸºç¡€ç‰ˆ)
  - [3.2 V2.0 é˜²è¯¯åˆ ç‰ˆ](#32-v20-é˜²è¯¯åˆ ç‰ˆ)
  - [3.3 V3.0 è‡ªåŠ¨ç»­æœŸç‰ˆ](#33-v30-è‡ªåŠ¨ç»­æœŸç‰ˆ)
  - [3.4 V4.0 å¯é‡å…¥ç‰ˆ](#34-v40-å¯é‡å…¥ç‰ˆ)
  - [3.5 V5.0 Redlockç‰ˆ](#35-v50-redlockç‰ˆ)
- [å››ã€æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ](#å››æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ)
  - [4.1 é—®é¢˜1ï¼šé”è¿‡æœŸä½†ä¸šåŠ¡æœªå®Œæˆ](#41-é—®é¢˜1é”è¿‡æœŸä½†ä¸šåŠ¡æœªå®Œæˆ)
  - [4.2 é—®é¢˜2ï¼šä¸»ä»åŒæ­¥å»¶è¿Ÿå¯¼è‡´é”ä¸¢å¤±](#42-é—®é¢˜2ä¸»ä»åŒæ­¥å»¶è¿Ÿå¯¼è‡´é”ä¸¢å¤±)
  - [4.3 é—®é¢˜3ï¼šå¯é‡å…¥æ€§](#43-é—®é¢˜3å¯é‡å…¥æ€§)
  - [4.4 é—®é¢˜4ï¼šå…¬å¹³æ€§](#44-é—®é¢˜4å…¬å¹³æ€§)
  - [4.5 é—®é¢˜5ï¼šé«˜å¹¶å‘æ€§èƒ½](#45-é—®é¢˜5é«˜å¹¶å‘æ€§èƒ½)
- [äº”ã€å®æˆ˜æ¡ˆä¾‹](#äº”å®æˆ˜æ¡ˆä¾‹)
  - [5.1 æ¡ˆä¾‹1ï¼šç§’æ€é˜²æ­¢è¶…å–](#51-æ¡ˆä¾‹1ç§’æ€é˜²æ­¢è¶…å–)
  - [5.2 æ¡ˆä¾‹2ï¼šåˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡](#52-æ¡ˆä¾‹2åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡)
  - [5.3 æ¡ˆä¾‹3ï¼šæ¥å£å¹‚ç­‰æ€§](#53-æ¡ˆä¾‹3æ¥å£å¹‚ç­‰æ€§)
  - [5.4 æ¡ˆä¾‹4ï¼šåˆ†æ®µé”ä¼˜åŒ–](#54-æ¡ˆä¾‹4åˆ†æ®µé”ä¼˜åŒ–)
  - [5.5 æ¡ˆä¾‹5ï¼šç¼“å­˜æ›´æ–°](#55-æ¡ˆä¾‹5ç¼“å­˜æ›´æ–°)
- [å…­ã€é¢è¯•é¢˜åº“](#å…­é¢è¯•é¢˜åº“)
  - [6.1 åŸºç¡€é¢˜](#61-åŸºç¡€é¢˜)
  - [6.2 è¿›é˜¶é¢˜](#62-è¿›é˜¶é¢˜)
  - [6.3 åœºæ™¯é¢˜](#63-åœºæ™¯é¢˜)
  - [6.4 å¯¹æ¯”é¢˜](#64-å¯¹æ¯”é¢˜)
- [ä¸ƒã€æ€§èƒ½ä¼˜åŒ–](#ä¸ƒæ€§èƒ½ä¼˜åŒ–)
- [å…«ã€æœ€ä½³å®è·µ](#å…«æœ€ä½³å®è·µ)
- [ä¹ã€å¸¸è§é™·é˜±](#ä¹å¸¸è§é™·é˜±)

---

## ä¸€ã€åŸºç¡€ç†è®º

### 1.1 ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼é”

**å®šä¹‰ï¼š** åˆ†å¸ƒå¼é”æ˜¯æ§åˆ¶åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šä¸ªè¿›ç¨‹å¯¹å…±äº«èµ„æºäº’æ–¥è®¿é—®çš„ä¸€ç§æœºåˆ¶ã€‚

**æœ¬è´¨ï¼š** åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œé€šè¿‡å¤–éƒ¨å­˜å‚¨ï¼ˆRedis/Zookeeper/æ•°æ®åº“ï¼‰å®ç°è¿›ç¨‹é—´çš„äº’æ–¥ã€‚

**å¯¹æ¯”è¡¨ï¼š**

| é”ç±»å‹ | ä½œç”¨èŒƒå›´ | å®ç°æ–¹å¼ | å…¸å‹åœºæ™¯ |
|--------|----------|----------|----------|
| **JVMé”** | å•è¿›ç¨‹å†…çº¿ç¨‹ | synchronized/ReentrantLock | å•æœºå¤šçº¿ç¨‹ |
| **æ•°æ®åº“é”** | å¤šè¿›ç¨‹ | SELECT FOR UPDATE | ä½å¹¶å‘äº‹åŠ¡ |
| **åˆ†å¸ƒå¼é”** | å¤šè¿›ç¨‹/å¤šæœºå™¨ | Redis/ZK/etcd | é«˜å¹¶å‘åˆ†å¸ƒå¼ç³»ç»Ÿ |

### 1.2 ä¸ºä»€ä¹ˆéœ€è¦åˆ†å¸ƒå¼é”

**åœºæ™¯1ï¼šåº“å­˜æ‰£å‡**
```
æœåŠ¡å™¨A: è¯»åº“å­˜=1 â†’ æ‰£å‡ â†’ å†™åº“å­˜=0
æœåŠ¡å™¨B: è¯»åº“å­˜=1 â†’ æ‰£å‡ â†’ å†™åº“å­˜=0  âŒ è¶…å–ï¼
```

**åœºæ™¯2ï¼šå®šæ—¶ä»»åŠ¡**
```
æœåŠ¡å™¨A: æ¯å¤©2ç‚¹æ‰§è¡Œæ•°æ®åŒæ­¥
æœåŠ¡å™¨B: æ¯å¤©2ç‚¹æ‰§è¡Œæ•°æ®åŒæ­¥  âŒ é‡å¤æ‰§è¡Œï¼
```

**åœºæ™¯3ï¼šå”¯ä¸€è®¢å•å·**
```
æœåŠ¡å™¨A: ç”Ÿæˆè®¢å•å· 202601140001
æœåŠ¡å™¨B: ç”Ÿæˆè®¢å•å· 202601140001  âŒ è®¢å•å·é‡å¤ï¼
```

### 1.3 åˆ†å¸ƒå¼é”çš„ä¸‰å¤§ç‰¹æ€§

#### ç‰¹æ€§1ï¼šäº’æ–¥æ€§ï¼ˆMutual Exclusionï¼‰
```
åœ¨ä»»æ„æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªå®¢æˆ·ç«¯æŒæœ‰é”
```

**å®ç°æ–¹å¼ï¼š** Redisçš„ `SET key value NX` å‘½ä»¤
- NX = Not eXistsï¼ˆé”®ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼‰
- ä¿è¯åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æˆåŠŸè®¾ç½®

#### ç‰¹æ€§2ï¼šé˜²æ­»é”ï¼ˆDeadlock Freeï¼‰
```
å³ä½¿æŒæœ‰é”çš„å®¢æˆ·ç«¯å´©æºƒæˆ–ç½‘ç»œå¼‚å¸¸ï¼Œé”æœ€ç»ˆä¹Ÿèƒ½è¢«é‡Šæ”¾
```

**å®ç°æ–¹å¼ï¼š** è®¾ç½®è¿‡æœŸæ—¶é—´ `EX seconds`
- å³ä½¿å®¢æˆ·ç«¯å®•æœºï¼ŒRedisä¼šè‡ªåŠ¨åˆ é™¤
- é¿å…é”æ°¸ä¹…å ç”¨

#### ç‰¹æ€§3ï¼šå®¹é”™æ€§ï¼ˆFault Toleranceï¼‰
```
åªè¦å¤§éƒ¨åˆ†RedisèŠ‚ç‚¹å­˜æ´»ï¼Œå°±èƒ½æ­£å¸¸åŠ é”è§£é”
```

**å®ç°æ–¹å¼ï¼š** Redlockç®—æ³•
- éƒ¨ç½²Nä¸ªç‹¬ç«‹Rediså®ä¾‹
- è¶…è¿‡åŠæ•°æˆåŠŸæ‰ç®—æˆåŠŸ

---

## äºŒã€Redisåˆ†å¸ƒå¼é”åº•å±‚åŸç†

### 2.1 åŸºç¡€å®ç°ï¼šSET NX EX

#### å‘½ä»¤æ ¼å¼
```redis
SET lock_key unique_value NX EX 10
```

**å‚æ•°è¯¦è§£ï¼š**
- `lock_key`: é”çš„æ ‡è¯†ï¼ˆå¦‚ï¼š`lock:order:123`ï¼‰
- `unique_value`: å”¯ä¸€æ ‡è¯†å€¼ï¼ˆå¦‚ï¼šUUIDï¼‰ï¼Œç”¨äºéªŒè¯é”çš„æ‰€æœ‰æƒ
- `NX`: Not eXistsï¼Œé”®ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®
- `EX 10`: è®¾ç½®è¿‡æœŸæ—¶é—´10ç§’

#### Rediså†…éƒ¨æ‰§è¡Œæµç¨‹

```c
// Redisæºç ï¼št_string.c
void setCommand(client *c) {
    robj *key = c->argv[1];
    robj *val = c->argv[2];

    // 1. æ£€æŸ¥NXæ ‡å¿—
    if (flags & OBJ_SET_NX) {
        if (lookupKeyWrite(c->db, key) != NULL) {
            addReply(c, shared.null[c->resp]);  // é”®å·²å­˜åœ¨ï¼Œè¿”å›nil
            return;
        }
    }

    // 2. è®¾ç½®é”®å€¼
    setKey(c->db, key, val);

    // 3. è®¾ç½®è¿‡æœŸæ—¶é—´
    if (expire) {
        setExpire(c, c->db, key, mstime() + milliseconds);
    }

    // 4. è¿”å›OK
    addReply(c, shared.ok);
}
```

**å…³é”®ç‚¹ï¼šæ•´ä¸ªè¿‡ç¨‹æ˜¯åŸå­æ“ä½œï¼**

#### ä¸ºä»€ä¹ˆæ—©æœŸå®ç°æœ‰é—®é¢˜ï¼Ÿ

âŒ **é”™è¯¯åšæ³•ï¼ˆéåŸå­ï¼‰ï¼š**
```java
// ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥å¹¶è®¾ç½®
if (jedis.setnx(lockKey, value) == 1) {
    // ç¬¬äºŒæ­¥ï¼šè®¾ç½®è¿‡æœŸæ—¶é—´
    jedis.expire(lockKey, 10);  // âŒ å¦‚æœè¿™é‡Œå®•æœºï¼Œé”æ°¸ä¸è¿‡æœŸï¼
}
```

**é—®é¢˜ï¼š** ä¸¤æ¡å‘½ä»¤ä¸æ˜¯åŸå­çš„ï¼Œä¸­é—´å¯èƒ½å´©æºƒå¯¼è‡´æ­»é”

âœ… **æ­£ç¡®åšæ³•ï¼ˆåŸå­ï¼‰ï¼š**
```java
// ä¸€æ¡å‘½ä»¤å®Œæˆæ‰€æœ‰æ“ä½œ
jedis.set(lockKey, value, SetParams.setParams().nx().ex(10));
```

### 2.2 Rediså†…éƒ¨æ•°æ®ç»“æ„

#### å­˜å‚¨ç»“æ„
```
Redis String ç±»å‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RedisObject         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ type: REDIS_STRING  â”‚
â”‚ encoding: RAW/INT   â”‚
â”‚ lru: æ—¶é—´æˆ³         â”‚
â”‚ ptr: æŒ‡å‘SDS        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SDS (Simple Dynamic â”‚
â”‚      String)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ len: 36             â”‚ â† å­—ç¬¦ä¸²é•¿åº¦
â”‚ free: 0             â”‚ â† å‰©ä½™ç©ºé—´
â”‚ buf: "uuid-abc..."  â”‚ â† å®é™…æ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å†…å­˜å¸ƒå±€ï¼ˆCç»“æ„ï¼‰
```c
// redis.h
typedef struct redisObject {
    unsigned type:4;        // ç±»å‹ï¼šREDIS_STRING
    unsigned encoding:4;    // ç¼–ç ï¼šOBJ_ENCODING_RAW
    unsigned lru:24;        // LRUæ—¶é—´æˆ³
    int refcount;           // å¼•ç”¨è®¡æ•°
    void *ptr;              // æŒ‡å‘å®é™…æ•°æ®ï¼ˆSDSï¼‰
} robj;

// sds.h
struct __attribute__ ((__packed__)) sdshdr8 {
    uint8_t len;        // å·²ä½¿ç”¨é•¿åº¦
    uint8_t alloc;      // åˆ†é…çš„æ€»é•¿åº¦
    unsigned char flags;
    char buf[];         // å®é™…å­˜å‚¨çš„å­—ç¬¦ä¸²
};
```

#### è¿‡æœŸé”®çš„å­˜å‚¨
```
Redisç»´æŠ¤ä¸€ä¸ªè¿‡æœŸå­—å…¸ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Key          â”‚ Expire Time  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ lock:order:1 â”‚ 1705200000   â”‚ â† Unixæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
â”‚ lock:stock:2 â”‚ 1705200010   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ•°æ®ç»“æ„ï¼š
typedef struct redisDb {
    dict *dict;         // æ‰€æœ‰é”®å€¼å¯¹
    dict *expires;      // è¿‡æœŸæ—¶é—´å­—å…¸ â† å­˜å‚¨è¿‡æœŸä¿¡æ¯
    dict *blocking_keys;
    dict *ready_keys;
    dict *watched_keys;
    int id;
} redisDb;
```

### 2.3 è¿‡æœŸåˆ é™¤æœºåˆ¶

Redisä½¿ç”¨**æƒ°æ€§åˆ é™¤ + å®šæœŸåˆ é™¤**ç»„åˆç­–ç•¥ï¼š

#### ç­–ç•¥1ï¼šæƒ°æ€§åˆ é™¤ï¼ˆLazy Expirationï¼‰

```c
// db.c
robj *lookupKeyRead(redisDb *db, robj *key) {
    // è®¿é—®é”®æ—¶æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    expireIfNeeded(db, key);
    return lookupKey(db, key);
}

int expireIfNeeded(redisDb *db, robj *key) {
    if (!keyIsExpired(db, key)) return 0;

    // å¦‚æœæ˜¯ä¸»èŠ‚ç‚¹ï¼Œç›´æ¥åˆ é™¤
    if (server.masterhost == NULL) {
        deleteKey(db, key);
        return 1;
    }

    return 1;
}
```

**ç‰¹ç‚¹ï¼š**
- è®¿é—®æ—¶æ‰æ£€æŸ¥
- CPUå‹å¥½ï¼ˆä¸ä¸»åŠ¨æ‰«æï¼‰
- å¯èƒ½å¯¼è‡´è¿‡æœŸé”®å ç”¨å†…å­˜

#### ç­–ç•¥2ï¼šå®šæœŸåˆ é™¤ï¼ˆActive Expirationï¼‰

```c
// expire.c
void activeExpireCycle(int type) {
    static unsigned int current_db = 0;

    // éå†æ‰€æœ‰æ•°æ®åº“
    for (j = 0; j < dbs_per_call; j++) {
        db = server.db + current_db;

        // éšæœºæŠ½å–20ä¸ªé”®æ£€æŸ¥
        do {
            num = dictSize(db->expires);
            if (num == 0) break;

            // éšæœºè·å–é”®
            de = dictGetRandomKey(db->expires);

            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if (activeExpireCycleTryExpire(db, de)) {
                expired++;
            }

            // å¦‚æœè¿‡æœŸé”®æ¯”ä¾‹ > 25%ï¼Œç»§ç»­æ£€æŸ¥
        } while (expired > ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP / 4);
    }
}
```

**ç‰¹ç‚¹ï¼š**
- æ¯100msæ‰§è¡Œä¸€æ¬¡ï¼ˆserverCronï¼‰
- æ¯æ¬¡éšæœºæŠ½å–20ä¸ªé”®
- å¦‚æœè¿‡æœŸç‡>25%ï¼Œç»§ç»­æŠ½å–
- æœ€å¤šæ‰§è¡Œ25ms

#### é”è¿‡æœŸæ—¶çš„å®é™…è¡Œä¸º

```
åœºæ™¯ï¼šClient A åŠ é”ï¼ŒTTL=10ç§’

Time: 0s   â†’ SET lock_key uuid-A NX EX 10
Time: 5s   â†’ ä¸šåŠ¡å¤„ç†ä¸­...
Time: 10s  â†’ é”®è¿‡æœŸï¼ˆä½†å¯èƒ½è¿˜åœ¨å†…å­˜ä¸­ï¼‰
Time: 10s  â†’ Client B å°è¯•åŠ é”
           â†’ lookupKeyRead() è§¦å‘ expireIfNeeded()
           â†’ æ£€æµ‹åˆ°è¿‡æœŸï¼Œåˆ é™¤é”®
           â†’ Client B åŠ é”æˆåŠŸ
```

### 2.4 Luaè„šæœ¬åŸå­æ€§

#### ä¸ºä»€ä¹ˆéœ€è¦Luaï¼Ÿ

âŒ **é—®é¢˜ä»£ç ï¼š**
```java
// æ­¥éª¤1ï¼šè·å–å€¼
String value = jedis.get(lockKey);

// æ­¥éª¤2ï¼šåˆ¤æ–­æ˜¯å¦ç›¸ç­‰
if (lockValue.equals(value)) {
    // æ­¥éª¤3ï¼šåˆ é™¤é”®
    jedis.del(lockKey);  // âŒ å¯èƒ½è¯¯åˆ å…¶ä»–äººçš„é”ï¼
}
```

**æ—¶åºé—®é¢˜ï¼š**
```
Time: 0s   â†’ Client A åŠ é”ï¼ˆTTL=10sï¼‰
Time: 10s  â†’ é”è¿‡æœŸè‡ªåŠ¨é‡Šæ”¾
Time: 10s  â†’ Client B åŠ é”æˆåŠŸ
Time: 10s  â†’ Client A çš„æ­¥éª¤1-2æ‰§è¡Œå®Œï¼ˆvalueè¿˜æ˜¯æ—§çš„ï¼‰
Time: 10s  â†’ Client A æ‰§è¡Œæ­¥éª¤3ï¼Œåˆ é™¤äº† Client B çš„é”ï¼
```

#### Luaè„šæœ¬çš„åŸå­æ€§ä¿è¯

âœ… **æ­£ç¡®ä»£ç ï¼š**
```lua
-- unlock.lua
if redis.call('get', KEYS[1]) == ARGV[1] then
    return redis.call('del', KEYS[1])
else
    return 0
end
```

**Rediså¦‚ä½•ä¿è¯LuaåŸå­æ€§ï¼Ÿ**

```c
// scripting.c
void evalGenericCommand(client *c, int evalsha) {
    // 1. è®¾ç½®å…¨å±€é”æ ‡å¿—
    server.lua_caller = c;
    server.lua_time_limit = server.lua_time_limit;

    // 2. ç¦æ­¢å…¶ä»–å‘½ä»¤æ‰§è¡Œ
    server.lua_client = createClient(-1);

    // 3. æ‰§è¡ŒLuaè„šæœ¬
    lua_pcall(lua, 0, 1, 0);

    // 4. é‡Šæ”¾å…¨å±€é”
    server.lua_caller = NULL;
}
```

**å…³é”®æœºåˆ¶ï¼š**
1. **å•çº¿ç¨‹æ‰§è¡Œ**ï¼šRedisä¸»çº¿ç¨‹æ‰§è¡ŒLuaï¼ŒæœŸé—´é˜»å¡å…¶ä»–å‘½ä»¤
2. **å‘½ä»¤é˜Ÿåˆ—**ï¼šå…¶ä»–å®¢æˆ·ç«¯å‘½ä»¤è¿›å…¥é˜Ÿåˆ—ç­‰å¾…
3. **è¶…æ—¶æ§åˆ¶**ï¼šé»˜è®¤5ç§’è¶…æ—¶ï¼ˆ`lua-time-limit`ï¼‰

#### Luaè„šæœ¬çš„æ‰§è¡Œæµç¨‹

```
Client A                    Redis                     Client B
   â”‚                          â”‚                          â”‚
   â”‚  EVAL unlock.lua         â”‚                          â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚ [ä¸Šå…¨å±€é”]               â”‚
   â”‚                          â”‚ redis.call('get')        â”‚
   â”‚                          â”‚ æ¯”è¾ƒ value               â”‚
   â”‚                          â”‚ redis.call('del')        â”‚
   â”‚                          â”‚ [é‡Šæ”¾é”]                 â”‚
   â”‚                          â”‚                          â”‚
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                          â”‚
   â”‚  return 1                â”‚                          â”‚
   â”‚                          â”‚                          â”‚
   â”‚                          â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                          â”‚  SET key value NX        â”‚
   â”‚                          â”‚  (ç­‰å¾…Luaæ‰§è¡Œå®Œ)        â”‚
```

---

## ä¸‰ã€å®ç°æ–¹æ¡ˆæ¼”è¿›

### 3.1 V1.0 åŸºç¡€ç‰ˆ

**ä»£ç ï¼š** `DistributedLockV1.java`

```java
public class DistributedLockV1 {
    public boolean lock() {
        return jedis.setnx(lockKey, "1") == 1;  // âŒ æ²¡æœ‰è¿‡æœŸæ—¶é—´
    }

    public void unlock() {
        jedis.del(lockKey);  // âŒ æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ
    }
}
```

**é—®é¢˜ï¼š**
1. âŒ æ²¡æœ‰è¿‡æœŸæ—¶é—´ â†’ æ­»é”
2. âŒ æ²¡æœ‰éªŒè¯æ‰€æœ‰æƒ â†’ è¯¯åˆ å…¶ä»–äººçš„é”
3. âŒ åŠ é”å’Œè®¾ç½®è¿‡æœŸä¸æ˜¯åŸå­æ“ä½œ

### 3.2 V2.0 é˜²è¯¯åˆ ç‰ˆ

**ä»£ç ï¼š** `DistributedLockV2.java`

```java
public class DistributedLockV2 {
    private String lockValue = UUID.randomUUID().toString();

    public boolean lock() {
        SetParams params = SetParams.setParams().nx().ex(10);
        return "OK".equals(jedis.set(lockKey, lockValue, params));
    }

    public boolean unlock() {
        String script =
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('del', KEYS[1]) " +
            "else " +
            "    return 0 " +
            "end";

        Object result = jedis.eval(script,
            Collections.singletonList(lockKey),
            Collections.singletonList(lockValue));

        return Long.valueOf(1).equals(result);
    }
}
```

**æ”¹è¿›ï¼š**
1. âœ… SET NX EX åŸå­æ“ä½œ
2. âœ… UUIDæ ‡è¯†æ‰€æœ‰æƒ
3. âœ… Luaè„šæœ¬é˜²è¯¯åˆ 

**å‰©ä½™é—®é¢˜ï¼š**
1. âŒ ä¸šåŠ¡æ‰§è¡Œæ—¶é—´è¶…è¿‡TTLæ€ä¹ˆåŠï¼Ÿ

### 3.3 V3.0 è‡ªåŠ¨ç»­æœŸç‰ˆ

**ä»£ç ï¼š** `DistributedLockV3.java`ï¼ˆä½ é¡¹ç›®ä¸­çš„ `DistributedLock.java`ï¼‰

```java
public class DistributedLockV3 {
    // çœ‹é—¨ç‹—æœºåˆ¶
    public Thread startWatchDog() {
        Thread watchDog = new Thread(() -> {
            while (!Thread.currentThread().isInterrupted()) {
                try {
                    // æ¯éš”TTL/3ç»­æœŸä¸€æ¬¡
                    Thread.sleep(expireTime * 1000L / 3);
                    renewal();
                } catch (InterruptedException e) {
                    break;
                }
            }
        });
        watchDog.setDaemon(true);
        watchDog.start();
        return watchDog;
    }

    public boolean renewal() {
        String script =
            "if redis.call('get', KEYS[1]) == ARGV[1] then " +
            "    return redis.call('expire', KEYS[1], ARGV[2]) " +
            "else " +
            "    return 0 " +
            "end";

        Object result = jedis.eval(script,
            Collections.singletonList(lockKey),
            Arrays.asList(lockValue, String.valueOf(expireTime)));

        return Long.valueOf(1).equals(result);
    }
}
```

**æ”¹è¿›ï¼š**
1. âœ… è‡ªåŠ¨ç»­æœŸï¼Œé˜²æ­¢é”è¿‡æœŸ
2. âœ… çœ‹é—¨ç‹—åå°çº¿ç¨‹

**å‰©ä½™é—®é¢˜ï¼š**
1. âŒ ä¸æ”¯æŒé‡å…¥ï¼ˆåŒä¸€çº¿ç¨‹æ— æ³•å¤šæ¬¡åŠ é”ï¼‰

### 3.4 V4.0 å¯é‡å…¥ç‰ˆ

è¯¦è§ `ReentrantDistributedLock.java` å®ç°

**æ ¸å¿ƒæ€æƒ³ï¼š** ä½¿ç”¨Hashç»“æ„è®°å½•é‡å…¥æ¬¡æ•°

```redis
HSET lock_key {uuid:threadId} {count}

ç¤ºä¾‹ï¼š
HGETALL myLock
1) "uuid-abc-123:thread-456"
2) "3"  â† é‡å…¥äº†3æ¬¡
```

**å‰©ä½™é—®é¢˜ï¼š**
1. âŒ å•ç‚¹æ•…éšœï¼ˆä¸»ä»åŒæ­¥å»¶è¿Ÿï¼‰

### 3.5 V5.0 Redlockç‰ˆ

è¯¦è§ `RedLockDistributedLock.java` å®ç°

**æ ¸å¿ƒæ€æƒ³ï¼š** å‘Nä¸ªç‹¬ç«‹Rediså®ä¾‹è¯·æ±‚åŠ é”ï¼Œè¶…è¿‡åŠæ•°æˆåŠŸæ‰ç®—æˆåŠŸ

**å‰©ä½™é—®é¢˜ï¼š**
1. âŒ æ€§èƒ½å¼€é”€å¤§
2. âŒ æ—¶é’Ÿæ¼‚ç§»é—®é¢˜

---

## å››ã€æ ¸å¿ƒé—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

### 4.1 é—®é¢˜1ï¼šé”è¿‡æœŸä½†ä¸šåŠ¡æœªå®Œæˆ

#### é—®é¢˜æè¿°

```
Time: 0s   â†’ Client A åŠ é”ï¼ˆTTL=10sï¼‰
Time: 5s   â†’ ä¸šåŠ¡å¤„ç†ä¸­...
Time: 10s  â†’ é”è‡ªåŠ¨è¿‡æœŸ âŒ
Time: 10s  â†’ Client B åŠ é”æˆåŠŸ
Time: 12s  â†’ Client A ä¸šåŠ¡å®Œæˆï¼Œè¯¯åˆ  Client B çš„é” âŒ
```

#### è§£å†³æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | å®ç° | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|------|
| **æ–¹æ¡ˆ1ï¼šè®¾ç½®è¶³å¤Ÿé•¿çš„TTL** | TTL = ä¸šåŠ¡æ—¶é—´ Ã— 2 | ç®€å• | å¯èƒ½æ­»é”æ—¶é—´é•¿ |
| **æ–¹æ¡ˆ2ï¼šçœ‹é—¨ç‹—ç»­æœŸ** | åå°çº¿ç¨‹å®šæœŸç»­æœŸ | çµæ´» | çº¿ç¨‹å¼€é”€ |
| **æ–¹æ¡ˆ3ï¼šUUIDé˜²è¯¯åˆ ** | è§£é”æ—¶éªŒè¯value | å®‰å…¨ | æ— æ³•å®Œå…¨é¿å…è¿‡æœŸ |

#### æ¨èæ–¹æ¡ˆï¼šçœ‹é—¨ç‹— + UUID

```java
// åŠ é”æ—¶å¯åŠ¨çœ‹é—¨ç‹—
Thread watchDog = lock.startWatchDog();

try {
    // ä¸šåŠ¡é€»è¾‘ï¼ˆå¯èƒ½å¾ˆé•¿æ—¶é—´ï¼‰
    longRunningTask();
} finally {
    // åœæ­¢çœ‹é—¨ç‹—
    watchDog.interrupt();
    // å®‰å…¨è§£é”
    lock.unlock();
}
```

### 4.2 é—®é¢˜2ï¼šä¸»ä»åŒæ­¥å»¶è¿Ÿå¯¼è‡´é”ä¸¢å¤±

#### é—®é¢˜æè¿°

```
æ¶æ„ï¼šRedis Master-Slave

Time: 0s   â†’ Client A å‘ Master åŠ é”æˆåŠŸ
Time: 0.1s â†’ Master å®•æœºï¼ˆé”æœªåŒæ­¥åˆ° Slaveï¼‰
Time: 0.2s â†’ Slave å‡çº§ä¸º Master
Time: 0.3s â†’ Client B å‘æ–° Master åŠ é”æˆåŠŸ
ç»“æœï¼šä¸¤ä¸ªå®¢æˆ·ç«¯åŒæ—¶æŒæœ‰é” âŒ
```

#### æ ¹æœ¬åŸå› 

Redisä¸»ä»å¤åˆ¶æ˜¯**å¼‚æ­¥**çš„ï¼š
```c
// replication.c
void replicationFeedSlaves(list *slaves, int dictid, robj **argv, int argc) {
    // å†™å…¥å¤åˆ¶ç¼“å†²åŒºï¼ˆå¼‚æ­¥ï¼‰
    addReplyToBuffer(slave, buf, len);
    // ä¸ç­‰å¾…ACKå°±è¿”å› âŒ
}
```

#### è§£å†³æ–¹æ¡ˆ1ï¼šRedlockç®—æ³•

**åŸç†ï¼š** å‘Nä¸ªç‹¬ç«‹Rediså®ä¾‹ï¼ˆéä¸»ä»ï¼‰åŠ é”

```java
// éƒ¨ç½²5ä¸ªç‹¬ç«‹Redisï¼ˆä¸æ˜¯ä¸»ä»å…³ç³»ï¼‰
Redis1: 192.168.1.1:6379
Redis2: 192.168.1.2:6379
Redis3: 192.168.1.3:6379
Redis4: 192.168.1.4:6379
Redis5: 192.168.1.5:6379

// åŠ é”æµç¨‹
int successCount = 0;
for (Redis redis : allRedis) {
    if (redis.set(key, value, NX, EX, 10) == OK) {
        successCount++;
    }
}

// åˆ¤æ–­ï¼šè¶…è¿‡åŠæ•°ï¼ˆ3/5ï¼‰æ‰æˆåŠŸ
if (successCount >= 3) {
    return true;  // åŠ é”æˆåŠŸ
} else {
    releaseAllLocks();  // é‡Šæ”¾æ‰€æœ‰å·²åŠ çš„é”
    return false;
}
```

**ä¸ºä»€ä¹ˆæœ‰æ•ˆï¼Ÿ**
- å³ä½¿2ä¸ªRediså®•æœºï¼Œä»æœ‰3ä¸ªå­˜æ´»
- æ”»å‡»è€…æ— æ³•åŒæ—¶æ‹¿åˆ°3ä¸ªRedisçš„é”

#### è§£å†³æ–¹æ¡ˆ2ï¼šWAITå‘½ä»¤ï¼ˆRedis 3.0+ï¼‰

```java
// åŠ é”åç­‰å¾…åŒæ­¥
jedis.set(lockKey, lockValue, SetParams.setParams().nx().ex(10));

// ç­‰å¾…è‡³å°‘1ä¸ªä»èŠ‚ç‚¹ç¡®è®¤åŒæ­¥ï¼ˆè¶…æ—¶1000msï¼‰
Long replicas = jedis.waitReplicas(1, 1000);

if (replicas < 1) {
    // åŒæ­¥å¤±è´¥ï¼Œé‡Šæ”¾é”
    jedis.del(lockKey);
    return false;
}
```

**WAITå‘½ä»¤åŸç†ï¼š**
```c
// replication.c
void waitCommand(client *c) {
    // å‘æ‰€æœ‰ä»èŠ‚ç‚¹å‘é€ REPLCONF GETACK
    // ç­‰å¾…ä»èŠ‚ç‚¹è¿”å› offset >= å½“å‰offset
    // è¶…æ—¶æˆ–è¾¾åˆ°æ•°é‡è¦æ±‚åè¿”å›
}
```

#### è§£å†³æ–¹æ¡ˆ3ï¼šä½¿ç”¨Zookeeper

Zookeeperæ˜¯CPç³»ç»Ÿï¼ˆå¼ºä¸€è‡´æ€§ï¼‰ï¼š
```java
// ZKåŠ é”æµç¨‹
InterProcessMutex lock = new InterProcessMutex(zkClient, "/locks/order");
lock.acquire();  // é˜»å¡ç›´åˆ°è·å–é”
try {
    // ä¸šåŠ¡é€»è¾‘
} finally {
    lock.release();
}
```

**ä¸ºä»€ä¹ˆZKæ›´å¯é ï¼Ÿ**
- ZKä½¿ç”¨Paxos/Raftåè®®
- å†™å…¥å¿…é¡»è¶…è¿‡åŠæ•°èŠ‚ç‚¹ç¡®è®¤
- ä½†æ€§èƒ½æ¯”Redisä½ï¼ˆQPS 1ä¸‡ vs 10ä¸‡ï¼‰

### 4.3 é—®é¢˜3ï¼šå¯é‡å…¥æ€§

è¯¦è§ `ReentrantDistributedLock.java` å®ç°æ–‡æ¡£

### 4.4 é—®é¢˜4ï¼šå…¬å¹³æ€§

**é—®é¢˜ï¼š** å¤šä¸ªå®¢æˆ·ç«¯ç«äº‰é”æ—¶ï¼Œå¯èƒ½æŸäº›å®¢æˆ·ç«¯ä¸€ç›´è·å–ä¸åˆ°ï¼ˆé¥¥é¥¿ï¼‰

**è§£å†³æ–¹æ¡ˆï¼š** å…¬å¹³é”ï¼ˆåŸºäºZSetå®ç°é˜Ÿåˆ—ï¼‰

```java
// åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
long score = System.currentTimeMillis();
jedis.zadd("lock:queue", score, clientId);

// æ£€æŸ¥æ˜¯å¦è½®åˆ°è‡ªå·±
Set<String> range = jedis.zrange("lock:queue", 0, 0);
if (range.contains(clientId)) {
    // è½®åˆ°è‡ªå·±ï¼Œå°è¯•åŠ é”
    if (tryLock()) {
        jedis.zrem("lock:queue", clientId);
        return true;
    }
}
```

### 4.5 é—®é¢˜5ï¼šé«˜å¹¶å‘æ€§èƒ½

**é—®é¢˜ï¼š** ç§’æ€åœºæ™¯ä¸‹ï¼Œæ‰€æœ‰è¯·æ±‚äº‰æŠ¢åŒä¸€æŠŠé”ï¼Œæ€§èƒ½ç“¶é¢ˆ

**è§£å†³æ–¹æ¡ˆï¼šåˆ†æ®µé”**

```java
// å°†åº“å­˜åˆ†æˆ10æ®µ
int segment = ThreadLocalRandom.current().nextInt(10);
String lockKey = "lock:stock:" + productId + ":" + segment;

// æ¯æ®µç‹¬ç«‹åŠ é”
DistributedLock lock = new DistributedLock(jedis, lockKey, 5);
```

**æ€§èƒ½æå‡ï¼š**
```
å•é”æ¨¡å¼ï¼šQPS = 1000
åˆ†æ®µé”(10æ®µ)ï¼šQPS = 10000  â† æå‡10å€
```

---

## äº”ã€å®æˆ˜æ¡ˆä¾‹

è¯¦è§ç‹¬ç«‹çš„æ¡ˆä¾‹ä»£ç æ–‡ä»¶ï¼š
- `LockCase1_Seckill.java` - ç§’æ€é˜²è¶…å–
- `LockCase2_ScheduledTask.java` - å®šæ—¶ä»»åŠ¡é˜²é‡
- `LockCase3_Idempotent.java` - æ¥å£å¹‚ç­‰æ€§
- `LockCase4_SegmentLock.java` - åˆ†æ®µé”ä¼˜åŒ–
- `LockCase5_CacheUpdate.java` - ç¼“å­˜æ›´æ–°

---

## å…­ã€é¢è¯•é¢˜åº“

### 6.1 åŸºç¡€é¢˜

#### Q1: Redisåˆ†å¸ƒå¼é”çš„å®ç°åŸç†ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
1. åŠ é”ï¼šSET key value NX EX seconds
   - NXï¼šé”®ä¸å­˜åœ¨æ—¶æ‰è®¾ç½®ï¼ˆä¿è¯äº’æ–¥ï¼‰
   - EXï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆé˜²æ­¢æ­»é”ï¼‰
   - valueï¼šUUIDæ ‡è¯†é”çš„æ‰€æœ‰è€…

2. è§£é”ï¼šLuaè„šæœ¬ä¿è¯åŸå­æ€§
   if redis.call('get', key) == value then
       redis.call('del', key)
   end

   ä½œç”¨ï¼šé˜²æ­¢è¯¯åˆ å…¶ä»–äººçš„é”

3. ç»­æœŸï¼šçœ‹é—¨ç‹—æœºåˆ¶
   - åå°çº¿ç¨‹æ¯éš”TTL/3ç»­æœŸä¸€æ¬¡
   - é˜²æ­¢ä¸šåŠ¡æœªå®Œæˆé”å°±è¿‡æœŸ
```

**åŠ åˆ†ç‚¹ï¼š**
- æåˆ°SET NX EXçš„åŸå­æ€§
- çŸ¥é“æ—©æœŸSETNX+EXPIREçš„é—®é¢˜
- äº†è§£Luaè„šæœ¬çš„ä½œç”¨

#### Q2: ä¸ºä»€ä¹ˆè¦ç”¨Luaè„šæœ¬è§£é”ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
ä¿è¯åŸå­æ€§ï¼

é”™è¯¯åšæ³•ï¼š
  String value = jedis.get(lockKey);
  if (myValue.equals(value)) {
      jedis.del(lockKey);  // âŒ éåŸå­æ“ä½œ
  }

é—®é¢˜ï¼š
  Time: 0s  â†’ è¯»å–value
  Time: 1s  â†’ é”è¿‡æœŸï¼Œå…¶ä»–äººåŠ é”æˆåŠŸ
  Time: 2s  â†’ æ‰§è¡ŒDELï¼Œè¯¯åˆ å…¶ä»–äººçš„é”ï¼

æ­£ç¡®åšæ³•ï¼š
  Luaè„šæœ¬åœ¨Redisä¸­åŸå­æ‰§è¡Œ
  æœŸé—´ä¸ä¼šè¢«å…¶ä»–å‘½ä»¤æ‰“æ–­
```

**åŠ åˆ†ç‚¹ï¼š**
- èƒ½è¯´å‡ºå…·ä½“çš„æ—¶åºé—®é¢˜
- çŸ¥é“Rediså•çº¿ç¨‹æ‰§è¡ŒLua
- äº†è§£EVALå‘½ä»¤

#### Q3: åˆ†å¸ƒå¼é”çš„ä¸‰ä¸ªæ ¸å¿ƒå±æ€§ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
1. äº’æ–¥æ€§ï¼ˆSafetyï¼‰
   - ä»»æ„æ—¶åˆ»åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯æŒæœ‰é”
   - å®ç°ï¼šSET NX

2. é˜²æ­»é”ï¼ˆLiveness Aï¼‰
   - å³ä½¿å®¢æˆ·ç«¯å´©æºƒï¼Œé”æœ€ç»ˆä¹Ÿèƒ½é‡Šæ”¾
   - å®ç°ï¼šEXè¿‡æœŸæ—¶é—´

3. å®¹é”™æ€§ï¼ˆLiveness Bï¼‰
   - å¤§éƒ¨åˆ†RedisèŠ‚ç‚¹å­˜æ´»å°±èƒ½å·¥ä½œ
   - å®ç°ï¼šRedlockç®—æ³•
```

### 6.2 è¿›é˜¶é¢˜

#### Q4: é”è¿‡æœŸä½†ä¸šåŠ¡æœªå®Œæˆæ€ä¹ˆåŠï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
é—®é¢˜åœºæ™¯ï¼š
  Time: 0s   â†’ Client A åŠ é”ï¼ˆTTL=10sï¼‰
  Time: 12s  â†’ é”è‡ªåŠ¨è¿‡æœŸ
  Time: 12s  â†’ Client B åŠ é”æˆåŠŸ
  Time: 13s  â†’ Client A å®Œæˆä¸šåŠ¡ï¼Œè¯¯åˆ Bçš„é”

è§£å†³æ–¹æ¡ˆï¼š

æ–¹æ¡ˆ1ï¼šçœ‹é—¨ç‹—è‡ªåŠ¨ç»­æœŸï¼ˆæ¨èï¼‰
  - åå°çº¿ç¨‹æ¯éš”TTL/3ç»­æœŸä¸€æ¬¡
  - ä¸šåŠ¡å®Œæˆæ—¶åœæ­¢çœ‹é—¨ç‹—
  - Redissonå†…ç½®è¯¥æœºåˆ¶

æ–¹æ¡ˆ2ï¼šè®¾ç½®åˆç†çš„TTL
  - TTL = ä¸šåŠ¡æœ€å¤§è€—æ—¶ Ã— 2
  - è®°å½•è¶…æ—¶å‘Šè­¦

æ–¹æ¡ˆ3ï¼šUUIDé˜²è¯¯åˆ ï¼ˆå¿…é¡»ï¼‰
  - è§£é”æ—¶éªŒè¯value
  - å³ä½¿è¿‡æœŸä¹Ÿä¸ä¼šè¯¯åˆ 
```

**è¿½é—®ï¼šçœ‹é—¨ç‹—çº¿ç¨‹å´©æºƒäº†æ€ä¹ˆåŠï¼Ÿ**
```
ç­”ï¼šé”ä¼šè‡ªåŠ¨è¿‡æœŸé‡Šæ”¾
- è¿™æ˜¯é˜²æ­»é”æœºåˆ¶çš„ä½“ç°
- ä¸šåŠ¡éœ€è¦è€ƒè™‘å¹‚ç­‰æ€§
```

#### Q5: ä¸»èŠ‚ç‚¹å®•æœºå¯¼è‡´é”ä¸¢å¤±æ€ä¹ˆåŠï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
é—®é¢˜æ ¹æºï¼šRedisä¸»ä»å¤åˆ¶æ˜¯å¼‚æ­¥çš„

åœºæ™¯ï¼š
  1. Client A å‘ä¸»èŠ‚ç‚¹åŠ é”
  2. ä¸»èŠ‚ç‚¹å®•æœºï¼ˆæœªåŒæ­¥åˆ°ä»èŠ‚ç‚¹ï¼‰
  3. ä»èŠ‚ç‚¹å‡çº§ä¸ºä¸»èŠ‚ç‚¹ï¼ˆæ— é”è®°å½•ï¼‰
  4. Client B åŠ é”æˆåŠŸ
  5. Aå’ŒBåŒæ—¶æŒæœ‰é” âŒ

è§£å†³æ–¹æ¡ˆï¼š

æ–¹æ¡ˆ1ï¼šRedlockç®—æ³•ï¼ˆæ¨èï¼‰
  - éƒ¨ç½²Nä¸ªç‹¬ç«‹Redisï¼ˆéä¸»ä»ï¼‰
  - å‘æ‰€æœ‰å®ä¾‹è¯·æ±‚åŠ é”
  - è¶…è¿‡åŠæ•°æˆåŠŸæ‰ç®—æˆåŠŸ
  - å®¹å¿N/2-1ä¸ªèŠ‚ç‚¹æ•…éšœ

æ–¹æ¡ˆ2ï¼šWAITå‘½ä»¤ï¼ˆRedis 3.0+ï¼‰
  - jedis.waitReplicas(1, 1000)
  - ç­‰å¾…è‡³å°‘1ä¸ªä»èŠ‚ç‚¹åŒæ­¥å®Œæˆ
  - ç‰ºç‰²æ€§èƒ½æ¢å–å¯é æ€§

æ–¹æ¡ˆ3ï¼šZookeeperï¼ˆå¼ºä¸€è‡´æ€§ï¼‰
  - ä½¿ç”¨CPç³»ç»Ÿæ›¿ä»£APç³»ç»Ÿ
  - å†™å…¥å¿…é¡»è¶…è¿‡åŠæ•°ç¡®è®¤
  - ä½†æ€§èƒ½è¾ƒä½ï¼ˆQPS 1ä¸‡ï¼‰

æ–¹æ¡ˆ4ï¼šä¸šåŠ¡è¡¥å¿ï¼ˆå®ç”¨ï¼‰
  - æ•°æ®åº“å”¯ä¸€ç´¢å¼•å…œåº•
  - ä¹è§‚é”ç‰ˆæœ¬å·
  - å®šæœŸå¯¹è´¦ä¿®å¤
```

**åŠ åˆ†ç‚¹ï¼š**
- ç†è§£CAPç†è®ºï¼ˆRedisæ˜¯APï¼ŒZKæ˜¯CPï¼‰
- çŸ¥é“Redlockçš„äº‰è®®ï¼ˆMartin Kleppmannçš„æ‰¹è¯„ï¼‰
- èƒ½ç»“åˆå®é™…ä¸šåŠ¡é€‰æ‹©æ–¹æ¡ˆ

#### Q6: å¦‚ä½•å®ç°å¯é‡å…¥é”ï¼Ÿ

è¯¦è§ `ReentrantDistributedLock.java` å®ç°

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
ä½¿ç”¨Hashç»“æ„è®°å½•é‡å…¥æ¬¡æ•°

æ•°æ®ç»“æ„ï¼š
  HSET lock_key {uuid:threadId} {count}

åŠ é”é€»è¾‘ï¼š
  if exists(key) and hexists(key, threadId) then
      hincrby(key, threadId, 1)  -- é‡å…¥æ¬¡æ•°+1
  elseif not exists(key) then
      hincrby(key, threadId, 1)  -- é¦–æ¬¡åŠ é”
      expire(key, ttl)
  else
      return false  -- è¢«å…¶ä»–çº¿ç¨‹æŒæœ‰
  end

è§£é”é€»è¾‘ï¼š
  local count = hincrby(key, threadId, -1)
  if count == 0 then
      del(key)  -- å®Œå…¨é‡Šæ”¾
  else
      expire(key, ttl)  -- è¿˜æœ‰é‡å…¥ï¼Œç»­æœŸ
  end
```

### 6.3 åœºæ™¯é¢˜

#### Q7: ç§’æ€åœºæ™¯å¦‚ä½•ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
åœºæ™¯ï¼š1000ä»¶å•†å“ï¼Œ10000äººæŠ¢è´­

æ–¹æ¡ˆ1ï¼šå•ä¸€é”ï¼ˆç®€å•ä½†æ€§èƒ½å·®ï¼‰
  String lockKey = "lock:stock:" + productId;
  if (lock.tryLock()) {
      int stock = getStock(productId);
      if (stock > 0) {
          decrStock(productId);
          createOrder();
      }
      lock.unlock();
  }

  é—®é¢˜ï¼šæ‰€æœ‰è¯·æ±‚ä¸²è¡Œï¼ŒQPSä½

æ–¹æ¡ˆ2ï¼šåˆ†æ®µé”ï¼ˆæ¨èï¼‰
  // å°†åº“å­˜åˆ†æˆ10æ®µï¼Œæ¯æ®µ100ä»¶
  int segment = random(0, 9);
  String lockKey = "lock:stock:" + productId + ":" + segment;

  ä¼˜åŠ¿ï¼šå¹¶å‘æå‡10å€

æ–¹æ¡ˆ3ï¼šæ— é”ï¼ˆæœ€ä¼˜ï¼‰
  // ç›´æ¥ä½¿ç”¨RedisåŸå­æ“ä½œ
  long stock = jedis.decr("stock:" + productId);
  if (stock >= 0) {
      createOrder();  // æˆåŠŸ
  } else {
      jedis.incr("stock:" + productId);  // å›æ»š
  }

  ä¼˜åŠ¿ï¼šæ€§èƒ½æœ€é«˜ï¼Œæ— é”å¼€é”€
```

**è¿½é—®ï¼šä¸ºä»€ä¹ˆåˆ†æ®µé”èƒ½æå‡æ€§èƒ½ï¼Ÿ**
```
ç­”ï¼šå‡å°‘é”ç«äº‰

å•ä¸€é”ï¼š
  10000ä¸ªè¯·æ±‚ â†’ äº‰æŠ¢1æŠŠé” â†’ ä¸²è¡Œæ‰§è¡Œ

åˆ†æ®µé”ï¼š
  10000ä¸ªè¯·æ±‚ â†’ åˆ†æ•£åˆ°10æŠŠé” â†’ 10å€å¹¶å‘

å‰æï¼šä¸šåŠ¡å…è®¸åˆ†æ®µï¼ˆå¦‚åº“å­˜å¯æ‹†åˆ†ï¼‰
```

#### Q8: åˆ†å¸ƒå¼å®šæ—¶ä»»åŠ¡å¦‚ä½•é˜²æ­¢é‡å¤æ‰§è¡Œï¼Ÿ

è¯¦è§ `LockCase2_ScheduledTask.java`

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
åœºæ™¯ï¼š3å°æœåŠ¡å™¨ï¼Œæ¯å¤©2ç‚¹æ‰§è¡Œæ•°æ®åŒæ­¥

å®ç°ï¼š
@Scheduled(cron = "0 0 2 * * ?")
public void syncTask() {
    String lockKey = "lock:task:sync";
    DistributedLock lock = new DistributedLock(jedis, lockKey, 3600);

    if (lock.tryLock()) {
        try {
            logger.info("å®ä¾‹{} è·å–é”ï¼Œå¼€å§‹æ‰§è¡Œ", instanceId);
            syncData();  // å¯èƒ½è€—æ—¶1å°æ—¶
        } finally {
            lock.unlock();
        }
    } else {
        logger.info("å®ä¾‹{} æœªè·å–é”ï¼Œè·³è¿‡", instanceId);
    }
}

å…³é”®ç‚¹ï¼š
1. é”çš„ç²’åº¦ï¼šä»»åŠ¡çº§åˆ«ï¼ˆä¸æ˜¯æ–¹æ³•çº§åˆ«ï¼‰
2. TTLè®¾ç½®ï¼šç•¥å¤§äºä»»åŠ¡è€—æ—¶
3. å¤±è´¥é‡è¯•ï¼šå…¶ä»–å®ä¾‹å¯æ¥ç®¡
```

### 6.4 å¯¹æ¯”é¢˜

#### Q9: Redisé” vs Zookeeperé”ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**

| ç»´åº¦ | Redis | Zookeeper |
|------|-------|-----------|
| **æ€§èƒ½** | é«˜ï¼ˆQPS 10ä¸‡+ï¼‰ | ä¸­ï¼ˆQPS 1ä¸‡ï¼‰ |
| **ä¸€è‡´æ€§** | æœ€ç»ˆä¸€è‡´ï¼ˆAPï¼‰ | å¼ºä¸€è‡´ï¼ˆCPï¼‰ |
| **å®ç°** | SET NX EX | ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ |
| **é”é‡Šæ”¾** | è¶…æ—¶è‡ªåŠ¨é‡Šæ”¾ | è¿æ¥æ–­å¼€è‡ªåŠ¨é‡Šæ”¾ |
| **å¯é æ€§** | ä¸»ä»å¼‚æ­¥ï¼Œå¯èƒ½ä¸¢é” | Paxosåè®®ï¼Œå¯é  |
| **å¤æ‚åº¦** | ç®€å•ï¼ˆå‡ è¡Œä»£ç ï¼‰ | å¤æ‚ï¼ˆéœ€ç†è§£ZKï¼‰ |
| **é€‚ç”¨åœºæ™¯** | é«˜å¹¶å‘ã€å…è®¸çŸ­æš‚ä¸ä¸€è‡´ | å¼ºä¸€è‡´æ€§è¦æ±‚ |

**é€‰æ‹©å»ºè®®ï¼š**
```
ä½¿ç”¨Redisï¼š
  - ç§’æ€ã€æŠ¢è´­
  - é™æµ
  - ç¼“å­˜æ›´æ–°
  - å¯¹ä¸€è‡´æ€§è¦æ±‚ä¸æç«¯

ä½¿ç”¨Zookeeperï¼š
  - åˆ†å¸ƒå¼åè°ƒ
  - é…ç½®ä¸­å¿ƒ
  - æœåŠ¡æ³¨å†Œå‘ç°
  - é‡‘èäº¤æ˜“ç­‰å¼ºä¸€è‡´åœºæ™¯

ä½¿ç”¨æ•°æ®åº“é”ï¼š
  - ä½å¹¶å‘åœºæ™¯
  - äº‹åŠ¡ç›¸å…³
  - å·²æœ‰æ•°æ®åº“è¿æ¥
```

#### Q10: Redisson vs è‡ªå·±å®ç°ï¼Ÿ

**æ ‡å‡†ç­”æ¡ˆï¼š**
```
Redissonä¼˜åŠ¿ï¼š
  1. å¼€ç®±å³ç”¨ï¼ŒåŠŸèƒ½å®Œå–„
  2. å†…ç½®çœ‹é—¨ç‹—æœºåˆ¶
  3. æ”¯æŒå¯é‡å…¥ã€å…¬å¹³é”ã€è¯»å†™é”
  4. æä¾›Redlockå®ç°
  5. è¿æ¥æ± ç®¡ç†
  6. ç”Ÿäº§çº§ç¨³å®šæ€§

è‡ªå·±å®ç°ä¼˜åŠ¿ï¼š
  1. è½»é‡çº§ï¼Œæ— é¢å¤–ä¾èµ–
  2. å¯å®šåˆ¶åŒ–
  3. ç†è§£åŸç†
  4. é¢è¯•åŠ åˆ†

å»ºè®®ï¼š
  - ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨Redisson
  - å­¦ä¹ ç ”ç©¶ï¼šè‡ªå·±å®ç°
  - é¢è¯•å‡†å¤‡ï¼šä¸¤è€…éƒ½è¦äº†è§£
```

---

## ä¸ƒã€æ€§èƒ½ä¼˜åŒ–

### 7.1 å‡å°‘é”ç²’åº¦

âŒ **ç²—ç²’åº¦é”ï¼š**
```java
// æ•´ä¸ªè®¢å•æµç¨‹åŠ é”
lock("order:lock");
validateUser();
checkStock();
deductStock();
createOrder();
sendNotification();
unlock();
```

âœ… **ç»†ç²’åº¦é”ï¼š**
```java
// åªåœ¨æ‰£å‡åº“å­˜æ—¶åŠ é”
validateUser();
checkStock();

lock("stock:" + productId);
deductStock();
unlock();

createOrder();
sendNotification();
```

**æ€§èƒ½æå‡ï¼š** é”æŒæœ‰æ—¶é—´ä»5ç§’é™åˆ°0.1ç§’ï¼Œååé‡æå‡50å€

### 7.2 åˆ†æ®µé”

è¯¦è§ `LockCase4_SegmentLock.java`

### 7.3 é”é™çº§

```java
// å…ˆå°è¯•Redisé”ï¼Œå¤±è´¥åˆ™é™çº§åˆ°æœ¬åœ°é”
if (distributedLock.tryLock()) {
    // åˆ†å¸ƒå¼é”æˆåŠŸ
} else {
    // é™çº§åˆ°æœ¬åœ°é”ï¼ˆä»…å•æœºäº’æ–¥ï¼‰
    synchronized (this) {
        // ä¸šåŠ¡é€»è¾‘
    }
}
```

### 7.4 æ‰¹é‡åŠ é”

```java
// ä½¿ç”¨Pipelineæ‰¹é‡æ“ä½œ
Pipeline pipeline = jedis.pipelined();
Response<String> r1 = pipeline.set(key1, val1, SetParams.setParams().nx().ex(10));
Response<String> r2 = pipeline.set(key2, val2, SetParams.setParams().nx().ex(10));
pipeline.sync();

boolean success = "OK".equals(r1.get()) && "OK".equals(r2.get());
```

---

## å…«ã€æœ€ä½³å®è·µ

### 8.1 å‘½åè§„èŒƒ

```java
// æ¨èæ ¼å¼ï¼šä¸šåŠ¡:èµ„æºç±»å‹:èµ„æºID
lock:order:123456
lock:stock:product_789
lock:task:sync_data

// é¿å…ï¼š
mylock
order_lock
lock123
```

### 8.2 TTLè®¾ç½®

```java
// è¯„ä¼°ä¸šåŠ¡æœ€å¤§è€—æ—¶
long maxBusinessTime = 5000;  // 5ç§’

// TTL = 2å€ä¸šåŠ¡æ—¶é—´
int lockTTL = (int) (maxBusinessTime / 1000 * 2);  // 10ç§’

// å¯åŠ¨çœ‹é—¨ç‹—ï¼ˆRedissonè‡ªåŠ¨ï¼‰
```

### 8.3 å¼‚å¸¸å¤„ç†

```java
DistributedLock lock = new DistributedLock(jedis, lockKey, 10);
Thread watchDog = null;

try {
    if (lock.tryLock()) {
        watchDog = lock.startWatchDog();

        try {
            // ä¸šåŠ¡é€»è¾‘
            doBusinessLogic();
        } finally {
            // ç¡®ä¿é‡Šæ”¾é”
            lock.unlock();
        }
    } else {
        // è·å–é”å¤±è´¥çš„å¤„ç†
        throw new BizException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
} finally {
    // åœæ­¢çœ‹é—¨ç‹—
    if (watchDog != null) {
        watchDog.interrupt();
    }
}
```

### 8.4 ç›‘æ§å‘Šè­¦

```java
// è®°å½•é”çš„æŒæœ‰æ—¶é—´
long startTime = System.currentTimeMillis();
try {
    if (lock.tryLock()) {
        // ä¸šåŠ¡é€»è¾‘
    }
} finally {
    long holdTime = System.currentTimeMillis() - startTime;

    // è¶…è¿‡é˜ˆå€¼å‘Šè­¦
    if (holdTime > 5000) {
        logger.warn("é”æŒæœ‰æ—¶é—´è¿‡é•¿: {}ms, key: {}", holdTime, lockKey);
        metrics.recordLockHoldTime(lockKey, holdTime);
    }

    lock.unlock();
}
```

---

## ä¹ã€å¸¸è§é™·é˜±

### 9.1 é™·é˜±1ï¼šå¿˜è®°è®¾ç½®è¿‡æœŸæ—¶é—´

âŒ **é”™è¯¯ä»£ç ï¼š**
```java
jedis.setnx(lockKey, value);  // æ²¡æœ‰EX
```

**åæœï¼š** æ­»é”ï¼Œé”æ°¸ä¸é‡Šæ”¾

### 9.2 é™·é˜±2ï¼šåœ¨finallyå¤–è§£é”

âŒ **é”™è¯¯ä»£ç ï¼š**
```java
if (lock.tryLock()) {
    doBusinessLogic();
    lock.unlock();  // å¦‚æœå¼‚å¸¸ï¼Œé”ä¸ä¼šé‡Šæ”¾
}
```

âœ… **æ­£ç¡®ä»£ç ï¼š**
```java
if (lock.tryLock()) {
    try {
        doBusinessLogic();
    } finally {
        lock.unlock();  // ç¡®ä¿é‡Šæ”¾
    }
}
```

### 9.3 é™·é˜±3ï¼šé”çš„ç²’åº¦è¿‡å¤§

âŒ **é”™è¯¯è®¾è®¡ï¼š**
```java
lock("global_lock");  // æ‰€æœ‰è®¢å•å…±ç”¨ä¸€æŠŠé”
createOrder(orderId);
unlock();
```

âœ… **æ­£ç¡®è®¾è®¡ï¼š**
```java
lock("order:" + userId);  // æ¯ä¸ªç”¨æˆ·ä¸€æŠŠé”
createOrder(orderId);
unlock();
```

### 9.4 é™·é˜±4ï¼šå¾ªç¯é‡è¯•è€—å°½è¿æ¥æ± 

âŒ **é”™è¯¯ä»£ç ï¼š**
```java
while (true) {
    Jedis jedis = new Jedis();  // æ¯æ¬¡åˆ›å»ºæ–°è¿æ¥
    if (tryLock(jedis)) break;
    Thread.sleep(100);
}
```

âœ… **æ­£ç¡®ä»£ç ï¼š**
```java
try (Jedis jedis = pool.getResource()) {  // å¤ç”¨è¿æ¥æ± 
    while (true) {
        if (tryLock(jedis)) break;
        Thread.sleep(100);
    }
}
```

### 9.5 é™·é˜±5ï¼šä¸»ä»åˆ‡æ¢ä¸¢é”

**åœºæ™¯ï¼š** ä¾èµ–Redisä¸»ä»æ¶æ„ï¼Œæœªä½¿ç”¨Redlock

**åæœï¼š** ä¸»èŠ‚ç‚¹å®•æœºæ—¶å¯èƒ½å‡ºç°åŒå†™

**è§£å†³ï¼š** ä½¿ç”¨Redlockæˆ–ä¸šåŠ¡å…œåº•ï¼ˆæ•°æ®åº“å”¯ä¸€ç´¢å¼•ï¼‰

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **åŸºç¡€å®ç°ï¼š** SET NX EX + Luaè„šæœ¬
2. **çœ‹é—¨ç‹—ï¼š** è§£å†³é”è¿‡æœŸé—®é¢˜
3. **å¯é‡å…¥ï¼š** ä½¿ç”¨Hashç»“æ„
4. **é«˜å¯ç”¨ï¼š** Redlockç®—æ³•
5. **æ€§èƒ½ä¼˜åŒ–ï¼š** åˆ†æ®µé”ã€å‡å°ç²’åº¦

### å­¦ä¹ è·¯å¾„

```
åˆçº§ï¼šç†è§£SET NX EXåŸç†
ä¸­çº§ï¼šå®ç°çœ‹é—¨ç‹—æœºåˆ¶
é«˜çº§ï¼šæŒæ¡Redlockç®—æ³•
ä¸“å®¶ï¼šç»“åˆä¸šåŠ¡åœºæ™¯ä¼˜åŒ–
```

### æ¨èèµ„æº

- **å®˜æ–¹æ–‡æ¡£ï¼š** https://redis.io/docs/manual/patterns/distributed-locks/
- **Redlockè®ºæ–‡ï¼š** https://redis.io/docs/reference/patterns/distributed-locks/
- **äº‰è®®æ–‡ç« ï¼š** Martin Kleppmannçš„æ‰¹è¯„
- **å¼€æºé¡¹ç›®ï¼š** Redissonæºç 

---

**ä¸‹ä¸€æ­¥ï¼š** æŸ¥çœ‹å®Œæ•´ä»£ç å®ç°
- `RedLockDistributedLock.java` - Redlockå®ç°
- `ReentrantDistributedLock.java` - å¯é‡å…¥é”å®ç°
- `LockCase*.java` - å®æˆ˜æ¡ˆä¾‹

**ç¥å­¦ä¹ æ„‰å¿«ï¼** ğŸš€
