# 我在周五下午5点把生产环境搞崩了

## 推文内容

永远记住那个下午 😱

时间：周五 17:03
行为：合并PR
结果：整个系统宕机
影响：10万用户
心情：💀

**事故经过：**

17:00 - 我合并了一个"小改动"
17:03 - Slack炸了
17:05 - 数据库CPU 100%
17:07 - 服务全部超时
17:10 - 紧急回滚
17:25 - 系统恢复

惊心动魄的25分钟

**我改了什么？**

一行代码：

```javascript
// 修改前
const users = await db.users
  .find({ status: 'active' })
  .limit(100)

// 修改后
const users = await db.users
  .find({ status: 'active' })
// 忘记加limit了！
```

结果：
查询10万条数据
数据库直接跪了

**为什么会犯这个错？**

1. 太自信
"就改一行，不会有问题"

2. 没跑完整测试
测试数据库只有100条
生产有10万条

3. 周五下午
脑子想着周末了

**Slack的画风：**

17:03
QA："网站打不开了"
17:04
PM："客户在投诉"
17:05
CEO："怎么回事？"
17:06
CTO："快回滚！！！"

我："💦💦💦"

**回滚过程：**

问题：
直接回滚代码也不行
因为已经有新数据写入

解决：
1. 切流量到备用服务器
2. 修复查询加limit
3. 重新部署
4. 逐步切回流量
5. 监控数据

手抖打命令

**事后复盘会：**

CTO问："为什么会发生？"

我的5个错误：
1. 没有Code Review
2. 测试环境数据不够
3. 没有性能测试
4. 周五下午部署（大忌）
5. 改动虽小，影响面没评估

**建立的新规范：**

1. 禁止周五15点后部署
周末出问题找不到人

2. 所有PR必须review
哪怕一行代码

3. 测试数据量要接近生产
100条测不出10万条的问题

4. 关键查询必须有limit
防御性编程

5. 部署前checklist
- 跑完所有测试 ✓
- Performance测试 ✓
- 监控就位 ✓
- 回滚方案 ✓

**学到的教训：**

技术层面：
- 永远不要相信数据量"不会太大"
- 数据库查询必须加保护
- 测试环境要尽量接近生产

管理层面：
- 小改动也可能大影响
- 周五部署 = 周末加班
- 部署需要流程，不能随意

心态层面：
- 再简单的事也要认真对待
- 过度自信是Bug之源
- 保持谦卑

**现在的我：**

每次部署前：
- 深呼吸三次
- 过一遍checklist
- 确认回滚方案
- 告诉团队"我要部署了"

周五下午：
打死我也不部署 😂

**给新手开发的建议：**

犯错不可怕
可怕的是：
1. 不承认
2. 不复盘
3. 再犯同样的错

这次事故：
- 我写了事故报告
- 做了团队分享
- 完善了流程

把坏事变成财富

**金句：**

"There are two types of developers:
Those who have broken production,
and those who will."

生产事故，每个开发者的必经之路

你有过类似经历吗？

---

## 标签
#生产事故 #Debug #开发经验 #编程故事

## 发布建议
- 周五下午发布（应景）
- 配图：事故时间线
