# 分布式事务开源方案详解

## 1. Seata

### 1.1 简介

Seata (Simple Extensible Autonomous Transaction Architecture) 是阿里巴巴开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。

**官方网站**：https://seata.io/
**GitHub**：https://github.com/seata/seata
**Star 数**：25,000+
**License**：Apache 2.0

### 1.2 核心特性

#### 1.2.1 支持多种事务模式

**AT 模式 (Automatic Transaction)**：
- 自动补偿模式
- 基于本地 ACID 事务
- 对业务侵入小
- 适合大多数场景

**TCC 模式 (Try-Confirm-Cancel)**：
- 手动补偿模式
- 需要实现 Try、Confirm、Cancel 接口
- 性能好，灵活性高
- 适合对性能要求高的场景

**Saga 模式**：
- 长事务模式
- 基于状态机
- 支持复杂的业务流程
- 适合长事务场景

**XA 模式**：
- 基于 XA 协议
- 强一致性
- 性能相对较低
- 适合对一致性要求极高的场景

#### 1.2.2 架构组件

**TC (Transaction Coordinator)**：
- 事务协调器
- 维护全局事务和分支事务的状态
- 驱动全局事务提交或回滚

**TM (Transaction Manager)**：
- 事务管理器
- 定义全局事务的范围
- 开启、提交、回滚全局事务

**RM (Resource Manager)**：
- 资源管理器
- 管理分支事务的资源
- 与 TC 通信，注册分支事务、报告分支事务状态

### 1.3 快速开始

#### 1.3.1 添加依赖

```xml
<dependency>
    <groupId>io.seata</groupId>
    <artifactId>seata-spring-boot-starter</artifactId>
    <version>2.0.0</version>
</dependency>
```

#### 1.3.2 配置文件

```yaml
seata:
  enabled: true
  application-id: order-service
  tx-service-group: my_test_tx_group
  registry:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: ""
      group: SEATA_GROUP
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8848
      namespace: ""
      group: SEATA_GROUP
```

#### 1.3.3 使用示例

```java
@Service
public class OrderService {

    @Autowired
    private OrderRepository orderRepository;

    @Autowired
    private StockService stockService;

    @Autowired
    private AccountService accountService;

    @GlobalTransactional(name = "create-order", rollbackFor = Exception.class)
    public void createOrder(Order order) {
        // 1. 创建订单
        orderRepository.save(order);

        // 2. 扣减库存
        stockService.decrease(order.getProductId(), order.getQuantity());

        // 3. 扣减余额
        accountService.decrease(order.getUserId(), order.getAmount());
    }
}
```

### 1.4 优缺点

**优点**：
- 支持多种事务模式，灵活性高
- AT 模式对业务侵入小
- 性能好，支持高并发
- 社区活跃，文档完善
- 支持多种注册中心和配置中心
- 支持多种数据库

**缺点**：
- 需要部署 TC 服务
- AT 模式依赖数据库的本地事务
- 学习曲线较陡
- 需要修改数据库表结构（AT 模式）

### 1.5 适用场景

- 微服务架构
- 需要高性能的分布式事务
- 对业务侵入要求低
- 需要支持多种事务模式

### 1.6 生产案例

- 阿里巴巴：淘宝、天猫、支付宝
- 字节跳动：电商、支付
- 美团：订单、配送
- 滴滴：订单、结算

## 2. Apache ShardingSphere

### 2.1 简介

Apache ShardingSphere 是一套开源的分布式数据库中间件解决方案，提供了分库分表、读写分离、分布式事务等功能。

**官方网站**：https://shardingsphere.apache.org/
**GitHub**：https://github.com/apache/shardingsphere
**Star 数**：19,000+
**License**：Apache 2.0

### 2.2 核心特性

#### 2.2.1 分布式事务支持

**本地事务**：
- 基于数据库的本地事务
- 性能好
- 不支持跨库事务

**XA 事务**：
- 基于 XA 协议
- 强一致性
- 性能相对较低

**柔性事务**：
- 基于 Saga 模式
- 最终一致性
- 性能好

#### 2.2.2 分库分表

**水平拆分**：
- 按照某个字段将数据分散到多个数据库
- 提高性能和可扩展性

**垂直拆分**：
- 按照业务将表拆分到不同的数据库
- 降低耦合

**读写分离**：
- 读操作访问从库
- 写操作访问主库
- 提高性能

### 2.3 快速开始

#### 2.3.1 添加依赖

```xml
<dependency>
    <groupId>org.apache.shardingsphere</groupId>
    <artifactId>shardingsphere-jdbc-core-spring-boot-starter</artifactId>
    <version>5.4.0</version>
</dependency>
```

#### 2.3.2 配置文件

```yaml
spring:
  shardingsphere:
    datasource:
      names: ds0,ds1
      ds0:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/ds0
        username: root
        password: root
      ds1:
        type: com.zaxxer.hikari.HikariDataSource
        driver-class-name: com.mysql.cj.jdbc.Driver
        jdbc-url: jdbc:mysql://localhost:3306/ds1
        username: root
        password: root
    rules:
      sharding:
        tables:
          t_order:
            actual-data-nodes: ds$->{0..1}.t_order_$->{0..1}
            table-strategy:
              standard:
                sharding-column: order_id
                sharding-algorithm-name: order-inline
        sharding-algorithms:
          order-inline:
            type: INLINE
            props:
              algorithm-expression: t_order_$->{order_id % 2}
      transaction:
        default-type: XA
        provider-type: Atomikos
```

### 2.4 优缺点

**优点**：
- 与分库分表功能集成
- 支持多种数据库
- 配置灵活
- Apache 顶级项目，社区活跃

**缺点**：
- 主要用于分库分表场景
- XA 模式性能相对较低
- 学习曲线较陡

### 2.5 适用场景

- 分库分表场景
- 需要强一致性的分布式事务
- 需要读写分离
- 数据量大，需要水平扩展

## 3. ByteTCC

### 3.1 简介

ByteTCC 是一个基于 TCC 模式的分布式事务框架，专注于提供高性能的 TCC 事务支持。

**GitHub**：https://github.com/liuyangming/ByteTCC
**Star 数**：3,000+
**License**：Apache 2.0

### 3.2 核心特性

- 专注于 TCC 模式
- 支持 Dubbo、Spring Cloud
- 性能好
- 实现简洁

### 3.3 快速开始

#### 3.3.1 添加依赖

```xml
<dependency>
    <groupId>org.bytesoft</groupId>
    <artifactId>bytetcc-supports-springcloud</artifactId>
    <version>0.5.0</version>
</dependency>
```

#### 3.3.2 使用示例

```java
@Service
public class AccountService {

    @Compensable(
        confirmableKey = "accountServiceConfirm",
        cancellableKey = "accountServiceCancel"
    )
    public void decrease(Long userId, BigDecimal amount) {
        // Try 阶段：冻结金额
        accountRepository.freeze(userId, amount);
    }

    @Confirm
    public void accountServiceConfirm(Long userId, BigDecimal amount) {
        // Confirm 阶段：扣减金额
        accountRepository.decrease(userId, amount);
    }

    @Cancel
    public void accountServiceCancel(Long userId, BigDecimal amount) {
        // Cancel 阶段：解冻金额
        accountRepository.unfreeze(userId, amount);
    }
}
```

### 3.4 优缺点

**优点**：
- 专注于 TCC，实现简洁
- 性能好
- 支持主流微服务框架

**缺点**：
- 只支持 TCC 模式
- 社区相对较小
- 文档相对较少

### 3.5 适用场景

- 需要 TCC 模式的场景
- 对性能要求高
- 使用 Dubbo 或 Spring Cloud

## 4. Hmily

### 4.1 简介

Hmily 是一个高性能的分布式事务框架，支持 TCC 和 TAC 模式。

**官方网站**：https://dromara.org/zh/projects/hmily/
**GitHub**：https://github.com/dromara/hmily
**Star 数**：4,000+
**License**：Apache 2.0

### 4.2 核心特性

- 支持 TCC 和 TAC 模式
- 支持 Dubbo、Spring Cloud、gRPC、Motan、Sofa-RPC
- 性能好，对业务侵入小
- 配置简单

### 4.3 快速开始

#### 4.3.1 添加依赖

```xml
<dependency>
    <groupId>org.dromara</groupId>
    <artifactId>hmily-spring-boot-starter-springcloud</artifactId>
    <version>2.1.1</version>
</dependency>
```

#### 4.3.2 配置文件

```yaml
hmily:
  server:
    config-mode: local
    app-name: order-service
  config:
    type: local
    local:
      path: /hmily
      filename: hmily.properties
```

#### 4.3.3 使用示例

```java
@Service
public class OrderService {

    @HmilyTCC(confirmMethod = "confirmOrder", cancelMethod = "cancelOrder")
    public void createOrder(Order order) {
        // Try 阶段
        orderRepository.save(order);
    }

    public void confirmOrder(Order order) {
        // Confirm 阶段
        orderRepository.updateStatus(order.getId(), OrderStatus.CONFIRMED);
    }

    public void cancelOrder(Order order) {
        // Cancel 阶段
        orderRepository.updateStatus(order.getId(), OrderStatus.CANCELLED);
    }
}
```

### 4.4 优缺点

**优点**：
- 支持多种 RPC 框架
- 性能好
- 配置简单
- 支持多种存储方式

**缺点**：
- 社区相对较小
- 文档相对较少
- 只支持 TCC 和 TAC 模式

### 4.5 适用场景

- 需要 TCC 模式的场景
- 使用 Dubbo、Spring Cloud、gRPC 等 RPC 框架
- 对性能要求高

## 5. Eventuate Tram

### 5.1 简介

Eventuate Tram 是一个基于事件驱动的微服务框架，支持 Saga 模式的分布式事务。

**官方网站**：https://eventuate.io/
**GitHub**：https://github.com/eventuate-tram/eventuate-tram-core
**Star 数**：1,000+
**License**：Apache 2.0

### 5.2 核心特性

- 支持 Saga 编排和协调
- 基于事件驱动
- 支持多种消息队列
- 与 Spring Boot 集成

### 5.3 快速开始

#### 5.3.1 添加依赖

```xml
<dependency>
    <groupId>io.eventuate.tram.core</groupId>
    <artifactId>eventuate-tram-spring-boot-starter</artifactId>
    <version>0.30.0</version>
</dependency>
```

#### 5.3.2 使用示例

```java
@Service
public class OrderSaga {

    private SagaDefinition<CreateOrderSagaData> sagaDefinition;

    public OrderSaga() {
        this.sagaDefinition = step()
            .invokeLocal(this::createOrder)
            .withCompensation(this::cancelOrder)
            .step()
            .invokeParticipant(this::reserveStock)
            .step()
            .invokeParticipant(this::decreaseAccount)
            .build();
    }

    private void createOrder(CreateOrderSagaData data) {
        // 创建订单
    }

    private void cancelOrder(CreateOrderSagaData data) {
        // 取消订单
    }

    private CommandWithDestination reserveStock(CreateOrderSagaData data) {
        // 预留库存
        return send(new ReserveStockCommand(...))
            .to("stockService")
            .build();
    }

    private CommandWithDestination decreaseAccount(CreateOrderSagaData data) {
        // 扣减余额
        return send(new DecreaseAccountCommand(...))
            .to("accountService")
            .build();
    }
}
```

### 5.4 优缺点

**优点**：
- 支持 Saga 编排和协调
- 基于事件驱动，解耦性好
- 与 Spring Boot 集成良好

**缺点**：
- 只支持 Saga 模式
- 社区相对较小
- 学习曲线较陡

### 5.5 适用场景

- 需要 Saga 模式的场景
- 事件驱动架构
- 长事务场景

## 6. 开源方案对比

### 6.1 功能对比

| 框架 | AT | TCC | Saga | XA | 其他 |
|------|----|----|------|----|----|
| Seata | ✓ | ✓ | ✓ | ✓ | - |
| ShardingSphere | ✗ | ✗ | ✓ | ✓ | - |
| ByteTCC | ✗ | ✓ | ✗ | ✗ | - |
| Hmily | ✗ | ✓ | ✗ | ✗ | TAC |
| Eventuate Tram | ✗ | ✗ | ✓ | ✗ | - |

### 6.2 性能对比

| 框架 | TPS | 延迟 | 资源占用 |
|------|-----|------|---------|
| Seata (AT) | 高 | 低 | 中 |
| Seata (TCC) | 很高 | 很低 | 低 |
| ShardingSphere (XA) | 中 | 高 | 高 |
| ByteTCC | 很高 | 很低 | 低 |
| Hmily | 很高 | 很低 | 低 |

### 6.3 易用性对比

| 框架 | 业务侵入 | 配置复杂度 | 学习曲线 | 文档质量 |
|------|---------|-----------|---------|---------|
| Seata (AT) | 低 | 中 | 中 | 高 |
| Seata (TCC) | 高 | 中 | 高 | 高 |
| ShardingSphere | 低 | 高 | 高 | 高 |
| ByteTCC | 高 | 低 | 中 | 中 |
| Hmily | 中 | 低 | 中 | 中 |

### 6.4 生态对比

| 框架 | 社区活跃度 | Star 数 | 企业用户 | 更新频率 |
|------|-----------|---------|---------|---------|
| Seata | 很高 | 25,000+ | 1,000+ | 高 |
| ShardingSphere | 高 | 19,000+ | 500+ | 高 |
| ByteTCC | 中 | 3,000+ | 100+ | 中 |
| Hmily | 中 | 4,000+ | 200+ | 中 |
| Eventuate Tram | 低 | 1,000+ | 50+ | 低 |

## 7. 选择建议

### 7.1 根据事务模式选择

- **需要 AT 模式**：Seata
- **需要 TCC 模式**：Seata、ByteTCC、Hmily
- **需要 Saga 模式**：Seata、ShardingSphere、Eventuate Tram
- **需要 XA 模式**：Seata、ShardingSphere
- **需要多种模式**：Seata

### 7.2 根据技术栈选择

- **Spring Cloud**：Seata、Hmily、ByteTCC
- **Dubbo**：Seata、Hmily、ByteTCC
- **gRPC**：Hmily
- **分库分表**：ShardingSphere

### 7.3 根据业务特点选择

- **对性能要求高**：Seata (TCC)、ByteTCC、Hmily
- **对业务侵入要求低**：Seata (AT)、ShardingSphere
- **长事务**：Seata (Saga)、Eventuate Tram
- **强一致性**：Seata (XA)、ShardingSphere (XA)

### 7.4 根据团队能力选择

- **团队经验丰富**：Seata (TCC)、ByteTCC
- **团队经验一般**：Seata (AT)、Hmily
- **团队经验较少**：Seata (AT)

## 8. 总结

分布式事务开源方案众多,各有特点。Seata 是目前最流行和功能最完善的方案，支持多种事务模式，适合大多数场景。ShardingSphere 适合分库分表场景。ByteTCC 和 Hmily 专注于 TCC 模式，性能好。Eventuate Tram 适合事件驱动架构。在选择时，需要根据业务特点、技术栈、团队能力等因素综合考虑。
