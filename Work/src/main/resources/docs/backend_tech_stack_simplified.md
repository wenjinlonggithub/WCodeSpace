# 互联网医院后端技术栈文档（精简版）

## 文档版本信息
- **版本号**：v1.0
- **更新时间**：2026-01-27
- **维护团队**：后端架构组
- **适用范围**：互联网医院全栈业务系统

---

## 目录

- [一、技术栈概览](#一技术栈概览)
- [二、基础技术层](#二基础技术层)
- [三、数据持久层](#三数据持久层)
- [四、中台服务层](#四中台服务层)
- [五、微服务体系架构](#五微服务体系架构)
- [六、服务治理](#六服务治理)
- [七、开发规范](#七开发规范)
- [八、数据库设计规范](#八数据库设计规范)
- [九、部署架构](#九部署架构)
- [十、技术选型总结](#十技术选型总结)
- [十一、常见问题FAQ](#十一常见问题faq)
- [十二、附录](#十二附录)

---

## 一、技术栈概览

### 1.1 架构风格
- **微服务架构**：基于Spring Cloud Alibaba生态构建分布式微服务体系
- **前后端分离**：RESTful API设计，支持多端接入
- **中台化设计**：支付、消息等通用能力中台化

### 1.2 核心技术组件

| 技术分类 | 技术选型 | 版本要求 | 用途说明 |
|---------|---------|---------|---------|
| 编程语言 | Java | JDK 11 | 核心开发语言 |
| 开发框架 | Spring Boot | 2.6.x+ | 微服务应用框架 |
| 服务调用 | OpenFeign | 3.1.x+ | 声明式HTTP客户端 |
| 注册中心 | Nacos | 2.1.x+ | 服务注册与发现 |
| 配置中心 | Nacos | 2.1.x+ | 动态配置管理 |
| 关系数据库 | MySQL | 8.0+ | 核心业务数据存储 |
| 对象存储 | 阿里云OSS | - | 文件、图片、视频存储 |
| 短信服务 | 腾讯云短信 | SDK 3.x | 验证码、通知短信 |
| 即时通讯 | 腾讯IM | SDK 5.x | IM聊天、音视频通话 |
| 物流服务 | 顺丰物流 | API v1.0 | 药品配送服务 |
| 物流追踪 | 快递100 | API v2.0 | 多渠道物流查询 |
| 消息推送 | 极光推送 | SDK 4.x | APP消息推送 |
| 支付中台 | 自研支付中台 | - | 统一支付接入 |

---

## 二、基础技术层

### 2.1 Java运行环境（JDK 11）

**版本选择理由**
- 长期支持版本（LTS），Oracle提供至2026年的支持
- 性能提升：G1 GC优化，启动速度提升
- 新特性：HTTP Client API、字符串增强、局部变量类型推断
- 稳定性：业界大规模应用验证

**JVM关键配置**
- 堆内存：4GB起步，根据业务量调整
- GC策略：使用G1垃圾收集器
- 监控：开启堆转储、GC日志记录

---

### 2.2 Spring Boot应用框架

**核心能力**
- 快速开发：自动配置、起步依赖
- Web开发：RESTful API、参数校验
- 数据访问：JPA、MyBatis-Plus集成
- 监控健康：Actuator健康检查端点

**关键依赖模块**
- spring-boot-starter-web：Web应用开发
- spring-boot-starter-data-jpa：数据访问
- spring-boot-starter-validation：参数校验
- spring-boot-starter-actuator：监控健康检查

---

### 2.3 OpenFeign服务调用

**功能特性**
- 声明式HTTP客户端：通过接口定义调用远程服务
- 负载均衡：集成Spring Cloud LoadBalancer
- 服务降级：支持Fallback降级处理
- 请求压缩：支持请求和响应压缩

**配置要点**
- 连接超时：5秒
- 读取超时：10秒
- 最大连接数：200
- 开启请求/响应压缩

---

### 2.4 Nacos服务治理

**双重功能**
- **注册中心**：服务注册与发现、健康检查、负载均衡
- **配置中心**：动态配置管理、配置热更新、多环境隔离

**服务注册核心配置**
- 命名空间：环境隔离（dev/test/prod）
- 分组：业务分组管理
- 元数据：版本号、区域等扩展信息
- 心跳检测：5秒间隔，15秒超时

**配置管理核心配置**
- 配置格式：YAML/Properties
- 共享配置：多服务共享MySQL、Redis等配置
- 扩展配置：服务专属配置
- 动态刷新：@RefreshScope注解支持

---

## 三、数据持久层

### 3.1 MySQL数据库

**版本与特性**
- MySQL 8.0.28+
- InnoDB存储引擎，支持事务ACID
- 行级锁，高并发支持
- MVCC多版本并发控制

**连接池配置（Druid）**
- 初始连接数：5
- 最小空闲连接：5
- 最大活跃连接：20
- 连接等待超时：60秒
- 开启SQL监控和防火墙

**数据访问层（MyBatis-Plus）**
- 自动CRUD操作
- 逻辑删除支持
- 分页插件
- 乐观锁插件

**数据库设计规范**
- 表名：小写字母+下划线
- 主键：BIGINT自增ID
- 时间字段：created_time、updated_time
- 逻辑删除：deleted字段
- 必要索引：主键、外键、查询条件

**高可用方案**
- 读写分离：主库写入，从库读取
- 主从复制：实时数据同步
- 分库分表：ShardingSphere按业务分片

---

## 四、中台服务层

### 4.1 支付中台

**架构设计**
- 统一支付接入：屏蔽各支付渠道差异
- 多渠道支持：微信、支付宝、医保
- 订单管理：支付订单全生命周期管理
- 对账管理：自动对账、差异处理

**核心功能**
- 创建支付订单
- 查询支付状态
- 申请退款
- 支付回调处理
- 定时对账任务

**支付渠道配置**
- 微信支付：APP ID、商户号、API密钥、证书
- 支付宝：APP ID、公私钥
- 医保支付：医保平台对接

---

### 4.2 腾讯云短信服务

**功能场景**
- 验证码短信：登录、注册、支付验证
- 通知短信：预约提醒、问诊通知、配送通知
- 营销短信：活动推广、健康资讯

**核心配置**
- Secret ID、Secret Key
- SDK APP ID
- 短信签名
- 模板ID管理

**限流控制**
- 单手机号每日上限：10条
- 单手机号每分钟上限：1条
- 基于Redis实现限流

---

### 4.3 阿里云OSS对象存储

**存储场景**
- 处方图片：电子处方图片存储
- 病历文件：用户健康档案
- 用户头像：个人头像图片
- 问诊图片：问诊过程中上传的图片

**核心配置**
- Endpoint：OSS服务地址
- AccessKey：访问凭证
- Bucket：存储桶名称
- CDN加速：内容分发加速

**文件管理**
- 上传：支持表单上传、分片上传
- 下载：直接下载、生成临时URL
- 删除：支持单个和批量删除
- 访问控制：公共读/私有读

**文件限制**
- 最大文件大小：10MB
- 允许扩展名：jpg、jpeg、png、pdf、doc、docx

---

### 4.4 腾讯IM音视频服务

**功能场景**
- 图文问诊：文字、图片消息实时传输
- 视频问诊：医患视频通话
- 语音问诊：语音通话功能
- 消息推送：离线消息、消息提醒

**核心配置**
- SDK APP ID：腾讯云应用标识
- Secret Key：密钥配置
- 账号体系：集成用户系统
- 音视频参数：编码格式、分辨率、码率

**集成能力**
- 单聊：一对一医患沟通
- 群聊：多人会诊场景
- 音视频通话：实时通话
- 历史消息：消息记录存储

---

### 4.5 物流配送服务

#### 4.5.1 顺丰物流

**核心功能**
- 下单接口：创建快递订单
- 路由查询：实时物流轨迹
- 签收确认：配送完成确认
- 取消订单：订单取消接口

**配置信息**
- 客户编码：顺丰分配的客户ID
- 密钥：API调用密钥
- 月结卡号：结算账号
- 服务类型：标准快递、医药专送

#### 4.5.2 快递100

**核心功能**
- 多渠道查询：支持100+快递公司
- 智能识别：自动识别快递公司
- 订阅推送：物流状态变更推送
- 查询接口：统一查询API

**配置信息**
- APP KEY：应用密钥
- Customer：客户账号
- 接口授权：查询权限配置

---

### 4.6 极光推送服务

**推送场景**
- 问诊通知：医生接诊、问诊结果
- 订单通知：支付成功、发货提醒
- 处方通知：处方审核、药品发货
- 营销推送：活动通知、健康资讯

**核心配置**
- APP KEY：应用标识
- Master Secret：主密钥
- 推送平台：iOS、Android
- 推送环境：开发环境、生产环境

**推送类型**
- 通知栏消息：系统级通知
- 透传消息：应用内消息
- 富媒体推送：图片、链接等

---

### 4.7 监管平台对接

#### 4.7.1 天津监管平台

**上报内容**
- 机构信息：医疗机构资质信息
- 医生信息：执业医师资质
- 问诊记录：问诊过程记录
- 处方信息：电子处方数据
- 药品配送：药品流转信息

**上报方式**
- 接口类型：WebService/RESTful API
- 上报频率：实时上报或定时批量
- 数据格式：XML/JSON
- 加密方式：数字签名、HTTPS

#### 4.7.2 北京监管平台

**上报内容**
- 互联网医院备案信息
- 医疗服务行为记录
- 电子处方流转数据
- 远程医疗服务记录
- 患者就诊信息

**上报方式**
- 接口协议：符合北京市标准
- 数据标准：遵循北京市规范
- 上报时效：24小时内上报
- 数据安全：加密传输、存储

#### 4.7.3 HIS系统对接

**对接能力**
- 患者信息同步：患者基本信息、就诊历史
- 电子病历获取：历史病历、检查报告
- 处方同步：线下处方数据同步
- 费用查询：医疗费用明细
- 预约挂号：线上预约对接

**对接方式**
- 接口类型：HL7、DICOM等标准协议
- 数据映射：字段映射、数据转换
- 数据同步：实时同步或定时同步
- 安全机制：VPN专线、数据加密

---

## 五、微服务体系架构

### 5.1 整体架构分层

```
┌──────────────────────────────────────────────────────────┐
│                    外部接入体系                            │
│  天津监管 | 北京监管 | HIS系统 | 腾讯IM音视频              │
│  顺丰物流 | 快递100 | 极光推送                             │
└──────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────┐
│                    业务应用层                              │
│  问诊 | 处方 | 订单 | 药品 | 物流 | 检验 | 慢病管理         │
└──────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────┐
│                    中台服务层                              │
│  支付中台 | 订单中台 | 退款中台 | 药品主数据中台            │
│  SaaS中台（调研问卷 | 病例审批）                           │
└──────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────┐
│                  基础设施层                                │
│  统一网关 | 配置中心 | 注册中心 | 数据库 | 对象存储         │
└──────────────────────────────────────────────────────────┘
```

---

### 5.2 外部接入层服务（7个）

| 服务名称 | 端口 | 核心功能 |
|---------|------|---------|
| 天津监管平台上报 | 8081 | 天津市互联网医院监管数据上报、医疗行为监控 |
| 北京监管平台上报 | 8082 | 北京市互联网医院监管数据上报、处方流转上报 |
| HIS系统对接 | 8083 | 对接医院HIS系统、患者信息同步、电子病历获取 |
| 腾讯IM音视频 | 8084 | 实时音视频通话、IM即时通讯、视频问诊 |
| 顺丰物流 | 8085 | 药品配送、物流轨迹查询、签收管理 |
| 快递100 | 8086 | 多家快递物流轨迹追踪、配送状态查询 |
| 极光推送 | 8087 | APP消息推送、系统通知、问诊提醒 |

---

### 5.3 业务应用层核心服务

| 服务名称 | 服务标识 | 端口 | 核心职责 |
|---------|---------|------|---------|
| 网关服务 | gateway-service | 8080 | 统一入口、路由转发、鉴权限流 |
| 用户服务 | user-service | 8091 | 用户注册、登录、认证、个人信息 |
| 医生服务 | doctor-service | 8092 | 医生信息、排班管理、评价 |
| 问诊服务 | consultation-service | 8093 | 在线问诊、医患沟通 |
| 处方服务 | prescription-service | 8094 | 处方开具、审核、流转 |
| 订单服务 | order-service | 8095 | 订单创建、支付、退款 |
| 药品服务 | medicine-service | 8096 | 药品目录、库存、价格 |
| 检验服务 | lab-test-service | 8097 | 检验预约、报告管理 |
| 病历服务 | medical-record-service | 8098 | 健康档案、病历管理 |

---

### 5.4 中台服务层

#### 5.4.1 业务中台（4大能力）

| 中台能力 | 服务标识 | 说明 |
|---------|---------|------|
| 支付中台 | payment-platform-service | 统一支付接入（微信、支付宝、医保） |
| 订单中台 | order-platform-service | 订单全生命周期管理、订单状态流转 |
| 退款中台 | refund-platform-service | 退款申请、退款审核、退款处理 |
| 药品主数据中台 | medicine-master-data-service | 药品基础信息、药品目录、药品分类 |

**支付中台核心功能**
- 创建支付订单
- 查询支付状态
- 支付回调处理
- 多渠道支付接入
- 支付对账管理

**订单中台核心功能**
- 订单创建与管理
- 订单状态流转
- 订单查询与统计
- 订单关联处理

**退款中台核心功能**
- 退款申请提交
- 退款审核流程
- 退款金额计算
- 退款渠道处理
- 退款状态追踪

**药品主数据中台核心功能**
- 药品基础信息管理
- 药品目录维护
- 药品分类体系
- 药品规格管理
- 药品价格管理

#### 5.4.2 SaaS服务中台（2大模块）

| 模块 | 服务标识 | 功能 |
|------|---------|------|
| 调研问卷 | survey-service | 患者满意度调研、问卷设计、数据统计分析 |
| 病例审批 | case-approval-service | 病例提交、审批流程、审批记录、审批通知 |

**调研问卷模块**
- 问卷模板管理：创建、编辑、发布问卷
- 问卷发放：定向发放、批量发送
- 数据收集：问卷填写、数据存储
- 统计分析：结果统计、图表展示、数据导出

**病例审批模块**
- 病例提交：医生提交病例审批申请
- 审批流程：多级审批、会签机制
- 审批记录：审批历史、审批意见
- 消息通知：审批进度通知、结果推送

---

### 5.5 核心业务流程

#### 5.5.1 在线问诊完整流程（含外部服务）

```
1. 用户选择医生，创建问诊订单
   ↓
2. 调用支付中台完成支付
   ↓
3. 支付成功，订单确认
   ↓
4. 创建腾讯IM聊天室
   ↓
5. 通过腾讯云短信通知医生接诊
   ↓
6. 通过极光推送发送APP通知
   ↓
7. 医生接诊，开始问诊沟通（腾讯IM音视频）
   ↓
8. 医生开具处方，药师审核
   ↓
9. 处方审核通过，上传至监管平台（天津/北京）
   ↓
10. 创建药品配送订单
   ↓
11. 调用顺丰物流接口，创建快递单
   ↓
12. 通过快递100查询物流轨迹
   ↓
13. 物流配送中，短信+推送通知用户
   ↓
14. 用户签收，订单完成
   ↓
15. 问诊记录上报监管平台
   ↓
16. 用户评价，发放调研问卷
```

#### 5.5.2 医保支付流程

```
1. 用户选择医保支付
   ↓
2. 调用老保农服务进行实名认证
   ↓
3. 身份验证通过，费用预结算
   ↓
4. 获取医保支付金额和个人自付金额
   ↓
5. 组合支付（医保账户 + 个人支付）
   ↓
6. 支付成功，确认医保结算
   ↓
7. 订单完成
```

---

### 5.6 服务依赖关系

**关键依赖说明**
- 问诊服务依赖：用户、医生、订单、处方、腾讯IM、腾讯短信、极光推送、支付中台
- 处方服务依赖：用户、医生、问诊、订单、药品主数据、监管平台上报
- 订单服务依赖：用户、医生、问诊、处方、药品主数据、支付中台、退款中台
- 物流服务依赖：用户、处方、订单、顺丰物流、快递100、腾讯短信、极光推送
- 监管上报服务依赖：问诊、处方、订单、医生、患者信息
- HIS对接服务依赖：患者信息、病历、处方数据

**外部服务依赖**
- 腾讯IM：问诊服务的核心依赖
- 腾讯短信：通知类服务的依赖
- 极光推送：消息推送的依赖
- 顺丰物流：药品配送的核心依赖
- 快递100：物流追踪的依赖
- 监管平台：合规上报的依赖
- HIS系统：患者数据的依赖

---

## 六、服务治理

### 6.1 服务注册与发现（Nacos）

**注册配置**
- 服务名称：唯一标识服务
- 命名空间：环境隔离
- 分组：业务分组
- 元数据：版本、层级、类别等扩展信息
- 健康检查：心跳间隔5秒，超时15秒

**服务发现**
- 负载均衡：轮询、随机、权重等策略
- 健康实例筛选：只返回健康的服务实例
- 服务订阅：监听服务变化

---

### 6.2 配置管理（Nacos）

**配置类型**
- 服务专属配置：各服务独立的业务配置
- 共享配置：数据库、缓存等通用配置
- 扩展配置：消息队列、第三方服务等配置

**动态刷新**
- @RefreshScope：支持配置热更新
- 配置监听器：监听配置变更事件

---

### 6.3 API网关（Spring Cloud Gateway）

**核心功能**
- 路由转发：根据路径匹配转发到对应服务
- 鉴权认证：JWT令牌验证
- 限流熔断：防止服务过载
- 日志追踪：记录请求链路
- 统一异常处理：标准化错误响应

**路由配置**
- 路径匹配：/api/v1/consultation/** → consultation-service
- 负载均衡：lb://服务名
- 过滤器：限流、鉴权、日志等

---

## 七、开发规范

### 7.1 项目结构规范

```
service-name/
├── controller/         # 控制器层（接口定义）
├── service/           # 服务层（业务逻辑）
├── repository/        # 数据访问层（DAO）
├── feign/             # Feign客户端（远程调用）
├── model/             # 数据模型
│   ├── dto/          # 数据传输对象
│   ├── vo/           # 视图对象
│   └── request/      # 请求对象
├── common/            # 通用组件
│   ├── constant/     # 常量定义
│   ├── enums/        # 枚举类型
│   ├── exception/    # 异常定义
│   └── util/         # 工具类
└── config/            # 配置类
```

---

### 7.2 命名规范

**类命名**
- 控制器：UserController
- 服务类：UserService、UserServiceImpl
- 数据访问：UserMapper、UserRepository
- 实体类：User、ConsultationOrder

**方法命名**
- 查询：getById、findByName、queryList
- 新增：create、add、insert
- 修改：update、modify
- 删除：delete、remove

**常量命名**
- 全大写+下划线：MAX_RETRY_COUNT

---

### 7.3 接口设计规范

**RESTful风格**
- GET：查询资源
- POST：创建资源
- PUT：更新资源
- DELETE：删除资源

**URL设计**
- /api/v1/users：用户列表
- /api/v1/users/{id}：用户详情
- /api/v1/consultations：问诊列表

**统一响应格式**
```json
{
  "code": "SUCCESS",
  "message": "操作成功",
  "data": {},
  "timestamp": 1706342400000
}
```

---

### 7.4 日志规范

**日志级别**
- ERROR：系统异常（需要立即处理）
- WARN：业务异常（可预期的错误）
- INFO：关键业务流程
- DEBUG：详细调试信息

**日志内容**
- 关键参数：订单ID、用户ID等
- 业务操作：创建订单、支付成功等
- 异常信息：完整的异常堆栈

---

## 八、数据库设计规范

### 8.1 表设计规范

**命名规范**
- 表名：小写字母+下划线，如 consultation_order
- 字段名：小写字母+下划线，如 patient_id

**必备字段**
- id：主键，BIGINT AUTO_INCREMENT
- created_time：创建时间，DATETIME
- updated_time：更新时间，DATETIME
- deleted：逻辑删除，TINYINT(1)

**索引设计**
- 主键索引：id
- 唯一索引：业务唯一字段（如订单号）
- 普通索引：常用查询条件（如用户ID、时间）
- 复合索引：多字段组合查询

---

### 8.2 数据库规范

**字段类型选择**
- 整数：TINYINT、INT、BIGINT（根据数值范围）
- 字符串：VARCHAR（变长）、CHAR（定长）
- 金额：DECIMAL(10,2)
- 时间：DATETIME、TIMESTAMP
- 大文本：TEXT

**避免事项**
- 避免使用NULL：设置默认值
- 避免大字段：单独表存储或使用OSS
- 避免过度冗余：合理的反范式设计

---

## 九、部署架构

### 10.1 容器化部署（Docker）

**Docker镜像**
- 基础镜像：openjdk:11-jre-slim
- 工作目录：/app
- 端口暴露：8080-8099

**镜像构建**
- 多阶段构建：编译阶段+运行阶段
- 镜像分层：依赖层+应用层
- 镜像优化：减小镜像体积

---

### 10.2 容器编排（Kubernetes）

**核心资源**
- Deployment：服务部署
- Service：服务暴露
- ConfigMap：配置管理
- Secret：敏感信息管理

**部署策略**
- 副本数：根据流量调整（通常3个起步）
- 资源限制：CPU、内存限制
- 健康检查：存活探针、就绪探针
- 滚动更新：零停机部署

---

## 十、技术选型总结

### 11.1 选型对比

| 技术组件 | 优势 | 选择理由 |
|---------|------|---------|
| JDK 11 | LTS长期支持、性能优化、新特性 | 稳定可靠 |
| Spring Boot | 快速开发、生态完善、约定优于配置 | 行业标准 |
| Nacos | 注册+配置一体、性能优秀、功能丰富 | 阿里生态 |
| MySQL 8.0 | 稳定可靠、生态成熟、事务保障 | 数据一致性 |
| OpenFeign | 声明式调用、集成Spring Cloud | 简化开发 |

---

### 11.2 技术栈成熟度评估

| 组件 | 成熟度 | 社区活跃度 | 企业应用 |
|-----|-------|----------|---------|
| Spring Boot | ★★★★★ | 非常活跃 | 广泛应用 |
| Nacos | ★★★★☆ | 活跃 | 中大型企业 |
| MySQL | ★★★★★ | 非常活跃 | 全行业 |
| OpenFeign | ★★★★☆ | 活跃 | 微服务场景 |

---

## 十一、常见问题FAQ

**Q1: 为什么选择Nacos而不是Eureka？**
A: Nacos支持配置管理和服务发现一体化，性能更优，社区活跃度高，且与阿里云生态集成更好。

**Q2: 如何保证微服务间调用的可靠性？**
A: 通过OpenFeign的超时配置、重试机制、降级处理（Fallback）来保证调用可靠性。

**Q3: 数据库如何实现读写分离？**
A: 通过主从复制实现数据同步，应用层通过动态数据源切换，写操作走主库，读操作走从库。

**Q4: 如何保证分布式事务一致性？**
A: 支付等强一致性场景使用Seata分布式事务框架，其他场景使用消息队列实现最终一致性。

**Q5: 微服务拆分的粒度如何把握？**
A: 按照业务领域拆分，单一职责原则，避免过度拆分导致复杂度提升。

**Q6: 腾讯IM音视频如何集成到问诊服务？**
A: 通过腾讯IM SDK集成，实现医患实时音视频通话，支持视频问诊、图文问诊等多种场景。

**Q7: 如何处理多物流渠道的对接？**
A: 通过统一的物流中台，封装顺丰物流和快递100的API，提供统一的物流查询接口。

**Q8: 天津和北京监管平台上报的数据格式有什么区别？**
A: 两地监管平台的数据格式和上报接口不同，需要分别对接并按各自要求进行数据转换和上报。

---

## 十二、附录

### 13.1 相关文档

- Spring Boot官方文档：https://spring.io/projects/spring-boot
- Nacos官方文档：https://nacos.io/zh-cn/docs/
- MySQL官方文档：https://dev.mysql.com/doc/
- 阿里云OSS文档：https://help.aliyun.com/product/31815.html
- 腾讯云短信文档：https://cloud.tencent.com/document/product/382

### 13.2 团队联系方式

- 后端架构组邮箱：backend-arch@hospital.com
- 技术支持群：企业微信-后端技术支持群
- 文档更新频率：每季度更新一次

---

**文档维护**：后端架构组  
**最后更新**：2026-01-27  
**文档状态**：正式发布  
**适用版本**：v1.0
