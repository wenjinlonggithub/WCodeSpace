# 场景：互联网医院自费购药支付一致性问题

## 业务背景
互联网医院平台允许患者在线问诊后，在平台上自费购买药品。患者通过微信支付完成付款，系统需要同步到HIS（医院信息系统）创建订单并完成发药流程。

## 业务描述
- 患者选择药品后，发起微信支付
- 微信支付成功后，通过回调通知业务系统
- 业务系统接收到支付成功回调后，同步HIS系统创建订单
- HIS系统负责药品库存管理和发药

## 核心问题

### 问题描述
自费支付可能存在**药品库存不足导致订单创建失败，但患者已付款**的情况，造成资金和订单状态不一致。

### 问题原因分析

#### 1. 库存数据时差问题
```
时序图：
HIS系统（实时库存）
    ↓ 定时同步（每5分钟）
互联网医院系统（缓存库存）
    ↓
患者下单（基于缓存库存判断）
```

**问题**：
- 药品库存由HIS系统维护，互联网医院通过定时任务同步库存
- 存在5分钟左右的时差
- 期间HIS库存可能已被线下消耗，但互联网医院系统不知道

#### 2. 支付流程分离问题
```
流程：
1. 用户下单 -> 2. 微信预下单 -> 3. 用户支付 -> 4. 微信回调 -> 5. 同步HIS创建订单
                                                      ↑
                                                  此时才发现库存不足！
```

**问题**：
- 预下单时基于互联网医院系统的缓存库存判断（可能是过期数据）
- 支付成功回调后才真正调用HIS接口创建订单
- 此时HIS可能返回库存不足错误
- 但此时患者已经完成支付

### 3. 典型故障场景

```
09:00 - HIS系统：药品A库存 = 10
09:00 - 定时任务同步：互联网医院系统缓存库存 = 10
09:01 - 线下药房卖出8个，HIS库存 = 2
09:02 - 患者1在线下单3个（基于缓存库存10，通过）
09:02 - 患者1完成微信支付
09:02 - 微信回调，调用HIS创建订单
09:02 - HIS返回：库存不足（实际只剩2个）
09:02 - 患者已付款，但订单创建失败 ❌
```

## 技术解决方案

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| 方案1：预下单时实时查询HIS库存 | 数据最准确 | HIS性能压力大、响应慢 | 低并发场景 |
| 方案2：预扣库存+补偿机制 | 一致性好 | 实现复杂 | 推荐方案 |
| 方案3：延迟支付+库存预占 | 用户体验好 | 超时处理复杂 | 高价值商品 |
| 方案4：超卖后自动退款 | 实现简单 | 用户体验差 | 不推荐 |

---

### 方案1：预下单时实时查询HIS库存（强一致性方案）

#### 技术架构
```
用户下单 -> 实时调用HIS查库存 -> 库存充足 -> 微信预下单 -> 支付 -> HIS创建订单
              ↓
         库存不足 -> 提示用户，阻止下单
```

#### 核心流程
1. 用户选择药品后点击"立即购买"
2. 系统实时调用HIS接口查询库存
3. 如果库存充足，允许进入支付流程
4. 如果库存不足，直接提示用户

#### 实现要点
- HIS接口需要支持高并发查询
- 增加缓存层减轻HIS压力（短TTL，如10秒）
- 设置合理的超时和重试机制
- 熔断降级：HIS不可用时，降级到缓存库存

#### 优点
- 数据最准确，避免无效支付

#### 缺点
- 增加HIS系统压力
- 用户体验可能受HIS响应时间影响
- HIS故障时影响下单

---

### 方案2：预扣库存+补偿机制（推荐方案）

#### 技术架构
```
下单 -> 预扣HIS库存 -> 微信支付 -> 支付成功 -> 确认扣库存 -> 创建订单
                              ↓
                          支付失败/超时 -> 释放预扣库存
```

#### 核心流程

**阶段1：预下单阶段**
```java
1. 调用HIS接口：预扣库存（标记为冻结状态）
2. 如果预扣成功：
   - 记录预扣记录（包含超时时间）
   - 生成预订单
   - 调用微信预下单
3. 如果预扣失败：
   - 提示用户库存不足
```

**阶段2：支付回调阶段**
```java
1. 接收微信支付成功回调
2. 调用HIS接口：确认扣库存（冻结库存转为实际扣减）
3. 创建正式订单
4. 删除预扣记录
```

**阶段3：补偿机制**
```java
定时任务扫描：
1. 查询超时未支付的预扣记录（如30分钟）
2. 调用HIS接口：释放冻结库存
3. 关闭预订单
```

#### 数据库设计

**预扣库存记录表**
```sql
CREATE TABLE inventory_pre_deduction (
    id BIGINT PRIMARY KEY,
    order_no VARCHAR(64) NOT NULL COMMENT '预订单号',
    drug_id BIGINT NOT NULL COMMENT '药品ID',
    quantity INT NOT NULL COMMENT '预扣数量',
    his_lock_id VARCHAR(64) COMMENT 'HIS库存锁ID',
    status VARCHAR(20) NOT NULL COMMENT '状态：LOCKED/CONFIRMED/RELEASED',
    expire_time DATETIME NOT NULL COMMENT '过期时间',
    created_time DATETIME NOT NULL,
    updated_time DATETIME NOT NULL,
    INDEX idx_status_expire (status, expire_time),
    UNIQUE KEY uk_order_no (order_no)
);
```

#### 关键技术点

**1. 幂等性保证**
- 微信回调可能重复，使用订单号做幂等
- HIS接口需要支持幂等调用

**2. 超时控制**
- 预扣库存设置合理超时时间（如30分钟）
- 定时任务定期释放超时库存

**3. 异常处理**
- 支付成功但确认扣库存失败：记录异常，人工介入或自动退款
- 网络超时：设置重试机制

**4. 监控告警**
- 预扣库存堆积告警
- 确认失败率告警
- 补偿任务执行监控

#### 优点
- 一致性保证好
- 不会出现超卖
- 用户已支付的订单不会因库存失败

#### 缺点
- 实现复杂度高
- 需要HIS支持预扣库存接口
- 需要补偿机制

---

### 方案3：延迟支付+库存预占

#### 技术架构
```
下单 -> 锁定库存 -> 生成待支付订单 -> 用户支付 -> 创建正式订单
         ↓                            ↓
      15分钟超时                  支付超时 -> 释放库存
```

#### 核心流程
1. 用户下单时，调用HIS锁定库存（而非真实扣减）
2. 生成待支付订单，给用户15分钟支付窗口
3. 用户完成支付后，确认扣库存并创建正式订单
4. 如果15分钟内未支付，自动释放库存，关闭订单

#### 实现要点
```java
// 使用延迟队列实现超时释放
DelayQueue<InventoryReleaseTask> queue;

// 锁定库存
lockInventory(orderId, drugId, quantity);
queue.put(new InventoryReleaseTask(orderId, 15 * 60 * 1000));

// 支付成功回调
confirmPayment(orderId);
queue.remove(orderId); // 移除释放任务

// 超时处理
while (true) {
    InventoryReleaseTask task = queue.take();
    releaseInventory(task.getOrderId());
    closeOrder(task.getOrderId());
}
```

#### 优点
- 用户体验好（先锁定库存再支付）
- 不会出现支付后无库存的情况

#### 缺点
- 库存被占用时间较长
- 可能影响真实库存周转效率

---

### 方案4：超卖后自动退款（不推荐）

#### 流程
```
下单 -> 支付 -> 回调 -> 调用HIS -> 库存不足 -> 自动发起退款
```

#### 优点
- 实现简单

#### 缺点
- 用户体验极差
- 退款有时间延迟
- 可能引发投诉

**不推荐使用此方案**

---

## 业务解决方案

### 业务方案1：增加安全库存

**策略**：
- 为线上订单预留一定安全库存
- HIS系统区分线上/线下库存池
- 线下不能消耗线上库存

**实现**：
```
总库存 = 100
线上可用库存 = 70
线下可用库存 = 30
```

**优点**：
- 避免线下消耗导致线上无货
- 实现简单

**缺点**：
- 库存利用率降低
- 需要HIS系统支持

---

### 业务方案2：库存实时同步

**策略**：
- 从定时同步改为实时同步
- HIS库存变化时，通过MQ通知互联网医院系统
- 互联网医院系统实时更新缓存

**技术架构**：
```
HIS库存变更 -> 发送MQ消息 -> 互联网医院消费 -> 更新缓存库存
```

**优点**：
- 库存数据更准确
- 减少时差

**缺点**：
- 需要HIS系统改造
- 网络延迟仍然存在

---

### 业务方案3：支付前二次确认

**策略**：
- 用户点击支付按钮后，弹出确认框
- 确认框显示时，后台实时查询HIS库存
- 如果库存不足，阻止支付

**流程**：
```
点击支付 -> 显示确认框 -> 后台实时查HIS -> 库存充足 -> 允许支付
                                      ↓
                                  库存不足 -> 提示用户
```

**优点**：
- 用户体验较好
- 减少无效支付

**缺点**：
- 增加用户操作步骤
- HIS压力增加

---

## 最佳实践推荐

### 综合方案（技术+业务结合）

**短期方案（快速止损）**：
1. 支付前二次确认（业务方案3）
2. 超卖后自动退款+人工处理（方案4作为兜底）

**中期方案（优化体验）**：
1. 预扣库存+补偿机制（技术方案2）
2. 增加安全库存（业务方案1）

**长期方案（根本解决）**：
1. 库存实时同步（业务方案2）
2. HIS系统升级支持高并发

---

## 监控与告警

### 关键监控指标
```java
1. 支付成功但订单创建失败率
   - 阈值：> 1%
   - 级别：P0

2. 库存预扣失败率
   - 阈值：> 5%
   - 级别：P1

3. 自动退款笔数
   - 阈值：> 10笔/小时
   - 级别：P1

4. HIS接口响应时间
   - 阈值：P99 > 1000ms
   - 级别：P2

5. 补偿任务积压数量
   - 阈值：> 100
   - 级别：P2
```

### 日志记录
```java
关键节点必须记录：
- 预扣库存：订单号、药品ID、数量、HIS返回
- 支付回调：订单号、支付结果、时间戳
- 确认扣库存：订单号、HIS返回、是否成功
- 补偿执行：订单号、补偿类型、执行结果
```

---

## 关键代码实现

见以下文件：
- `InventoryPreDeductionService.java` - 库存预扣服务
- `PaymentCallbackHandler.java` - 支付回调处理
- `InventoryCompensationService.java` - 库存补偿机制

---

## 总结

互联网医院自费购药支付一致性问题的核心在于：
1. **库存数据不一致**：定时同步导致的时差
2. **流程分离**：支付和订单创建分离，缺乏原子性保证

**推荐方案**：预扣库存+补偿机制，配合库存实时同步

**关键技术**：
- 分布式事务（Saga模式）
- 幂等性设计
- 超时补偿机制
- 监控告警体系
