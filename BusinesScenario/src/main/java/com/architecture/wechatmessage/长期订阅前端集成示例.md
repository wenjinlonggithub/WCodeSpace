# å¾®ä¿¡å°ç¨‹åºé•¿æœŸè®¢é˜…æ¶ˆæ¯ - å‰ç«¯é›†æˆæŒ‡å—

## æ ¸å¿ƒåŒºåˆ«

### é•¿æœŸè®¢é˜… vs ä¸€æ¬¡æ€§è®¢é˜…

```javascript
// ä¸€æ¬¡æ€§è®¢é˜…ï¼šæˆæƒ1æ¬¡ = å‘é€1æ¬¡
wx.requestSubscribeMessage({ tmplIds: ['one_time_template'] })
// å‘é€1æ¬¡åï¼Œæ¬¡æ•°ç”¨å®Œï¼Œéœ€é‡æ–°æˆæƒ

// é•¿æœŸè®¢é˜…ï¼šæˆæƒ1æ¬¡ = æ— é™æ¬¡å‘é€
wx.requestSubscribeMessage({ tmplIds: ['long_term_template'] })
// å¯ä»¥æ— é™æ¬¡å‘é€ï¼Œç›´åˆ°ç”¨æˆ·ä¸»åŠ¨å…³é—­
```

## åŸºç¡€é›†æˆ

### 1. æˆæƒè®¢é˜…

```javascript
/**
 * é•¿æœŸè®¢é˜…æˆæƒ
 */
async function subscribeLongTerm(templateId) {
  try {
    const res = await wx.requestSubscribeMessage({
      tmplIds: [templateId]
    })

    console.log('è®¢é˜…ç»“æœï¼š', res)
    const status = res[templateId]

    if (status === 'accept' || status === 'acceptWithAudio') {
      // è®¢é˜…æˆåŠŸï¼Œé€šçŸ¥åç«¯
      await api.notifySubscribed({
        userId: app.globalData.userId,
        templateId: templateId,
        templateType: 'LONG_TERM'  // é‡è¦ï¼šæ ‡è®°ä¸ºé•¿æœŸè®¢é˜…
      })

      wx.showToast({ title: 'è®¢é˜…æˆåŠŸï¼Œæ‚¨å°†æ”¶åˆ°é‡è¦é€šçŸ¥' })
      return true

    } else if (status === 'reject') {
      wx.showToast({ title: 'æ‚¨æ‹’ç»äº†è®¢é˜…', icon: 'none' })
      return false
    }

  } catch (error) {
    console.error('è®¢é˜…å¤±è´¥ï¼š', error)
    return false
  }
}
```

### 2. å®šæœŸåŒæ­¥çŠ¶æ€ï¼ˆé‡è¦ï¼ï¼‰

```javascript
/**
 * å®šæœŸåŒæ­¥è®¢é˜…çŠ¶æ€
 *
 * ä¸ºä»€ä¹ˆéœ€è¦åŒæ­¥ï¼Ÿ
 * - ç”¨æˆ·å¯èƒ½åœ¨è®¾ç½®ä¸­å…³é—­äº†è®¢é˜…
 * - åŠæ—¶å‘ç°çŠ¶æ€å˜åŒ–ï¼Œé¿å…å‘é€å¤±è´¥
 */
App({
  onShow() {
    // æ¯æ¬¡å°ç¨‹åºæ˜¾ç¤ºæ—¶åŒæ­¥
    this.syncSubscriptionStatus()
  },

  async syncSubscriptionStatus() {
    const longTermTemplates = [
      'long_term_template_1',
      'long_term_template_2'
    ]

    try {
      const res = await wx.getSetting({
        withSubscriptions: true
      })

      console.log('è®¢é˜…è®¾ç½®ï¼š', res.subscriptionsSetting)

      for (let templateId of longTermTemplates) {
        const status = res.subscriptionsSetting.itemSettings?.[templateId]

        // åŒæ­¥åˆ°åç«¯
        await api.syncSubscriptionStatus({
          userId: app.globalData.userId,
          templateId: templateId,
          templateType: 'LONG_TERM',
          frontendStatus: status || 'unknown'
        })

        // æ›´æ–°æœ¬åœ°ç¼“å­˜
        wx.setStorageSync(`sub_${templateId}`, status)
      }

    } catch (error) {
      console.error('åŒæ­¥çŠ¶æ€å¤±è´¥ï¼š', error)
    }
  }
})
```

### 3. æ£€æµ‹çŠ¶æ€å˜åŒ–

```javascript
/**
 * æ£€æµ‹è®¢é˜…çŠ¶æ€å˜åŒ–
 */
Page({
  data: {
    templateId: 'long_term_template',
    subscriptionStatus: null
  },

  onShow() {
    this.checkStatusChange()
  },

  async checkStatusChange() {
    const currentStatus = await this.getCurrentStatus()
    const cachedStatus = wx.getStorageSync(`sub_${this.data.templateId}`)

    if (currentStatus !== cachedStatus) {
      console.log('è®¢é˜…çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼š', cachedStatus, 'â†’', currentStatus)

      // æ›´æ–°ç¼“å­˜
      wx.setStorageSync(`sub_${this.data.templateId}`, currentStatus)

      // åŒæ­¥åˆ°åç«¯
      await api.syncSubscriptionStatus({
        userId: app.globalData.userId,
        templateId: this.data.templateId,
        templateType: 'LONG_TERM',
        frontendStatus: currentStatus
      })

      // æ›´æ–°UI
      this.setData({ subscriptionStatus: currentStatus })

      // å¦‚æœç”¨æˆ·å…³é—­äº†è®¢é˜…ï¼Œæç¤º
      if (currentStatus === 'reject') {
        this.showResubscribeTip()
      }
    }
  },

  async getCurrentStatus() {
    const res = await wx.getSetting({
      withSubscriptions: true
    })
    return res.subscriptionsSetting.itemSettings?.[this.data.templateId] || 'unknown'
  },

  showResubscribeTip() {
    wx.showModal({
      title: 'è®¢é˜…å·²å…³é—­',
      content: 'æ‚¨å·²å…³é—­äº†è®¢é˜…æ¶ˆæ¯ï¼Œå°†æ— æ³•æ¥æ”¶é‡è¦é€šçŸ¥ã€‚æ˜¯å¦é‡æ–°å¼€å¯ï¼Ÿ',
      confirmText: 'é‡æ–°å¼€å¯',
      success: (res) => {
        if (res.confirm) {
          this.resubscribe()
        }
      }
    })
  },

  async resubscribe() {
    await subscribeLongTerm(this.data.templateId)
  }
})
```

## å¤„ç†43101é”™è¯¯

### 1. åç«¯è¿”å›43101çš„å¤„ç†

```javascript
/**
 * å½“åç«¯é€šçŸ¥43101é”™è¯¯æ—¶
 */
async function handle43101Error(templateId) {
  console.warn('æ”¶åˆ°43101é”™è¯¯ï¼ŒtemplateId:', templateId)

  // 1. æ£€æŸ¥å‰ç«¯çŠ¶æ€
  const frontendStatus = await getCurrentSubscriptionStatus(templateId)
  console.log('å‰ç«¯çŠ¶æ€ï¼š', frontendStatus)

  // 2. åˆ¤æ–­æƒ…å†µ
  if (frontendStatus === 'accept' || frontendStatus === 'acceptWithAudio') {
    // æƒ…å†µAï¼šå‰ç«¯æ˜¾ç¤º"æ¥å—"ï¼Œä½†åç«¯43101
    // æå¯èƒ½æ˜¯"æ€»æ˜¯ä¿æŒé€‰æ‹©"BUG
    await handleAlwaysKeepBug(templateId)

  } else if (frontendStatus === 'reject') {
    // æƒ…å†µBï¼šå‰ç«¯æ˜¾ç¤º"æ‹’ç»"ï¼Œåç«¯43101
    // æ­£å¸¸æƒ…å†µï¼Œå¼•å¯¼ç”¨æˆ·é‡æ–°è®¢é˜…
    await handleNormalReject(templateId)

  } else {
    // æƒ…å†µCï¼šå‰ç«¯çŠ¶æ€æœªçŸ¥
    // å¯èƒ½ç”¨æˆ·ä»æœªæˆæƒ
    await handleNeverSubscribed(templateId)
  }
}

/**
 * è·å–å½“å‰è®¢é˜…çŠ¶æ€
 */
async function getCurrentSubscriptionStatus(templateId) {
  const res = await wx.getSetting({
    withSubscriptions: true
  })
  return res.subscriptionsSetting.itemSettings?.[templateId]
}

/**
 * å¤„ç†"æ€»æ˜¯ä¿æŒé€‰æ‹©"BUG
 */
async function handleAlwaysKeepBug(templateId) {
  wx.showModal({
    title: 'è®¢é˜…çŠ¶æ€å¼‚å¸¸',
    content: 'æ£€æµ‹åˆ°è®¢é˜…çŠ¶æ€å¼‚å¸¸ï¼Œè¿™å¯èƒ½æ˜¯å› ä¸ºæ‚¨ä¹‹å‰å‹¾é€‰äº†"æ€»æ˜¯ä¿æŒä»¥ä¸Šé€‰æ‹©"å¯¼è‡´çš„ã€‚\n\nğŸ“Œ è§£å†³æ–¹æ³•ï¼š\n\næ–¹æ³•1ï¼ˆæ¨èï¼‰ï¼š\n1. é•¿æŒ‰å°ç¨‹åºå›¾æ ‡\n2. é€‰æ‹©"åˆ é™¤"\n3. é‡æ–°æœç´¢å¹¶è¿›å…¥\n4. é‡æ–°æˆæƒè®¢é˜…\n\næ–¹æ³•2ï¼š\nç°åœ¨å°è¯•é‡æ–°æˆæƒ\nï¼ˆå¯èƒ½æ— æ•ˆï¼Œå¦‚æ— æ•ˆè¯·ä½¿ç”¨æ–¹æ³•1ï¼‰',
    confirmText: 'é‡æ–°æˆæƒ',
    cancelText: 'ç¨åå¤„ç†',
    success: async (res) => {
      if (res.confirm) {
        // å°è¯•é‡æ–°æˆæƒ
        const result = await subscribeLongTerm(templateId)

        if (!result) {
          // æˆæƒå¤±è´¥ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‡å¼•
          showDeleteGuide()
        } else {
          // æˆæƒæˆåŠŸï¼Œæµ‹è¯•æ˜¯å¦çœŸçš„è§£å†³
          setTimeout(async () => {
            await testSubscription(templateId)
          }, 2000)
        }
      } else {
        // ç”¨æˆ·é€‰æ‹©ç¨åå¤„ç†ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‡å¼•
        showDeleteGuide()
      }
    }
  })
}

/**
 * æ˜¾ç¤ºåˆ é™¤å°ç¨‹åºæŒ‡å¼•
 */
function showDeleteGuide() {
  wx.showModal({
    title: 'å½»åº•è§£å†³æ–¹æ¡ˆ',
    content: 'å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œè¯·æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š\n\n1ï¸âƒ£ é•¿æŒ‰å°ç¨‹åºå›¾æ ‡æˆ–åˆ°"æœ€è¿‘ä½¿ç”¨"åˆ—è¡¨\n\n2ï¸âƒ£ é€‰æ‹©"åˆ é™¤"ï¼ˆä¸æ˜¯"é€€å‡º"ï¼‰\n\n3ï¸âƒ£ é‡æ–°æœç´¢å°ç¨‹åºåç§°\n\n4ï¸âƒ£ é‡æ–°è¿›å…¥å°ç¨‹åº\n\n5ï¸âƒ£ é‡æ–°æˆæƒè®¢é˜…\n\nâš ï¸ é‡è¦ï¼šæˆæƒæ—¶ä¸è¦å‹¾é€‰"æ€»æ˜¯ä¿æŒä»¥ä¸Šé€‰æ‹©"',
    showCancel: false,
    confirmText: 'æˆ‘çŸ¥é“äº†'
  })
}

/**
 * æµ‹è¯•è®¢é˜…æ˜¯å¦ç”Ÿæ•ˆ
 */
async function testSubscription(templateId) {
  try {
    const res = await api.testSendSubscription({
      userId: app.globalData.userId,
      templateId: templateId
    })

    if (res.code === 200) {
      wx.showToast({ title: 'è®¢é˜…æµ‹è¯•æˆåŠŸ' })
    } else if (res.code === 43101) {
      // ä»ç„¶43101ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‡å¼•
      wx.showModal({
        title: 'è®¢é˜…ä»ç„¶å¼‚å¸¸',
        content: 'é‡æ–°æˆæƒåä»ç„¶æ— æ³•å‘é€ï¼Œå»ºè®®åˆ é™¤å°ç¨‹åºåé‡æ–°è¿›å…¥',
        confirmText: 'æŸ¥çœ‹æŒ‡å¼•',
        success: (modalRes) => {
          if (modalRes.confirm) {
            showDeleteGuide()
          }
        }
      })
    }
  } catch (error) {
    console.error('æµ‹è¯•å¤±è´¥ï¼š', error)
  }
}

/**
 * å¤„ç†æ­£å¸¸çš„æ‹’ç»æƒ…å†µ
 */
async function handleNormalReject(templateId) {
  wx.showModal({
    title: 'è®¢é˜…å·²å…³é—­',
    content: 'æ‚¨å·²å…³é—­äº†è®¢é˜…æ¶ˆæ¯ï¼Œå°†æ— æ³•æ¥æ”¶é‡è¦é€šçŸ¥ã€‚æ˜¯å¦é‡æ–°å¼€å¯ï¼Ÿ',
    confirmText: 'é‡æ–°å¼€å¯',
    cancelText: 'æš‚ä¸å¼€å¯',
    success: async (res) => {
      if (res.confirm) {
        await subscribeLongTerm(templateId)
      }
    }
  })
}

/**
 * å¤„ç†ä»æœªè®¢é˜…çš„æƒ…å†µ
 */
async function handleNeverSubscribed(templateId) {
  wx.showModal({
    title: 'å¼€å¯è®¢é˜…',
    content: 'è®¢é˜…åå¯ä»¥æ¥æ”¶é‡è¦é€šçŸ¥ï¼Œä¸é”™è¿‡ä»»ä½•ä¿¡æ¯',
    confirmText: 'ç«‹å³è®¢é˜…',
    success: async (res) => {
      if (res.confirm) {
        await subscribeLongTerm(templateId)
      }
    }
  })
}
```

## è®¢é˜…ç®¡ç†ç»„ä»¶

### 1. è®¢é˜…å¼€å…³ç»„ä»¶

```vue
<!-- components/subscription-switch/index.wxml -->
<view class="subscription-switch">
  <view class="switch-header">
    <text class="title">{{ title }}</text>
    <text class="desc">{{ desc }}</text>
  </view>

  <switch
    checked="{{ subscribed }}"
    bindchange="onSwitchChange"
    color="#07C160"
  />

  <!-- çŠ¶æ€æŒ‡ç¤ºå™¨ -->
  <view class="status-indicator" wx:if="{{ showStatus }}">
    <text class="status-text {{ statusClass }}">{{ statusText }}</text>
  </view>
</view>
```

```javascript
// components/subscription-switch/index.js
Component({
  properties: {
    templateId: {
      type: String,
      required: true
    },
    title: {
      type: String,
      value: 'è®¢é˜…æ¶ˆæ¯'
    },
    desc: {
      type: String,
      value: 'æ¥æ”¶é‡è¦é€šçŸ¥'
    }
  },

  data: {
    subscribed: false,
    showStatus: false,
    statusText: '',
    statusClass: ''
  },

  lifetimes: {
    attached() {
      this.loadStatus()
    }
  },

  methods: {
    async loadStatus() {
      try {
        const res = await wx.getSetting({
          withSubscriptions: true
        })

        const status = res.subscriptionsSetting.itemSettings?.[this.data.templateId]
        const subscribed = status === 'accept' || status === 'acceptWithAudio'

        this.setData({ subscribed })

        // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸
        await this.checkAbnormal(status)

      } catch (error) {
        console.error('åŠ è½½çŠ¶æ€å¤±è´¥ï¼š', error)
      }
    },

    async checkAbnormal(frontendStatus) {
      // è°ƒç”¨åç«¯æ¥å£æ£€æŸ¥æ˜¯å¦æœ‰43101é”™è¯¯
      const res = await api.getSubscriptionStatus({
        userId: app.globalData.userId,
        templateId: this.data.templateId,
        templateType: 'LONG_TERM'
      })

      if (res.data.needResubscribe) {
        // éœ€è¦é‡æ–°è®¢é˜…
        this.setData({
          showStatus: true,
          statusText: 'çŠ¶æ€å¼‚å¸¸ï¼Œè¯·é‡æ–°è®¢é˜…',
          statusClass: 'error'
        })
      } else if (frontendStatus === 'accept' && res.data.status === 'ERROR_43101') {
        // å¯èƒ½æ˜¯"æ€»æ˜¯ä¿æŒé€‰æ‹©"BUG
        this.setData({
          showStatus: true,
          statusText: 'æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œå»ºè®®é‡æ–°æˆæƒ',
          statusClass: 'warning'
        })
      }
    },

    async onSwitchChange(e) {
      const checked = e.detail.value

      if (checked) {
        // æ‰“å¼€è®¢é˜…
        const success = await subscribeLongTerm(this.data.templateId)
        this.setData({ subscribed: success })

        if (success) {
          this.setData({
            showStatus: true,
            statusText: 'è®¢é˜…æˆåŠŸ',
            statusClass: 'success'
          })

          // 3ç§’åéšè—æç¤º
          setTimeout(() => {
            this.setData({ showStatus: false })
          }, 3000)
        }

      } else {
        // å…³é—­è®¢é˜… - å¼•å¯¼ç”¨æˆ·å»è®¾ç½®
        wx.showModal({
          title: 'å…³é—­è®¢é˜…',
          content: 'æ‚¨å¯ä»¥åœ¨è®¾ç½®ä¸­ç®¡ç†è®¢é˜…æ¶ˆæ¯',
          confirmText: 'å»è®¾ç½®',
          success: (res) => {
            if (res.confirm) {
              wx.openSetting({
                withSubscriptions: true
              })
            }
          }
        })

        // æ¢å¤å¼€å…³çŠ¶æ€
        this.setData({ subscribed: true })
      }
    }
  }
})
```

### 2. è®¢é˜…ç®¡ç†é¡µé¢

```vue
<!-- pages/subscription-manage/index.wxml -->
<view class="subscription-manage">
  <view class="header">
    <text class="title">è®¢é˜…æ¶ˆæ¯ç®¡ç†</text>
    <text class="desc">ç®¡ç†æ‚¨çš„æ¶ˆæ¯è®¢é˜…</text>
  </view>

  <view class="subscription-list">
    <subscription-switch
      wx:for="{{ templates }}"
      wx:key="id"
      template-id="{{ item.id }}"
      title="{{ item.name }}"
      desc="{{ item.desc }}"
    />
  </view>

  <view class="tips">
    <view class="tip-item">
      <text class="tip-icon">ğŸ’¡</text>
      <text class="tip-text">é•¿æœŸè®¢é˜…æ¶ˆæ¯æˆæƒä¸€æ¬¡å³å¯å¤šæ¬¡æ¥æ”¶</text>
    </view>
    <view class="tip-item">
      <text class="tip-icon">âš ï¸</text>
      <text class="tip-text">å¦‚é‡è®¢é˜…å¼‚å¸¸ï¼Œå»ºè®®åˆ é™¤å°ç¨‹åºåé‡æ–°è¿›å…¥</text>
    </view>
  </view>

  <button class="btn-reset" bindtap="showResetGuide">
    è®¢é˜…å¼‚å¸¸ï¼ŸæŸ¥çœ‹è§£å†³æ–¹æ¡ˆ
  </button>
</view>
```

```javascript
// pages/subscription-manage/index.js
Page({
  data: {
    templates: [
      {
        id: 'long_term_template_1',
        name: 'è®¢å•çŠ¶æ€æ›´æ–°',
        desc: 'è®¢å•çŠ¶æ€å˜åŒ–æ—¶é€šçŸ¥æ‚¨'
      },
      {
        id: 'long_term_template_2',
        name: 'ç‰©æµä¿¡æ¯é€šçŸ¥',
        desc: 'ç‰©æµçŠ¶æ€æ›´æ–°æ—¶é€šçŸ¥æ‚¨'
      },
      {
        id: 'long_term_template_3',
        name: 'é€€æ¬¾é€šçŸ¥',
        desc: 'é€€æ¬¾è¿›åº¦é€šçŸ¥æ‚¨'
      }
    ]
  },

  onShow() {
    // æ£€æŸ¥æ˜¯å¦æœ‰å¼‚å¸¸
    this.checkAllSubscriptions()
  },

  async checkAllSubscriptions() {
    for (let template of this.data.templates) {
      const res = await api.getSubscriptionStatus({
        userId: app.globalData.userId,
        templateId: template.id,
        templateType: 'LONG_TERM'
      })

      if (res.data.status === 'ERROR_43101') {
        // å‘ç°å¼‚å¸¸ï¼Œæ˜¾ç¤ºæç¤º
        wx.showToast({
          title: `${template.name}è®¢é˜…å¼‚å¸¸`,
          icon: 'none',
          duration: 3000
        })
      }
    }
  },

  showResetGuide() {
    showDeleteGuide()
  }
})
```

## æœ€ä½³å®è·µ

### 1. æˆæƒæ—¶æœº

```javascript
// âœ… å¥½çš„æ—¶æœºï¼šç”¨æˆ·å®Œæˆå…³é”®æ“ä½œå
async function onOrderSuccess() {
  wx.showModal({
    title: 'è®¢é˜…è®¢å•é€šçŸ¥',
    content: 'è®¢é˜…åå¯ä»¥éšæ—¶æ¥æ”¶è®¢å•çŠ¶æ€æ›´æ–°ï¼Œä¸é”™è¿‡ä»»ä½•ä¿¡æ¯',
    confirmText: 'ç«‹å³è®¢é˜…',
    success: async (res) => {
      if (res.confirm) {
        await subscribeLongTerm('order_template')
      }
    }
  })
}

// âŒ ä¸å¥½çš„æ—¶æœºï¼šç”¨æˆ·åˆšè¿›å…¥å°ç¨‹åº
App({
  onLaunch() {
    // ä¸è¦åœ¨è¿™é‡Œç«‹å³å¼¹å‡ºè®¢é˜…
    // subscribeLongTerm('xxx') // âŒ
  }
})
```

### 2. æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·

```javascript
// âœ… æ˜ç¡®å‘ŠçŸ¥è®¢é˜…çš„ä»·å€¼å’Œæœºåˆ¶
wx.showModal({
  title: 'è®¢é˜…æ¶ˆæ¯',
  content: 'âœ… æˆæƒä¸€æ¬¡ï¼Œé•¿æœŸæœ‰æ•ˆ\nâœ… éšæ—¶å¯ä»¥åœ¨è®¾ç½®ä¸­å…³é—­\nâœ… æ¥æ”¶è®¢å•ã€ç‰©æµç­‰é‡è¦é€šçŸ¥\n\nâš ï¸ æ³¨æ„ï¼šæˆæƒæ—¶è¯·ä¸è¦å‹¾é€‰"æ€»æ˜¯ä¿æŒä»¥ä¸Šé€‰æ‹©"',
  confirmText: 'æˆ‘çŸ¥é“äº†ï¼Œç«‹å³è®¢é˜…'
})

// âŒ ä¸æ˜ç¡®çš„æç¤º
wx.showModal({
  title: 'è®¢é˜…',
  content: 'æ˜¯å¦è®¢é˜…ï¼Ÿ'  // âŒ ç”¨æˆ·ä¸çŸ¥é“è®¢é˜…ä»€ä¹ˆ
})
```

### 3. æä¾›ç®¡ç†å…¥å£

```javascript
// âœ… åœ¨"æˆ‘çš„"é¡µé¢æä¾›è®¢é˜…ç®¡ç†å…¥å£
<!-- pages/profile/index.wxml -->
<view class="menu-item" bindtap="goToSubscriptionManage">
  <text class="menu-title">è®¢é˜…æ¶ˆæ¯ç®¡ç†</text>
  <text class="menu-badge" wx:if="{{ hasAbnormal }}">å¼‚å¸¸</text>
</view>
```

### 4. å¼‚å¸¸ç›‘æ§

```javascript
/**
 * å®šæœŸæ£€æµ‹è®¢é˜…å¼‚å¸¸
 */
class SubscriptionMonitor {
  constructor() {
    this.checkInterval = null
  }

  start() {
    // æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    this.checkInterval = setInterval(() => {
      this.check()
    }, 5 * 60 * 1000)
  }

  async check() {
    const templates = ['template_1', 'template_2']

    for (let templateId of templates) {
      const res = await api.getSubscriptionStatus({
        userId: app.globalData.userId,
        templateId: templateId,
        templateType: 'LONG_TERM'
      })

      if (res.data.status === 'ERROR_43101') {
        // å‘ç°å¼‚å¸¸ï¼Œè®°å½•æ—¥å¿—
        console.error('è®¢é˜…å¼‚å¸¸ï¼š', templateId)

        // ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
        wx.reportAnalytics('subscription_error', {
          template_id: templateId,
          status: res.data.status
        })
      }
    }
  }

  stop() {
    if (this.checkInterval) {
      clearInterval(this.checkInterval)
    }
  }
}

// åœ¨Appä¸­ä½¿ç”¨
App({
  monitor: new SubscriptionMonitor(),

  onLaunch() {
    this.monitor.start()
  },

  onHide() {
    this.monitor.stop()
  }
})
```

## æ€»ç»“

### é•¿æœŸè®¢é˜…çš„å…³é”®ç‚¹

1. **å®šæœŸåŒæ­¥çŠ¶æ€**ï¼šæ¯æ¬¡onShowæ—¶åŒæ­¥ï¼ŒåŠæ—¶å‘ç°ç”¨æˆ·å…³é—­è®¢é˜…
2. **å¤„ç†43101**ï¼šåŒºåˆ†"æ­£å¸¸å…³é—­"å’Œ"æ€»æ˜¯ä¿æŒé€‰æ‹©BUG"
3. **æä¾›åˆ é™¤æŒ‡å¼•**ï¼šè¿™æ˜¯è§£å†³BUGçš„å”¯ä¸€æ–¹æ³•
4. **æ˜ç¡®å‘ŠçŸ¥**ï¼šè®©ç”¨æˆ·ç†è§£é•¿æœŸè®¢é˜…çš„æœºåˆ¶
5. **æä¾›ç®¡ç†å…¥å£**ï¼šè®©ç”¨æˆ·å¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†è®¢é˜…

### é¿å…çš„å‘

âŒ ä¸åŒæ­¥çŠ¶æ€ï¼Œä¾èµ–åç«¯43101æ‰çŸ¥é“ç”¨æˆ·å…³é—­
âŒ é‡åˆ°43101ç›´æ¥æç¤º"æˆæƒå¤±è´¥"ï¼Œä¸åšè¿›ä¸€æ­¥åˆ†æ
âŒ æ²¡æœ‰æä¾›åˆ é™¤å°ç¨‹åºçš„æŒ‡å¼•
âŒ æˆæƒæ—¶ä¸æé†’ç”¨æˆ·ä¸è¦å‹¾é€‰"æ€»æ˜¯ä¿æŒé€‰æ‹©"

### æ¨èæµç¨‹

```
ç”¨æˆ·æˆæƒ â†’ é€šçŸ¥åç«¯ â†’ å®šæœŸåŒæ­¥çŠ¶æ€ â†’ å‘ç°å¼‚å¸¸ â†’ åˆ¤æ–­åŸå›  â†’
æä¾›è§£å†³æ–¹æ¡ˆï¼ˆé‡æ–°æˆæƒ/åˆ é™¤å°ç¨‹åºï¼‰â†’ æµ‹è¯•æ˜¯å¦è§£å†³
```
