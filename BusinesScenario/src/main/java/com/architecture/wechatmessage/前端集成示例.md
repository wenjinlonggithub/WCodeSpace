# 微信小程序订阅消息 - 前端集成最佳实践

## 目录

1. [基础集成](#基础集成)
2. [订阅授权](#订阅授权)
3. [状态查询](#状态查询)
4. [错误处理](#错误处理)
5. [用户引导](#用户引导)
6. [最佳实践](#最佳实践)

## 基础集成

### 1. 订阅授权接口

```javascript
/**
 * 请求订阅授权
 * @param {Array<string>} templateIds - 模板ID数组
 * @returns {Promise<Object>} 订阅结果
 */
async function requestSubscribe(templateIds) {
  try {
    const res = await wx.requestSubscribeMessage({
      tmplIds: templateIds
    })

    console.log('订阅结果：', res)
    // 输出示例：
    // {
    //   'tmpl_001': 'accept',   // 同意
    //   'tmpl_002': 'reject',   // 拒绝
    //   'tmpl_003': 'ban'       // 被封禁
    // }

    return res
  } catch (error) {
    console.error('订阅失败：', error)
    // 常见错误：
    // {errMsg: "requestSubscribeMessage:fail cancel"} - 用户取消
    // {errMsg: "requestSubscribeMessage:fail"} - 其他错误
    return null
  }
}
```

### 2. 完整的订阅流程

```javascript
/**
 * 完整的订阅流程（推荐）
 */
async function subscribe() {
  const templateId = 'tmpl_order_update'

  // 1. 调用授权接口
  const res = await wx.requestSubscribeMessage({
    tmplIds: [templateId]
  })

  if (!res) {
    wx.showToast({ title: '授权失败', icon: 'none' })
    return false
  }

  // 2. 检查授权结果
  const status = res[templateId]

  if (status === 'accept') {
    // 3. 通知后端记录订阅状态
    await api.notifySubscribed({
      userId: app.globalData.userId,
      templateId: templateId
    })

    wx.showToast({ title: '订阅成功' })
    return true

  } else if (status === 'reject') {
    wx.showToast({ title: '您拒绝了订阅', icon: 'none' })
    return false

  } else if (status === 'ban') {
    wx.showToast({
      title: '该模板已被封禁，请联系客服',
      icon: 'none'
    })
    return false
  }

  return false
}
```

## 订阅授权

### 1. 在关键业务节点引导订阅

```javascript
// 示例1：下单成功后引导订阅
async function onOrderSuccess(orderId) {
  // 显示提示
  const modalRes = await wx.showModal({
    title: '订阅订单通知',
    content: '订阅后可及时收到订单状态更新、物流信息等通知',
    confirmText: '立即订阅',
    cancelText: '暂不订阅'
  })

  if (modalRes.confirm) {
    const subscribed = await subscribe()

    if (subscribed) {
      // 记录用户订阅成功的统计
      wx.reportAnalytics('subscribe_success', {
        scene: 'order_success'
      })
    }
  }
}

// 示例2：支付成功后引导订阅
async function onPaymentSuccess() {
  wx.showModal({
    title: '订阅支付通知',
    content: '订阅后可收到支付成功、退款等重要通知',
    confirmText: '订阅',
    success: async (res) => {
      if (res.confirm) {
        await subscribe()
      }
    }
  })
}
```

### 2. 多模板订阅

```javascript
/**
 * 订阅多个模板
 * 注意：一次最多可以订阅3个模板
 */
async function subscribeMultiple() {
  const templates = [
    'tmpl_order_update',    // 订单更新
    'tmpl_logistics_update', // 物流更新
    'tmpl_refund_notify'    // 退款通知
  ]

  const res = await wx.requestSubscribeMessage({
    tmplIds: templates
  })

  if (!res) return

  // 逐个检查结果
  const results = {}
  for (let templateId of templates) {
    if (res[templateId] === 'accept') {
      results[templateId] = true
      // 通知后端
      await api.notifySubscribed({
        userId: app.globalData.userId,
        templateId: templateId
      })
    } else {
      results[templateId] = false
    }
  }

  // 显示结果
  const acceptedCount = Object.values(results).filter(v => v).length
  wx.showToast({
    title: `已订阅 ${acceptedCount}/${templates.length} 个通知`,
    icon: 'none'
  })

  return results
}
```

## 状态查询

### 1. 查询订阅设置

```javascript
/**
 * 查询用户的订阅设置
 */
async function getSubscriptionSettings() {
  const res = await wx.getSetting({
    withSubscriptions: true
  })

  console.log('订阅设置：', res.subscriptionsSetting)
  // 输出示例：
  // {
  //   mainSwitch: true,  // 总开关
  //   itemSettings: {
  //     'tmpl_001': 'accept',  // 接受
  //     'tmpl_002': 'reject'   // 拒绝
  //   }
  // }

  return res.subscriptionsSetting
}

/**
 * 检查用户是否订阅了某个模板
 */
async function isTemplateSubscribed(templateId) {
  const settings = await getSubscriptionSettings()

  if (!settings || !settings.mainSwitch) {
    return false  // 总开关关闭
  }

  const status = settings.itemSettings?.[templateId]
  return status === 'accept' || status === 'acceptWithAudio'
}
```

### 2. 引导用户打开订阅设置

```javascript
/**
 * 引导用户打开订阅设置页面
 */
function openSubscriptionSettings() {
  wx.openSetting({
    withSubscriptions: true,
    success(res) {
      console.log('设置已打开', res)
    },
    fail(err) {
      console.error('打开设置失败', err)
      wx.showToast({
        title: '请在设置中手动开启',
        icon: 'none'
      })
    }
  })
}
```

## 错误处理

### 1. 处理用户取消

```javascript
async function subscribeWithRetry() {
  const res = await wx.requestSubscribeMessage({
    tmplIds: ['tmpl_001']
  })

  // 用户取消授权
  if (!res) {
    const modalRes = await wx.showModal({
      title: '温馨提示',
      content: '订阅后可及时收到重要通知，是否重新订阅？',
      confirmText: '重新订阅',
      cancelText: '暂不订阅'
    })

    if (modalRes.confirm) {
      // 重试一次
      return await subscribeWithRetry()
    }

    return false
  }

  return true
}
```

### 2. 处理"总是保持选择"的问题

```javascript
/**
 * 提醒用户不要勾选"总是保持选择"
 */
async function subscribeWithWarning() {
  // 先显示提示
  await wx.showModal({
    title: '重要提示',
    content: '即将打开订阅授权，请注意：\n\n1. 选择"允许"以接收通知\n2. 不要勾选"总是保持以上选择"\n\n否则可能导致后续无法接收消息',
    showCancel: false,
    confirmText: '我知道了'
  })

  // 延迟500ms，让用户看清提示
  await new Promise(resolve => setTimeout(resolve, 500))

  // 调用订阅
  return await subscribe()
}
```

### 3. 处理后端返回的43101错误

```javascript
/**
 * 发送消息（前端主动触发）
 * 如果后端返回43101，引导用户重新订阅
 */
async function sendNotification(orderId) {
  try {
    // 调用后端接口发送
    const res = await api.sendOrderNotification(orderId)

    if (res.code === 200) {
      wx.showToast({ title: '通知已发送' })
      return true
    }

    // 后端返回43101错误
    if (res.code === 43101) {
      const modalRes = await wx.showModal({
        title: '订阅已失效',
        content: '您的订阅次数已用完，需要重新订阅才能接收通知',
        confirmText: '重新订阅',
        cancelText: '取消'
      })

      if (modalRes.confirm) {
        // 重新订阅
        const subscribed = await subscribe()

        if (subscribed) {
          // 重新发送
          return await sendNotification(orderId)
        }
      }

      return false
    }

  } catch (error) {
    console.error('发送失败', error)
    wx.showToast({ title: '发送失败', icon: 'none' })
    return false
  }
}
```

## 用户引导

### 1. 订阅状态展示

```vue
<!-- 订阅状态组件 -->
<template>
  <view class="subscription-status">
    <view class="status-item" v-for="(tpl, index) in templates" :key="index">
      <text class="template-name">{{ tpl.name }}</text>
      <switch
        :checked="tpl.subscribed"
        @change="onSwitchChange(tpl.id)"
        color="#07C160"
      />
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      templates: [
        { id: 'tmpl_001', name: '订单状态更新', subscribed: false },
        { id: 'tmpl_002', name: '物流信息通知', subscribed: false },
        { id: 'tmpl_003', name: '退款通知', subscribed: false }
      ]
    }
  },

  async onLoad() {
    // 查询订阅状态
    await this.loadSubscriptionStatus()
  },

  methods: {
    async loadSubscriptionStatus() {
      const settings = await getSubscriptionSettings()

      this.templates.forEach(tpl => {
        const status = settings.itemSettings?.[tpl.id]
        tpl.subscribed = status === 'accept'
      })
    },

    async onSwitchChange(templateId) {
      // 打开订阅授权
      const res = await wx.requestSubscribeMessage({
        tmplIds: [templateId]
      })

      if (res && res[templateId] === 'accept') {
        // 通知后端
        await api.notifySubscribed({
          userId: this.userId,
          templateId: templateId
        })

        // 更新UI
        await this.loadSubscriptionStatus()
      } else {
        // 取消订阅，引导用户打开设置
        wx.showModal({
          title: '温馨提示',
          content: '您可以在设置中管理订阅消息',
          confirmText: '去设置',
          success: (res) => {
            if (res.confirm) {
              openSubscriptionSettings()
            }
          }
        })
      }
    }
  }
}
</script>
```

### 2. 订阅引导页

```vue
<!-- 订阅引导页 -->
<template>
  <view class="subscribe-guide">
    <image class="guide-image" src="/images/subscribe-guide.png" />

    <view class="guide-title">开启消息订阅</view>

    <view class="guide-desc">
      订阅后可以接收以下通知：
    </view>

    <view class="feature-list">
      <view class="feature-item">
        <icon type="success" color="#07C160" />
        <text>订单状态实时更新</text>
      </view>
      <view class="feature-item">
        <icon type="success" color="#07C160" />
        <text>物流信息及时推送</text>
      </view>
      <view class="feature-item">
        <icon type="success" color="#07C160" />
        <text>退款进度通知</text>
      </view>
    </view>

    <view class="tips">
      <text class="tips-title">温馨提示：</text>
      <text>每次订阅可接收1条通知，用完后需重新订阅</text>
    </view>

    <button class="subscribe-btn" @click="handleSubscribe">
      立即订阅
    </button>

    <text class="skip-btn" @click="handleSkip">暂时跳过</text>
  </view>
</template>

<script>
export default {
  methods: {
    async handleSubscribe() {
      const templates = [
        'tmpl_order_update',
        'tmpl_logistics_update',
        'tmpl_refund_notify'
      ]

      const res = await subscribeMultiple(templates)

      // 订阅成功，跳转到首页
      wx.switchTab({ url: '/pages/index/index' })
    },

    handleSkip() {
      wx.switchTab({ url: '/pages/index/index' })
    }
  }
}
</script>
```

## 最佳实践

### 1. 封装统一的订阅管理类

```javascript
/**
 * 订阅管理器
 */
class SubscriptionManager {
  constructor() {
    this.userId = null
    this.templates = {
      ORDER_UPDATE: 'tmpl_order_update',
      LOGISTICS_UPDATE: 'tmpl_logistics_update',
      REFUND_NOTIFY: 'tmpl_refund_notify'
    }
  }

  /**
   * 初始化
   */
  init(userId) {
    this.userId = userId
  }

  /**
   * 订阅模板
   * @param {string|Array<string>} templateKeys - 模板key或key数组
   */
  async subscribe(templateKeys) {
    if (!Array.isArray(templateKeys)) {
      templateKeys = [templateKeys]
    }

    // 转换为模板ID
    const templateIds = templateKeys.map(key => this.templates[key])

    // 调用授权
    const res = await wx.requestSubscribeMessage({
      tmplIds: templateIds
    })

    if (!res) return false

    // 通知后端
    for (let templateId of templateIds) {
      if (res[templateId] === 'accept') {
        await api.notifySubscribed({
          userId: this.userId,
          templateId: templateId
        })
      }
    }

    return true
  }

  /**
   * 检查是否已订阅
   */
  async isSubscribed(templateKey) {
    const templateId = this.templates[templateKey]
    return await isTemplateSubscribed(templateId)
  }

  /**
   * 引导订阅（带提示）
   */
  async guideSubscribe(templateKey, scene) {
    const tips = this.getSubscribeTips(scene)

    const modalRes = await wx.showModal({
      title: tips.title,
      content: tips.content,
      confirmText: '立即订阅',
      cancelText: '暂不订阅'
    })

    if (modalRes.confirm) {
      return await this.subscribe(templateKey)
    }

    return false
  }

  /**
   * 获取订阅提示文案
   */
  getSubscribeTips(scene) {
    const tipsMap = {
      'order_create': {
        title: '订阅订单通知',
        content: '订阅后可及时收到订单状态更新、物流信息等通知'
      },
      'payment_success': {
        title: '订阅支付通知',
        content: '订阅后可收到支付成功、退款等重要通知'
      },
      'first_enter': {
        title: '开启消息订阅',
        content: '订阅后可以接收订单、物流、退款等重要通知'
      }
    }

    return tipsMap[scene] || tipsMap['first_enter']
  }
}

// 导出单例
export default new SubscriptionManager()
```

### 2. 在 app.js 中初始化

```javascript
// app.js
import SubscriptionManager from './utils/SubscriptionManager'

App({
  onLaunch() {
    // ...其他初始化代码
  },

  onShow() {
    // 用户登录后初始化订阅管理器
    if (this.globalData.userId) {
      SubscriptionManager.init(this.globalData.userId)
    }
  },

  globalData: {
    userId: null,
    SubscriptionManager: SubscriptionManager
  }
})
```

### 3. 在业务代码中使用

```javascript
// pages/order/confirm.js
const app = getApp()

Page({
  async onOrderSuccess(orderId) {
    // 引导订阅
    await app.globalData.SubscriptionManager.guideSubscribe(
      'ORDER_UPDATE',
      'order_create'
    )

    // 跳转到订单详情
    wx.navigateTo({
      url: `/pages/order/detail?id=${orderId}`
    })
  }
})
```

### 4. 统计分析

```javascript
/**
 * 订阅数据统计
 */
class SubscriptionAnalytics {
  /**
   * 记录订阅请求
   */
  trackSubscribeRequest(templateId, scene) {
    wx.reportAnalytics('subscribe_request', {
      template_id: templateId,
      scene: scene
    })
  }

  /**
   * 记录订阅成功
   */
  trackSubscribeSuccess(templateId, scene) {
    wx.reportAnalytics('subscribe_success', {
      template_id: templateId,
      scene: scene
    })
  }

  /**
   * 记录订阅拒绝
   */
  trackSubscribeReject(templateId, scene) {
    wx.reportAnalytics('subscribe_reject', {
      template_id: templateId,
      scene: scene
    })
  }

  /**
   * 计算订阅转化率
   */
  async getConversionRate() {
    // 从后端获取统计数据
    const stats = await api.getSubscriptionStats()
    return {
      total: stats.requestCount,
      success: stats.successCount,
      rate: (stats.successCount / stats.requestCount * 100).toFixed(2) + '%'
    }
  }
}

export default new SubscriptionAnalytics()
```

## 总结

### 核心要点

1. **每次授权只能发送1条消息**：这是最重要的机制，务必告知用户
2. **"总是保持选择"是个坑**：提醒用户不要勾选，否则可能永久无法接收
3. **本地状态不等于真实状态**：不要依赖 `wx.getSetting` 判断是否可发送
4. **引导重新订阅**：当后端返回43101时，及时引导用户重新订阅
5. **选择合适的订阅时机**：在用户完成关键操作后引导订阅，转化率更高

### 避免的坑

❌ 不检查授权结果，直接通知后端
❌ 完全依赖前端状态判断是否可发送
❌ 没有处理43101错误的兜底方案
❌ 在用户刚进入小程序就弹出订阅
❌ 订阅文案不清晰，用户不知道订阅的好处

### 推荐做法

✅ 检查每个模板的授权结果
✅ 授权成功后通知后端记录
✅ 提供重新订阅的入口
✅ 在关键业务节点引导订阅
✅ 清晰告知用户订阅的价值
