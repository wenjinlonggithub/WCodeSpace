package com.architecture.example;

import javax.sql.DataSource;
import java.sql.*;
import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

/**
 * æ‰¹é‡æ“ä½œç¤ºä¾‹
 * æ¼”ç¤ºï¼šæ‰¹é‡æ’å…¥ã€æ‰¹é‡æ›´æ–°ã€åˆ†é¡µå¤„ç†ã€å¹¶å‘æ‰¹é‡æ“ä½œ
 */
public class BatchOperationExample {
    
    private static final DataSource dataSource = ConnectionPoolExample.getDataSource();
    private static final int BATCH_SIZE = 1000;
    
    /**
     * æµ‹è¯•æ‰¹é‡æ“ä½œ
     */
    public static void testBatchOperations() {
        try {
            // 1. åˆ›å»ºæµ‹è¯•è¡¨
            setupBatchTestTable();
            
            // 2. æ‰¹é‡æ’å…¥å¯¹æ¯”
            compareBatchInsertMethods();
            
            // 3. æ‰¹é‡æ›´æ–°æ¼”ç¤º
            demonstrateBatchUpdate();
            
            // 4. æ‰¹é‡åˆ é™¤æ¼”ç¤º
            demonstrateBatchDelete();
            
            // 5. å¤§æ•°æ®é‡å¤„ç†
            demonstrateLargeDataProcessing();
            
            // 6. å¹¶å‘æ‰¹é‡æ“ä½œ
            demonstrateConcurrentBatchOperation();
            
            // 7. é”™è¯¯å¤„ç†å’Œäº‹åŠ¡å›æ»š
            demonstrateBatchErrorHandling();
            
        } catch (Exception e) {
            System.err.println(\"âŒ æ‰¹é‡æ“ä½œæµ‹è¯•å¤±è´¥: \" + e.getMessage());\n            e.printStackTrace();\n        }\n    }\n    \n    /**\n     * åˆ›å»ºæ‰¹é‡æµ‹è¯•è¡¨\n     */\n    private static void setupBatchTestTable() throws SQLException {\n        System.out.println(\"ğŸ“‹ åˆ›å»ºæ‰¹é‡æµ‹è¯•è¡¨...\");\n        \n        try (Connection conn = dataSource.getConnection();\n             Statement stmt = conn.createStatement()) {\n            \n            // åˆ é™¤å·²å­˜åœ¨çš„è¡¨\n            stmt.execute(\"DROP TABLE IF EXISTS batch_test\");\n            stmt.execute(\"DROP TABLE IF EXISTS user_scores\");\n            \n            // åˆ›å»ºæ‰¹é‡æµ‹è¯•è¡¨\n            String createBatchTestSql = \"\"\"\n                CREATE TABLE batch_test (\n                    id BIGINT PRIMARY KEY AUTO_INCREMENT,\n                    user_id INT NOT NULL,\n                    name VARCHAR(100) NOT NULL,\n                    email VARCHAR(100),\n                    score DECIMAL(5,2) DEFAULT 0,\n                    status TINYINT DEFAULT 1,\n                    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    update_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n                    INDEX idx_user_id (user_id),\n                    INDEX idx_email (email),\n                    INDEX idx_score (score)\n                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\n                \"\"\";\n            \n            // åˆ›å»ºç”¨æˆ·æˆç»©è¡¨\n            String createUserScoresSql = \"\"\"\n                CREATE TABLE user_scores (\n                    id BIGINT PRIMARY KEY AUTO_INCREMENT,\n                    user_id INT NOT NULL,\n                    subject VARCHAR(50) NOT NULL,\n                    score DECIMAL(5,2) NOT NULL,\n                    exam_date DATE NOT NULL,\n                    create_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n                    UNIQUE KEY uk_user_subject_date (user_id, subject, exam_date),\n                    INDEX idx_user_id (user_id),\n                    INDEX idx_subject (subject),\n                    INDEX idx_exam_date (exam_date)\n                ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4\n                \"\"\";\n            \n            stmt.execute(createBatchTestSql);\n            stmt.execute(createUserScoresSql);\n            \n            System.out.println(\"âœ… æ‰¹é‡æµ‹è¯•è¡¨åˆ›å»ºå®Œæˆ\");\n        }\n    }\n    \n    /**\n     * æ¯”è¾ƒä¸åŒæ‰¹é‡æ’å…¥æ–¹æ³•çš„æ€§èƒ½\n     */\n    private static void compareBatchInsertMethods() throws SQLException {\n        System.out.println(\"\\nâš¡ æ‰¹é‡æ’å…¥æ–¹æ³•æ€§èƒ½å¯¹æ¯”\");\n        \n        int recordCount = 10000;\n        \n        // æ–¹æ³•1ï¼šé€æ¡æ’å…¥\n        testSingleInsert(recordCount);\n        \n        // æ–¹æ³•2ï¼šæ‰¹é‡æ’å…¥\n        testBatchInsert(recordCount);\n        \n        // æ–¹æ³•3ï¼šæ‰¹é‡æ’å…¥ + äº‹åŠ¡\n        testBatchInsertWithTransaction(recordCount);\n        \n        // æ–¹æ³•4ï¼šå¤šå€¼æ’å…¥\n        testMultiValueInsert(recordCount);\n        \n        // æ–¹æ³•5ï¼šLOAD DATAï¼ˆå¦‚æœæ”¯æŒï¼‰\n        // testLoadData(recordCount);\n    }\n    \n    /**\n     * é€æ¡æ’å…¥æµ‹è¯•\n     */\n    private static void testSingleInsert(int count) throws SQLException {\n        System.out.println(\"\\nğŸŒ æ–¹æ³•1ï¼šé€æ¡æ’å…¥æµ‹è¯•\");\n        \n        // æ¸…ç©ºè¡¨\n        clearTable(\"batch_test\");\n        \n        long startTime = System.currentTimeMillis();\n        \n        try (Connection conn = dataSource.getConnection();\n             PreparedStatement pstmt = conn.prepareStatement(\n                 \"INSERT INTO batch_test (user_id, name, email, score) VALUES (?, ?, ?, ?)\")) {\n            \n            for (int i = 1; i <= count; i++) {\n                pstmt.setInt(1, i);\n                pstmt.setString(2, \"ç”¨æˆ·\" + i);\n                pstmt.setString(3, \"user\" + i + \"@example.com\");\n                pstmt.setBigDecimal(4, java.math.BigDecimal.valueOf(60 + Math.random() * 40));\n                \n                pstmt.executeUpdate();\n            }\n        }\n        \n        long endTime = System.currentTimeMillis();\n        System.out.printf(\"æ’å…¥ %d æ¡è®°å½•ï¼Œè€—æ—¶: %d ms%n\", count, endTime - startTime);\n    }\n    \n    /**\n     * æ‰¹é‡æ’å…¥æµ‹è¯•\n     */\n    private static void testBatchInsert(int count) throws SQLException {\n        System.out.println(\"\\nğŸš€ æ–¹æ³•2ï¼šæ‰¹é‡æ’å…¥æµ‹è¯•\");\n        \n        // æ¸…ç©ºè¡¨\n        clearTable(\"batch_test\");\n        \n        long startTime = System.currentTimeMillis();\n        \n        try (Connection conn = dataSource.getConnection();\n             PreparedStatement pstmt = conn.prepareStatement(\n                 \"INSERT INTO batch_test (user_id, name, email, score) VALUES (?, ?, ?, ?)\")) {\n            \n            for (int i = 1; i <= count; i++) {\n                pstmt.setInt(1, i);\n                pstmt.setString(2, \"ç”¨æˆ·\" + i);\n                pstmt.setString(3, \"user\" + i + \"@example.com\");\n                pstmt.setBigDecimal(4, java.math.BigDecimal.valueOf(60 + Math.random() * 40));\n                \n                pstmt.addBatch();\n                \n                // æ¯1000æ¡æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æ’å…¥\n                if (i % BATCH_SIZE == 0) {\n                    pstmt.executeBatch();\n                    pstmt.clearBatch();\n                }\n            }\n            \n            // å¤„ç†å‰©ä½™çš„è®°å½•\n            pstmt.executeBatch();\n        }\n        \n        long endTime = System.currentTimeMillis();\n        System.out.printf(\"æ’å…¥ %d æ¡è®°å½•ï¼Œè€—æ—¶: %d ms%n\", count, endTime - startTime);\n    }\n    \n    /**\n     * æ‰¹é‡æ’å…¥ + äº‹åŠ¡æµ‹è¯•\n     */\n    private static void testBatchInsertWithTransaction(int count) throws SQLException {\n        System.out.println(\"\\nğŸ’ª æ–¹æ³•3ï¼šæ‰¹é‡æ’å…¥ + äº‹åŠ¡æµ‹è¯•\");\n        \n        // æ¸…ç©ºè¡¨\n        clearTable(\"batch_test\");\n        \n        long startTime = System.currentTimeMillis();\n        \n        Connection conn = null;\n        try {\n            conn = dataSource.getConnection();\n            conn.setAutoCommit(false);\n            \n            try (PreparedStatement pstmt = conn.prepareStatement(\n                    \"INSERT INTO batch_test (user_id, name, email, score) VALUES (?, ?, ?, ?)\")) {\n                \n                for (int i = 1; i <= count; i++) {\n                    pstmt.setInt(1, i);\n                    pstmt.setString(2, \"ç”¨æˆ·\" + i);\n                    pstmt.setString(3, \"user\" + i + \"@example.com\");\n                    pstmt.setBigDecimal(4, java.math.BigDecimal.valueOf(60 + Math.random() * 40));\n                    \n                    pstmt.addBatch();\n                    \n                    // æ¯1000æ¡æ‰§è¡Œä¸€æ¬¡æ‰¹é‡æ’å…¥\n                    if (i % BATCH_SIZE == 0) {\n                        pstmt.executeBatch();\n                        pstmt.clearBatch();\n                        conn.commit(); // åˆ†æ‰¹æäº¤äº‹åŠ¡\n                    }\n                }\n                \n                // å¤„ç†å‰©ä½™çš„è®°å½•\n                pstmt.executeBatch();\n                conn.commit();\n            }\n            \n        } catch (SQLException e) {\n            if (conn != null) {\n                conn.rollback();\n            }\n            throw e;\n        } finally {\n            if (conn != null) {\n                conn.setAutoCommit(true);\n                conn.close();\n            }\n        }\n        \n        long endTime = System.currentTimeMillis();\n        System.out.printf(\"æ’å…¥ %d æ¡è®°å½•ï¼Œè€—æ—¶: %d ms%n\", count, endTime - startTime);\n    }\n    \n    /**\n     * å¤šå€¼æ’å…¥æµ‹è¯•\n     */\n    private static void testMultiValueInsert(int count) throws SQLException {\n        System.out.println(\"\\nğŸŒŸ æ–¹æ³•4ï¼šå¤šå€¼æ’å…¥æµ‹è¯•\");\n        \n        // æ¸…ç©ºè¡¨\n        clearTable(\"batch_test\");\n        \n        long startTime = System.currentTimeMillis();\n        \n        try (Connection conn = dataSource.getConnection()) {\n            \n            int batchCount = 0;\n            StringBuilder sql = new StringBuilder(\"INSERT INTO batch_test (user_id, name, email, score) VALUES \");\n            \n            for (int i = 1; i <= count; i++) {\n                if (batchCount > 0) {\n                    sql.append(\", \");\n                }\n                \n                sql.append(String.format(\"(%d, 'ç”¨æˆ·%d', 'user%d@example.com', %.2f)\", \n                    i, i, i, 60 + Math.random() * 40));\n                \n                batchCount++;\n                \n                // æ¯500æ¡æ‰§è¡Œä¸€æ¬¡æ’å…¥ï¼ˆé¿å…SQLè¿‡é•¿ï¼‰\n                if (batchCount == 500 || i == count) {\n                    try (Statement stmt = conn.createStatement()) {\n                        stmt.executeUpdate(sql.toString());\n                    }\n                    \n                    // é‡ç½®StringBuilder\n                    sql.setLength(0);\n                    sql.append(\"INSERT INTO batch_test (user_id, name, email, score) VALUES \");\n                    batchCount = 0;\n                }\n            }\n        }\n        \n        long endTime = System.currentTimeMillis();\n        System.out.printf(\"æ’å…¥ %d æ¡è®°å½•ï¼Œè€—æ—¶: %d ms%n\", count, endTime - startTime);\n    }\n    \n    /**\n     * æ‰¹é‡æ›´æ–°æ¼”ç¤º\n     */\n    private static void demonstrateBatchUpdate() throws SQLException {\n        System.out.println(\"\\nğŸ”„ æ‰¹é‡æ›´æ–°æ¼”ç¤º\");\n        \n        // å‡†å¤‡æµ‹è¯•æ•°æ®\n        if (getTableRowCount(\"batch_test\") == 0) {\n            testBatchInsert(5000);\n        }\n        \n        long startTime = System.currentTimeMillis();\n        \n        Connection conn = null;\n        try {\n            conn = dataSource.getConnection();\n            conn.setAutoCommit(false);\n            \n            // æ‰¹é‡æ›´æ–°æˆç»©\n            try (PreparedStatement pstmt = conn.prepareStatement(\n                    \"UPDATE batch_test SET score = score + ?, update_time = NOW() WHERE user_id = ?\")) {\n                \n                int updateCount = 0;\n                \n                for (int userId = 1; userId <= 3000; userId++) {\n                    double bonus = Math.random() * 10; // éšæœºåŠ åˆ†\n                    \n                    pstmt.setBigDecimal(1, java.math.BigDecimal.valueOf(bonus));\n                    pstmt.setInt(2, userId);\n                    pstmt.addBatch();\n                    \n                    updateCount++;\n                    \n                    if (updateCount % BATCH_SIZE == 0) {\n                        int[] results = pstmt.executeBatch();\n                        pstmt.clearBatch();\n                        \n                        System.out.printf(\"å·²æ›´æ–° %d æ¡è®°å½•\\n\", updateCount);\n                    }\n                }\n                \n                // å¤„ç†å‰©ä½™çš„æ›´æ–°\n                int[] results = pstmt.executeBatch();\n                conn.commit();\n                \n                System.out.printf(\"æ‰¹é‡æ›´æ–°å®Œæˆï¼Œæ€»å…±æ›´æ–° %d æ¡è®°å½•\\n\", updateCount);\n            }\n            \n        } catch (SQLException e) {\n            if (conn != null) {\n                conn.rollback();\n            }\n            throw e;\n        } finally {\n            if (conn != null) {\n                conn.setAutoCommit(true);\n                conn.close();\n            }\n        }\n        \n        long endTime = System.currentTimeMillis();\n        System.out.printf(\"æ‰¹é‡æ›´æ–°è€—æ—¶: %d ms%n\", endTime - startTime);\n    }\n    \n    /**\n     * æ‰¹é‡åˆ é™¤æ¼”ç¤º\n     */\n    private static void demonstrateBatchDelete() throws SQLException {\n        System.out.println(\"\\nğŸ—‘ï¸ æ‰¹é‡åˆ é™¤æ¼”ç¤º\");\n        \n        long startTime = System.currentTimeMillis();\n        \n        Connection conn = null;\n        try {\n            conn = dataSource.getConnection();\n            conn.setAutoCommit(false);\n            \n            // åˆ†æ‰¹åˆ é™¤æˆç»©ä½äº70çš„è®°å½•\n            try (PreparedStatement pstmt = conn.prepareStatement(\n                    \"DELETE FROM batch_test WHERE score < ? LIMIT ?\")) {\n                \n                int totalDeleted = 0;\n                int batchSize = 500;\n                \n                while (true) {\n                    pstmt.setBigDecimal(1, java.math.BigDecimal.valueOf(70));\n                    pstmt.setInt(2, batchSize);\n                    \n                    int deleted = pstmt.executeUpdate();\n                    totalDeleted += deleted;\n                    \n                    if (deleted < batchSize) {\n                        // æ²¡æœ‰æ›´å¤šè®°å½•éœ€è¦åˆ é™¤\n                        break;\n                    }\n                    \n                    System.out.printf(\"å·²åˆ é™¤ %d æ¡è®°å½•ï¼Œç´¯è®¡åˆ é™¤: %d\\n\", deleted, totalDeleted);\n                    \n                    // æäº¤å½“å‰æ‰¹æ¬¡\n                    conn.commit();\n                    \n                    // é¿å…é•¿æ—¶é—´é”å®š\n                    Thread.sleep(10);\n                }\n                \n                conn.commit();\n                System.out.printf(\"æ‰¹é‡åˆ é™¤å®Œæˆï¼Œæ€»å…±åˆ é™¤ %d æ¡è®°å½•\\n\", totalDeleted);\n            }\n            \n        } catch (Exception e) {\n            if (conn != null) {\n                conn.rollback();\n            }\n            throw new SQLException(e);\n        } finally {\n            if (conn != null) {\n                conn.setAutoCommit(true);\n                conn.close();\n            }\n        }\n        \n        long endTime = System.currentTimeMillis();\n        System.out.printf(\"æ‰¹é‡åˆ é™¤è€—æ—¶: %d ms%n\", endTime - startTime);\n    }\n    \n    /**\n     * å¤§æ•°æ®é‡å¤„ç†æ¼”ç¤º\n     */\n    private static void demonstrateLargeDataProcessing() throws SQLException {\n        System.out.println(\"\\nğŸ“ˆ å¤§æ•°æ®é‡å¤„ç†æ¼”ç¤º\");\n        \n        // æ¨¡æ‹Ÿå¤„ç†100ä¸‡æ¡è®°å½•\n        int totalRecords = 1000000;\n        int batchSize = 10000;\n        \n        System.out.printf(\"å¼€å§‹å¤„ç† %d æ¡è®°å½•ï¼Œæ‰¹æ¬¡å¤§å°: %d\\n\", totalRecords, batchSize);\n        \n        long startTime = System.currentTimeMillis();\n        \n        Connection conn = null;\n        try {\n            conn = dataSource.getConnection();\n            conn.setAutoCommit(false);\n            \n            // æ¸…ç©ºè¡¨\n            try (Statement stmt = conn.createStatement()) {\n                stmt.executeUpdate(\"TRUNCATE TABLE user_scores\");\n            }\n            \n            try (PreparedStatement pstmt = conn.prepareStatement(\n                    \"INSERT INTO user_scores (user_id, subject, score, exam_date) VALUES (?, ?, ?, ?)\")) {\n                \n                String[] subjects = {\"æ•°å­¦\", \"è‹±è¯­\", \"è¯­æ–‡\", \"ç‰©ç†\", \"åŒ–å­¦\"};\n                java.sql.Date examDate = new java.sql.Date(System.currentTimeMillis());\n                \n                for (int i = 1; i <= totalRecords; i++) {\n                    int userId = (i - 1) % 100000 + 1; // å‡è®¾æœ‰10ä¸‡ä¸ªç”¨æˆ·\n                    String subject = subjects[(i - 1) % subjects.length];\n                    double score = 60 + Math.random() * 40;\n                    \n                    pstmt.setInt(1, userId);\n                    pstmt.setString(2, subject);\n                    pstmt.setBigDecimal(3, java.math.BigDecimal.valueOf(score));\n                    pstmt.setDate(4, examDate);\n                    \n                    pstmt.addBatch();\n                    \n                    if (i % batchSize == 0) {\n                        pstmt.executeBatch();\n                        pstmt.clearBatch();\n                        conn.commit();\n                        \n                        long currentTime = System.currentTimeMillis();\n                        double progress = (double) i / totalRecords * 100;\n                        long elapsedTime = currentTime - startTime;\n                        long estimatedTotal = (long) (elapsedTime / (i / (double) totalRecords));\n                        long remainingTime = estimatedTotal - elapsedTime;\n                        \n                        System.out.printf(\"è¿›åº¦: %.1f%% (%d/%d), å·²ç”¨æ—¶: %d ms, é¢„è®¡å‰©ä½™: %d ms\\n\", \n                            progress, i, totalRecords, elapsedTime, remainingTime);\n                    }\n                }\n                \n                // å¤„ç†å‰©ä½™è®°å½•\n                pstmt.executeBatch();\n                conn.commit();\n            }\n            \n        } catch (SQLException e) {\n            if (conn != null) {\n                conn.rollback();\n            }\n            throw e;\n        } finally {\n            if (conn != null) {\n                conn.setAutoCommit(true);\n                conn.close();\n            }\n        }\n        \n        long endTime = System.currentTimeMillis();\n        System.out.printf(\"å¤§æ•°æ®é‡å¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶: %d ms (%.2f ç§’)\\n\", \n            endTime - startTime, (endTime - startTime) / 1000.0);\n    }\n    \n    /**\n     * å¹¶å‘æ‰¹é‡æ“ä½œæ¼”ç¤º\n     */\n    private static void demonstrateConcurrentBatchOperation() throws Exception {\n        System.out.println(\"\\nğŸ”€ å¹¶å‘æ‰¹é‡æ“ä½œæ¼”ç¤º\");\n        \n        // æ¸…ç©ºè¡¨\n        clearTable(\"batch_test\");\n        \n        int threadCount = 4;\n        int recordsPerThread = 5000;\n        \n        ExecutorService executor = Executors.newFixedThreadPool(threadCount);\n        List<CompletableFuture<Void>> futures = new ArrayList<>();\n        \n        long startTime = System.currentTimeMillis();\n        \n        for (int t = 0; t < threadCount; t++) {\n            final int threadId = t;\n            final int startId = t * recordsPerThread + 1;\n            final int endId = (t + 1) * recordsPerThread;\n            \n            CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {\n                try {\n                    insertRecordsBatch(threadId, startId, endId);\n                } catch (SQLException e) {\n                    System.err.printf(\"çº¿ç¨‹ %d æ‰§è¡Œå¤±è´¥: %s%n\", threadId, e.getMessage());\n                }\n            }, executor);\n            \n            futures.add(future);\n        }\n        \n        // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ\n        CompletableFuture.allOf(futures.toArray(new CompletableFuture[0])).join();\n        \n        long endTime = System.currentTimeMillis();\n        \n        // éªŒè¯ç»“æœ\n        int totalInserted = getTableRowCount(\"batch_test\");\n        \n        System.out.printf(\"å¹¶å‘æ‰¹é‡æ’å…¥å®Œæˆ:\\n\");\n        System.out.printf(\"  çº¿ç¨‹æ•°: %d\\n\", threadCount);\n        System.out.printf(\"  æ¯çº¿ç¨‹è®°å½•æ•°: %d\\n\", recordsPerThread);\n        System.out.printf(\"  æ€»è®°å½•æ•°: %d\\n\", totalInserted);\n        System.out.printf(\"  æ€»è€—æ—¶: %d ms\\n\", endTime - startTime);\n        \n        executor.shutdown();\n        executor.awaitTermination(30, TimeUnit.SECONDS);\n    }\n    \n    /**\n     * çº¿ç¨‹å†…æ‰¹é‡æ’å…¥è®°å½•\n     */\n    private static void insertRecordsBatch(int threadId, int startId, int endId) throws SQLException {\n        try (Connection conn = dataSource.getConnection()) {\n            conn.setAutoCommit(false);\n            \n            try (PreparedStatement pstmt = conn.prepareStatement(\n                    \"INSERT INTO batch_test (user_id, name, email, score) VALUES (?, ?, ?, ?)\")) {\n                \n                int batchCount = 0;\n                \n                for (int id = startId; id <= endId; id++) {\n                    pstmt.setInt(1, id);\n                    pstmt.setString(2, \"ç”¨æˆ·\" + id + \"_T\" + threadId);\n                    pstmt.setString(3, \"user\" + id + \"_t\" + threadId + \"@example.com\");\n                    pstmt.setBigDecimal(4, java.math.BigDecimal.valueOf(60 + Math.random() * 40));\n                    \n                    pstmt.addBatch();\n                    batchCount++;\n                    \n                    if (batchCount % BATCH_SIZE == 0) {\n                        pstmt.executeBatch();\n                        pstmt.clearBatch();\n                        conn.commit();\n                        \n                        System.out.printf(\"çº¿ç¨‹ %d: å·²æ’å…¥ %d æ¡è®°å½•\\n\", threadId, batchCount);\n                    }\n                }\n                \n                // å¤„ç†å‰©ä½™è®°å½•\n                pstmt.executeBatch();\n                conn.commit();\n                \n                System.out.printf(\"çº¿ç¨‹ %d: å®Œæˆæ’å…¥ %d æ¡è®°å½•\\n\", threadId, endId - startId + 1);\n            }\n            \n        } catch (SQLException e) {\n            System.err.printf(\"çº¿ç¨‹ %d æ’å…¥å¤±è´¥: %s%n\", threadId, e.getMessage());\n            throw e;\n        }\n    }\n    \n    /**\n     * æ‰¹é‡æ“ä½œé”™è¯¯å¤„ç†æ¼”ç¤º\n     */\n    private static void demonstrateBatchErrorHandling() throws SQLException {\n        System.out.println(\"\\nâš ï¸ æ‰¹é‡æ“ä½œé”™è¯¯å¤„ç†æ¼”ç¤º\");\n        \n        Connection conn = null;\n        try {\n            conn = dataSource.getConnection();\n            conn.setAutoCommit(false);\n            \n            try (PreparedStatement pstmt = conn.prepareStatement(\n                    \"INSERT INTO batch_test (user_id, name, email, score) VALUES (?, ?, ?, ?)\")) {\n                \n                // å‡†å¤‡ä¸€äº›æ­£å¸¸æ•°æ®å’Œä¸€äº›ä¼šå‡ºé”™çš„æ•°æ®\n                for (int i = 1; i <= 100; i++) {\n                    pstmt.setInt(1, 90000 + i);\n                    pstmt.setString(2, \"æµ‹è¯•ç”¨æˆ·\" + i);\n                    \n                    if (i == 50) {\n                        // æ•…æ„æ’å…¥è¶…é•¿é‚®ç®±å¼•å‘é”™è¯¯\n                        pstmt.setString(3, \"very_very_very_long_email_address_that_exceeds_database_column_limit_\" + \"x\".repeat(200) + \"@example.com\");\n                    } else {\n                        pstmt.setString(3, \"test\" + i + \"@example.com\");\n                    }\n                    \n                    pstmt.setBigDecimal(4, java.math.BigDecimal.valueOf(70 + Math.random() * 30));\n                    pstmt.addBatch();\n                }\n                \n                try {\n                    int[] results = pstmt.executeBatch();\n                    conn.commit();\n                    \n                    System.out.println(\"æ‰¹é‡æ’å…¥æˆåŠŸï¼Œç»“æœ: \" + java.util.Arrays.toString(results));\n                    \n                } catch (BatchUpdateException e) {\n                    System.err.println(\"âŒ æ‰¹é‡æ“ä½œä¸­å‘ç”Ÿé”™è¯¯: \" + e.getMessage());\n                    System.err.println(\"é”™è¯¯ä»£ç : \" + e.getErrorCode());\n                    System.err.println(\"SQLçŠ¶æ€: \" + e.getSQLState());\n                    \n                    // è·å–éƒ¨åˆ†æˆåŠŸçš„ç»“æœ\n                    int[] updateCounts = e.getUpdateCounts();\n                    System.out.println(\"éƒ¨åˆ†æ‰§è¡Œç»“æœ: \" + java.util.Arrays.toString(updateCounts));\n                    \n                    // å›æ»šäº‹åŠ¡\n                    conn.rollback();\n                    System.out.println(\"âš ï¸ äº‹åŠ¡å·²å›æ»š\");\n                    \n                    // é‡æ–°æ‰§è¡Œï¼Œè·³è¿‡é”™è¯¯è®°å½•\n                    retryBatchWithErrorSkip(conn, pstmt);\n                }\n            }\n            \n        } finally {\n            if (conn != null) {\n                conn.setAutoCommit(true);\n                conn.close();\n            }\n        }\n    }\n    \n    /**\n     * è·³è¿‡é”™è¯¯è®°å½•é‡æ–°æ‰§è¡Œæ‰¹é‡æ“ä½œ\n     */\n    private static void retryBatchWithErrorSkip(Connection conn, PreparedStatement pstmt) throws SQLException {\n        System.out.println(\"ğŸ”„ è·³è¿‡é”™è¯¯è®°å½•é‡æ–°æ‰§è¡Œ...\");\n        \n        pstmt.clearBatch();\n        \n        // é‡æ–°æ·»åŠ æ­£ç¡®çš„æ•°æ®ï¼ˆè·³è¿‡ç¬¬50æ¡ï¼‰\n        for (int i = 1; i <= 100; i++) {\n            if (i == 50) {\n                continue; // è·³è¿‡ä¼šå‡ºé”™çš„è®°å½•\n            }\n            \n            pstmt.setInt(1, 90000 + i);\n            pstmt.setString(2, \"æµ‹è¯•ç”¨æˆ·\" + i);\n            pstmt.setString(3, \"test\" + i + \"@example.com\");\n            pstmt.setBigDecimal(4, java.math.BigDecimal.valueOf(70 + Math.random() * 30));\n            pstmt.addBatch();\n        }\n        \n        try {\n            int[] results = pstmt.executeBatch();\n            conn.commit();\n            \n            System.out.printf(\"âœ… é‡æ–°æ‰§è¡ŒæˆåŠŸï¼Œæ’å…¥ %d æ¡è®°å½•\\n\", results.length);\n            \n        } catch (SQLException e) {\n            conn.rollback();\n            System.err.println(\"âŒ é‡æ–°æ‰§è¡Œä»ç„¶å¤±è´¥: \" + e.getMessage());\n        }\n    }\n    \n    // è¾…åŠ©æ–¹æ³•\n    \n    private static void clearTable(String tableName) throws SQLException {\n        try (Connection conn = dataSource.getConnection();\n             Statement stmt = conn.createStatement()) {\n            stmt.executeUpdate(\"DELETE FROM \" + tableName);\n        }\n    }\n    \n    private static int getTableRowCount(String tableName) throws SQLException {\n        try (Connection conn = dataSource.getConnection();\n             PreparedStatement pstmt = conn.prepareStatement(\"SELECT COUNT(*) FROM \" + tableName);\n             ResultSet rs = pstmt.executeQuery()) {\n            \n            if (rs.next()) {\n                return rs.getInt(1);\n            }\n            return 0;\n        }\n    }\n    \n    /**\n     * æ‰¹é‡æ“ä½œä¼˜åŒ–å»ºè®®\n     */\n    public static void printBatchOptimizationTips() {\n        System.out.println(\"\\nğŸ’¡ æ‰¹é‡æ“ä½œä¼˜åŒ–å»ºè®®:\");\n        \n        System.out.println(\"\\n1. æ‰¹é‡å¤§å°é€‰æ‹©:\");\n        System.out.println(\"   â€¢ ä¸€èˆ¬æ¨è1000-5000æ¡è®°å½•ä¸ºä¸€æ‰¹\");\n        System.out.println(\"   â€¢ è¿‡å¤§å¯èƒ½å¯¼è‡´å†…å­˜é—®é¢˜å’Œé”ç­‰å¾…\");\n        System.out.println(\"   â€¢ è¿‡å°æ— æ³•å‘æŒ¥æ‰¹é‡ä¼˜åŠ¿\");\n        \n        System.out.println(\"\\n2. äº‹åŠ¡æ§åˆ¶:\");\n        System.out.println(\"   â€¢ ä½¿ç”¨æ‰‹åŠ¨äº‹åŠ¡æ§åˆ¶æäº¤æ—¶æœº\");\n        System.out.println(\"   â€¢ åˆ†æ‰¹æäº¤é¿å…é•¿äº‹åŠ¡\");\n        System.out.println(\"   â€¢ åˆç†ä½¿ç”¨Savepointè¿›è¡Œéƒ¨åˆ†å›æ»š\");\n        \n        System.out.println(\"\\n3. æ€§èƒ½ä¼˜åŒ–:\");\n        System.out.println(\"   â€¢ ä½¿ç”¨PreparedStatementé‡ç”¨æ‰§è¡Œè®¡åˆ’\");\n        System.out.println(\"   â€¢ å…³é—­è‡ªåŠ¨æäº¤æé«˜æ€§èƒ½\");\n        System.out.println(\"   â€¢ è€ƒè™‘æš‚æ—¶ç¦ç”¨ç´¢å¼•ï¼ˆå¤§æ‰¹é‡æ’å…¥æ—¶ï¼‰\");\n        System.out.println(\"   â€¢ ä½¿ç”¨å¤šå€¼INSERTè¯­å¥\");\n        \n        System.out.println(\"\\n4. é”™è¯¯å¤„ç†:\");\n        System.out.println(\"   â€¢ ä½¿ç”¨BatchUpdateExceptionå¤„ç†éƒ¨åˆ†å¤±è´¥\");\n        System.out.println(\"   â€¢ å®ç°é‡è¯•æœºåˆ¶\");\n        System.out.println(\"   â€¢ è®°å½•å¤±è´¥çš„è®°å½•ç”¨äºåç»­å¤„ç†\");\n        \n        System.out.println(\"\\n5. ç›‘æ§å’Œè°ƒè¯•:\");\n        System.out.println(\"   â€¢ ç›‘æ§æ‰¹é‡æ“ä½œçš„æ‰§è¡Œæ—¶é—´\");\n        System.out.println(\"   â€¢ è®°å½•æ“ä½œæ—¥å¿—ä¾¿äºé—®é¢˜æ’æŸ¥\");\n        System.out.println(\"   â€¢ å®šæœŸæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§\");\n    }\n}