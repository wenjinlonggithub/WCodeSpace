# 系统设计与架构能力

## 分布式系统设计

### 微服务架构
*微服务就像把一个大公司拆分成多个小分公司，各自独立运营但协同工作*

- **服务拆分策略**
  > 服务拆分就像切蛋糕，切得好大家都有份，切得不好就是一地糟心事
  - **按业务领域拆分**：就像按部门分公司，销售归销售，技术归技术，各司其职不打架
  - **按数据模型拆分**：按数据库表分家，用户信息一家，订单信息一家，避免抢数据
  - **按团队结构拆分**：康威定律的实践，几个人的团队就管几个服务，别贪多
  - **服务边界定义与演进**：边界就像国境线，刚开始可能模糊，但要逐步清晰化

- **服务治理**
  > 服务治理就像小区物业管理，要管好每家每户
  - **服务发现与注册**：就像小区门牌号，新住户搬来要登记，搬走要注销
  - **配置管理中心**：像小区公告栏，重要通知统一发布，住户及时获取信息
  - **服务健康检查**：像定期查水表，检查各家各户是否正常运转
  - **服务版本管理**：像房屋装修管理，升级改造要有序进行，不能影响邻居

- **分布式事务**
  > 分布式事务就像多人AA制聚餐付款，要么大家都付钱，要么都不付
  - **两阶段提交(2PC)**：像群主统一收钱，先问大家准备好了吗，都说好再一起转账
  - **TCC补偿模式**：Try-Confirm-Cancel，像网购下单、付款、确认收货的流程
  - **Saga事务模式**：像多步骤任务，每步都可以撤销，出错就一步步回退
  - **事务消息机制**：像银行转账短信，操作完成后发消息通知，保证最终一致

### 高可用架构设计
*高可用就像造不沉的泰坦尼克号，要考虑各种极端情况*

- **容错与恢复**
  > 容错设计就像给系统买保险，出了事能快速理赔恢复
  - **故障隔离设计**：像船舱的防水隔板，一个舱进水不影响整艘船
  - **自动故障转移**：像备用司机，主司机出问题立马有人顶上
  - **数据备份与恢复**：像重要文件多备几份，丢了还能找回来
  - **灾备中心建设**：像异地备份，北京机房挂了上海顶上

- **负载均衡**
  > 负载均衡就像银行排队叫号，让每个窗口都不闲着也不累死
  - **算法选择（轮询、权重、最少连接）**：轮询像挨个排队，权重像VIP优先，最少连接像找最快的窗口
  - **四层与七层负载均衡**：四层看IP端口像看身份证，七层看HTTP内容像验证具体业务
  - **健康检查机制**：像定期检查窗口是否正常营业，有问题就暂停分配
  - **会话保持策略**：像银行VIP客户指定专门的理财经理，保持服务连续性

- **缓存架构**
  > 缓存就像记忆系统，常用的信息放在脑子里，不常用的才去翻书
  - **多级缓存设计**：像图书馆的借书系统，常用书放书桌上，偶尔用的放书架，很少用的放仓库
  - **缓存穿透/击穿/雪崩防护**：穿透像询问不存在的书，击穿像热门书突然下架，雪崩像图书馆系统崩溃
  - **缓存一致性策略**：像保证书桌上的书和仓库里的书是同一版本，不能出现内容不一致
  - **分布式缓存集群**：像多个图书馆联网共享书籍信息，这边没有那边可能有

## 性能优化与扩展

### 数据库架构
*数据库优化就像城市交通规划，要考虑高峰期和平时的不同需求*

- **读写分离**
  > 读写分离就像图书馆分区管理，看书区和办证区分开，互不干扰
  - **主从复制配置**：主库像原版图书，从库像复印件，保持内容同步
  - **读写路由策略**：写操作找主库，读操作找从库，像不同业务找不同窗口
  - **数据一致性保证**：确保复印件和原版内容一致，延迟不能太久
  - **故障切换机制**：主库挂了从库要能顶上，像备用钥匙的概念

- **分库分表**
  > 分库分表就像大超市分区管理，生鲜区、服装区、电器区各管各的
  - **水平分片策略**：像按用户ID分组，1-1000万用户一个库，1000万-2000万另一个库
  - **垂直分片策略**：像按业务模块分，用户信息一个库，订单信息一个库
  - **跨分片查询解决方案**：像跨区域查找商品，需要汇总各区域的结果
  - **数据迁移方案**：像超市重新布局，要保证营业不中断还要完成货架调整

- **数据库调优**
  > 数据库调优就像图书馆管理优化，让读者更快找到想要的书
  - **索引设计优化**：像给书做目录和标签，常用的书建详细索引，冷门书简单标记
  - **SQL性能调优**：像优化查找路径，别绕远路，直奔主题
  - **连接池配置**：像控制同时进图书馆的人数，太多会拥挤，太少浪费资源
  - **慢查询分析**：像找出总是迷路的读者，看看是路标不清楚还是书架布局有问题

### 消息队列设计
*消息队列就像邮政系统，负责在不同系统间传递信息*

- **消息模型**
  > 不同的消息模式适用于不同的沟通场景
  - **点对点模式**：像私人邮件，一对一发送，收到就删除
  - **发布订阅模式**：像订阅报纸，发布者广播，订阅者按需接收
  - **请求响应模式**：像发邮件求回复，有来有往的对话模式
  - **消息路由策略**：像邮局分拣，按地址、类型、优先级决定走哪条路线

- **可靠性保证**
  > 消息可靠性就像快递保证，要确保不丢件不损忕
  - **消息持久化**：像寄存快递，先放在仓库再逐个送达
  - **确认机制(ACK)**：像签收回执，收到了才算送达成功
  - **重试机制**：像快递员没人接收会再来一次，但不能无限重试
  - **死信队列处理**：像无法投递的邮件退回寄件人或送到特殊处理点

- **性能优化**
  > 消息性能优化就像提高快递效率，既要快也要稳
  - **批量处理**：像集包裹发货，一车连送多件比一件一车效率高
  - **消息压缩**：像打包压缩，减少存储和传输开销
  - **分区策略**：像快递分区配送，同一区域的一起送
  - **消费者负载均衡**：像多个快递员平均分配任务，避免某人累死某人闲着

## 安全架构设计

### 身份认证与授权
*安全架构就像银行安保系统，一环套一环保证财产安全*

- **认证机制**
  > 认证就像验身份，要证明你就是你
  - **JWT Token设计**：像可信任的身份证，上面写着详细信息，可以离线验证
  - **OAuth 2.0实现**：像第三方担保，用微信/支付宝登录其他应用
  - **SSO单点登录**：像一张卡刷遍整个园区，登录一次全站可用
  - **多因子认证**：像银行双重验证，密码+验证码+手机短信

- **权限控制**
  > 权限控制就像公司门禁卡系统，不同级别访问不同区域
  - **RBAC权限模型**：按角色分权限，经理、员工、访客不同权限
  - **ABAC属性权限**：按属性动态授权，时间、地点、设备都影响权限
  - **细粒度权限控制**：像按钮级别的权限管理，精确到每个操作
  - **权限缓存策略**：像门禁卡信息缓存，不用每次都查数据库

### 数据安全
*数据安全就像保险箱，里外都要防护周全*

- **数据加密**
  > 加密就像写密码信，即使被截获也看不懂内容
  - **传输加密(TLS/SSL)**：像用保密信封寄信，中途被截也看不到内容
  - **存储加密**：像把重要文件放进保险箱，只有密码才能打开
  - **敏感数据脱敏**：像给身份证号码打马赛克，保留部分信息但隐藏隐私
  - **密钥管理**：像银行保险库钥匙管理，密钥安全比数据安全更重要

- **API安全**
  > API安全就像门卫安检，不仅要验证身份，还要检查随身物品
  - **接口签名验证**：像防伪签名，确认请求没有被篡改
  - **频率限制**：像限制入场人数，防止恶意刚铰系统
  - **参数校验**：像安检不能带危险品，严格检查输入参数
  - **SQL注入防护**：像防止马路大侠，不能让恶意代码湖入系统

## 监控与运维

### 系统监控
*系统监控就像医院监护室，时刻关注病人的生命体征*

- **指标监控**
  > 监控指标就像体检报告，各项指标都要在正常范围内
  - **CPU、内存、磁盘、网络**：像监测血压、心率、体温的综合指标
  - **JVM监控指标**：像专项检查，重点监测Java应用的健康状况
  - **数据库性能指标**：像监测核心器官功能，数据库是系统的“心脏”
  - **中间件监控**：像监测各个器官的协调情况，保证系统各组件正常协作

- **日志管理**
  > 日志管理就像医疗病历，详细记录病情变化以便诊断
  - **结构化日志设计**：像标准化病历格式，方便计算机解读分析
  - **日志收集与聚合**：像医疗集团汇总病历，集中管理所有诊断信息
  - **日志分析与检索**：像医生查看病历找病因，快速定位问题
  - **日志归档策略**：像病历存档管理，老旧记录定期清理或压缩存储

### 链路追踪
*链路追踪就像跟踪快递，从发货到收货的全程追踪*

- **分布式追踪**
  > 在微服务架构中，调用链路复杂得像迷宫，需要GPS导航
  - **TraceID生成策略**：像快递单号，统一标识一次完整的请求调用
  - **Span设计与采样**：像GPS轨迹点，记录每个关键节点的时间和状态
  - **调用链分析**：像查看快递运输路线，分析各个环节的时间成本
  - **性能瓶颈定位**：像找出交通堵塞点，定位哪个服务拖了后腿

- **错误监控**
  > 错误监控就像医院的紧急呼叫系统，及时发现并处理突发情况
  - **异常收集与聚合**：像收集所有病例报告，统一分类管理
  - **错误率监控**：像监控治疗成功率，及时发现不正常趋势
  - **告警通知机制**：像紧急情况呼叫医生，问题严重时立即通知
  - **根因分析工具**：像病理分析工具，深入挖掘问题的根本原因